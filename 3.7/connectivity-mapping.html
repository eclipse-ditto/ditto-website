<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="">
<meta name="keywords" content="connectivity,  mapping, transformation, payload, javascript, mapper, protobuf">
<title>  Payload mapping in connectivity service • Eclipse Ditto™ • a digital twin framework</title>

<link rel="stylesheet" href="css/syntax.css">
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" crossorigin="anonymous">
<link rel="stylesheet" href="css/modern-business.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" crossorigin="anonymous">
<link rel="stylesheet" href="css/customstyles.css">
<link rel="stylesheet" href="css/boxshadowproperties.css">
<link rel="stylesheet" href="css/theme-ditto.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,700|Source+Code+Pro:300,600|Titillium+Web:400,600,700">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/2.1.0/anchor.min.js" crossorigin="anonymous"></script>
<script src="js/toc.js"></script>
<script src="js/customscripts.js"></script>

<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Organization",
  "url": "https://www.eclipse.dev/ditto/",
  "logo": "https://www.eclipse.dev/ditto/images/ditto.svg"
}
</script>

<link rel="icon" type="image/png" href="images/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="images/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="images/favicon-96x96.png" sizes="96x96">

<link rel="alternate" type="application/rss+xml" title="Eclipse Ditto Blog" href="https://www.eclipse.dev/ditto/feed.xml">

<!-- Eclipse Foundation cookie consent: -->
<link rel="stylesheet" type="text/css" href="https://www.eclipse.org/eclipse.org-common/themes/solstice/public/stylesheets/vendor/cookieconsent/cookieconsent.min.css" />
<script src="https://www.eclipse.org/eclipse.org-common/themes/solstice/public/javascript/vendor/cookieconsent/default.min.js"></script>

    <script>
        $(document).ready(function() {
            $("#tg-sb-link").click(function() {
                $("#tg-sb-sidebar").toggle();
                $("#tg-sb-content").toggleClass('col-md-9');
                $("#tg-sb-content").toggleClass('col-md-12');
                $("#tg-sb-icon").toggleClass('fa-toggle-on');
                $("#tg-sb-icon").toggleClass('fa-toggle-off');
            });
        });
    </script>
</head>


<script>
    (function(w,d,s,l,i){
        w[l]=w[l]||[];
        w[l].push({'gtm.start':
            new Date().getTime(),event:'gtm.js'});
        var f=d.getElementsByTagName(s)[0],
            j=d.createElement(s),
            dl=l!='dataLayer'?'&l='+l:'';
        j.async=true;
        j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;
        f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-5WLCZXC');
</script>



<body>
<!-- Navigation -->
<nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container topnavlinks">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-ditto-home" href="index.html">&nbsp;<img src="images/ditto_allwhite_symbolonly.svg" class="ditto-navbar-symbol" alt="Home"> <img src="images/ditto_allwhite_textonly.svg" class="ditto-navbar-symbol-text" alt="Eclipse Ditto™"></a>
        </div>
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <!-- toggle sidebar button -->
                <!--<li><a id="tg-sb-link" href="#"><i id="tg-sb-icon" class="fa fa-toggle-on"></i> Nav</a></li>-->
                <!-- entries without drop-downs appear here -->




                
                
                
                <li><a href="blog.html">Blog</a></li>
                
                
                
                <li><a href="intro-overview.html">Documentation</a></li>
                
                
                
                <li><a href="http-api-doc.html">HTTP API</a></li>
                
                
                
                <li><a href="sandbox.html">Sandbox</a></li>
                
                
                
                  
                  <li><a href="https://github.com/eclipse-ditto/ditto" target="_blank">
                    <img src="images/GitHub-Mark-Light-32px.png" alt="Sources at GitHub">
                  </a></li>
                  
                
                
                
                  
                  <li><a href="https://github.com/eclipse-ditto/ditto-clients" target="_blank">
                    <img src="images/GitHub-Mark-Light-32px.png" alt="SDK sources at GitHub">SDKs
                  </a></li>
                  
                
                
                
                  
                  <li><a href="https://github.com/eclipse-ditto/ditto-examples" target="_blank">
                    <img src="images/GitHub-Mark-Light-32px.png" alt="Example sources at GitHub">examples
                  </a></li>
                  
                
                
                
                <!-- entries with drop-downs appear here -->
                <!-- conditional logic to control which topnav appears for the audience defined in the configuration file.-->
                
                
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Links<b class="caret"></b></a>
                    <ul class="dropdown-menu">
                        
                        
                        <li><a href="https://projects.eclipse.org/projects/iot.ditto" target="_blank">Eclipse Ditto Project</a></li>
                        
                        
                        
                        <li><a href="https://www.eclipse.org/forums/index.php/f/364/" target="_blank">Forum</a></li>
                        
                        
                        
                        <li><a href="https://ci.eclipse.org/ditto/" target="_blank">Jenkins</a></li>
                        
                        
                        
                        <li><a href="https://dev.eclipse.org/mhonarc/lists/ditto-dev/" target="_blank">Mailing list archives</a></li>
                        
                        
                        
                        <li><a href="https://gitter.im/eclipse/ditto" target="_blank">Gitter.im chat</a></li>
                        
                        
                    </ul>
                </li>
                
                
                
                <!--comment out this block if you want to hide search-->
                <li>
                    <!--start search-->
                    <div id="search-demo-container">
                        <input type="text" id="search-input" placeholder="search...">
                        <ul id="results-container"></ul>
                    </div>
                    <script src="https://cdnjs.cloudflare.com/ajax/libs/simple-jekyll-search/0.0.9/jekyll-search.js" type="text/javascript"></script>
                    <script type="text/javascript">
                            SimpleJekyllSearch.init({
                                searchInput: document.getElementById('search-input'),
                                resultsContainer: document.getElementById('results-container'),
                                dataSource: 'search.json',
                                searchResultTemplate: '<li><a href="{url}" title="Payload mapping in connectivity service">{title}</a></li>',
                                noResultsText: 'No results found.',
                                limit: 10,
                                fuzzy: true,
                    })
                    </script>
                    <!--end search-->
                </li>
            </ul>
        </div>
    </div>
    <!-- /.container -->
</nav>

<!-- Page Content -->
<div class="container">
  <div id="main">
    <!-- Content Row -->
    <div class="row">
        
        
            <!-- Sidebar Column -->
            <div class="col-md-3" id="tg-sb-sidebar">
                

<ul id="mysidebar" class="nav">
  <li class="sidebarTitle">
    <label for="docVersion">Eclipse Ditto™ version:</label>
    <div class="select-wrapper">
      <select id="docVersion" name="docVersion">
        
        <option value="">development</option>
        
        <option value="3.7">3.7</option>
        
        <option value="3.6">3.6</option>
        
        <option value="3.5">3.5</option>
        
        <option value="3.4">3.4</option>
        
        <option value="3.3">3.3</option>
        
        <option value="3.2">3.2</option>
        
        <option value="3.1">3.1</option>
        
        <option value="3.0">3.0</option>
        
        <option value="2.4">2.4</option>
        
      </select>
    </div>
    <div id="dev-warning">
      <div markdown="span" class="alert alert-warning" role="alert" style="font-size:0.6em"><i class="fa fa-warning"></i> <b>Important:</b> This documentation reflects the latest 'development'. You might want to choose a released version.</div>
    </div>
  </li>
  
  
  
    
        <li class="subfolders">
          <a href="#"><span></span>Introduction</a>
          <ul>
              
              
              
              <li><a href="intro-overview.html">Overview</a></li>
              
              
              
              
              
              
              <li><a href="intro-digitaltwins.html">Digital twins</a></li>
              
              
              
              
              
              
              <li><a href="intro-hello-world.html">Hello world</a></li>
              
              
              
              
          </ul>
        </li>
    
  
  
  
    
        <li class="subfolders">
          <a href="#"><span></span>Release Notes</a>
          <ul>
              
              
              
              <li><a href="release_notes_370.html">3.7.0</a></li>
              
              
              
              
              
              
              <li><a href="release_notes_3611.html">3.6.11</a></li>
              
              
              
              
              
              
              <li><a href="release_notes_3610.html">3.6.10</a></li>
              
              
              
              
              
              
              <li><a href="release_notes_369.html">3.6.9</a></li>
              
              
              
              
              
              
              <li><a href="release_notes_368.html">3.6.8</a></li>
              
              
              
              
              
              
              <li><a href="release_notes_367.html">3.6.7</a></li>
              
              
              
              
              
              
              <li><a href="release_notes_365.html">3.6.5</a></li>
              
              
              
              
              
              
              <li><a href="release_notes_364.html">3.6.4</a></li>
              
              
              
              
              
              
              <li><a href="release_notes_363.html">3.6.3</a></li>
              
              
              
              
              
              
              <li><a href="release_notes_362.html">3.6.2</a></li>
              
              
              
              
              
              
              <li><a href="release_notes_361.html">3.6.1</a></li>
              
              
              
              
              
              
              <li><a href="release_notes_360.html">3.6.0</a></li>
              
              
              
              <li class="subfolders">
                  <a href="#"><span></span>Archive</a>
                  <ul>
                      
                      
                      
                      <li><a href="release_notes_3512.html">3.5.12</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_3511.html">3.5.11</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_3510.html">3.5.10</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_359.html">3.5.9</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_358.html">3.5.8</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_357.html">3.5.7</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_356.html">3.5.6</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_355.html">3.5.5</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_354.html">3.5.4</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_353.html">3.5.3</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_352.html">3.5.2</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_351.html">3.5.1</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_350.html">3.5.0</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_345.html">3.4.5</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_344.html">3.4.4</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_343.html">3.4.3</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_342.html">3.4.2</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_341.html">3.4.1</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_340.html">3.4.0</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_337.html">3.3.7</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_336.html">3.3.6</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_335.html">3.3.5</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_334.html">3.3.4</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_333.html">3.3.3</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_332.html">3.3.2</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_330.html">3.3.0</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_321.html">3.2.1</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_320.html">3.2.0</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_312.html">3.1.2</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_311.html">3.1.1</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_310.html">3.1.0</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_300.html">3.0.0</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_242.html">2.4.2</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_241.html">2.4.1</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_240.html">2.4.0</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_232.html">2.3.2</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_231.html">2.3.1</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_230.html">2.3.0</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_222.html">2.2.2</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_221.html">2.2.1</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_220.html">2.2.0</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_213.html">2.1.3</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_212.html">2.1.2</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_211.html">2.1.1</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_210.html">2.1.0</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_201.html">2.0.1</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_200.html">2.0.0</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_151.html">1.5.1</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_150.html">1.5.0</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_140.html">1.4.0</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_130.html">1.3.0</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_121.html">1.2.1</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_120.html">1.2.0</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_115.html">1.1.5</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_113.html">1.1.3</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_112.html">1.1.2</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_111.html">1.1.1</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_110.html">1.1.0</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_100.html">1.0.0</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_090.html">0.9.0</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_080.html">0.8.0</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_100-M2.html">1.0.0-M2</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_100-M1a.html">1.0.0-M1a</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_090-M2.html">0.9.0-M2</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_090-M1.html">0.9.0-M1</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_080-M3.html">0.8.0-M3</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_080-M2.html">0.8.0-M2</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_080-M1.html">0.8.0-M1</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_030-M2.html">0.3.0-M2</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_030-M1.html">0.3.0-M1</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_020-M1.html">0.2.0-M1</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_010-M3.html">0.1.0-M3</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_010-M1.html">0.1.0-M1</a></li>
                      
                      
                      
                  </ul>
              </li>
              
              
              
              
          </ul>
        </li>
    
  
  
  
    
        <li class="subfolders">
          <a href="#"><span></span>Installation</a>
          <ul>
              
              
              
              <li><a href="installation-building.html">Building Ditto</a></li>
              
              
              
              
              
              
              <li><a href="installation-running.html">Running Ditto</a></li>
              
              
              
              
              
              
              <li><a href="installation-operating.html">Operating Ditto</a></li>
              
              
              
              
              
              
              <li><a href="installation-extending.html">Extending Ditto</a></li>
              
              
              
              
          </ul>
        </li>
    
  
  
  
    
        <li class="subfolders">
          <a href="#"><span></span>Basic concepts</a>
          <ul>
              
              
              
              <li><a href="basic-overview.html">Overview</a></li>
              
              
              
              <li class="subfolders">
                  <a href="#"><span></span>Model entities</a>
                  <ul>
                      
                      
                      
                      <li><a href="basic-thing.html">Thing</a></li>
                      
                      
                      
                      
                      
                      <li><a href="basic-feature.html">Feature</a></li>
                      
                      
                      
                      
                      
                      <li><a href="basic-policy.html">Policy</a></li>
                      
                      
                      
                      
                      
                      <li><a href="basic-namespaces-and-names.html">Namespaces and Names</a></li>
                      
                      
                      
                      
                      
                      <li><a href="basic-metadata.html">Thing Metadata</a></li>
                      
                      
                      
                      
                      
                      <li><a href="basic-errors.html">Errors</a></li>
                      
                      
                      
                  </ul>
              </li>
              
              
              
              
              
              
              <li><a href="basic-auth.html">Authentication and Authorization</a></li>
              
              
              
              <li class="subfolders">
                  <a href="#"><span></span>Checking Permissions for Resources</a>
                  <ul>
                      
                  </ul>
              </li>
              
              
              
              
              
              
              <li><a href="basic-messages.html">Messages</a></li>
              
              
              
              
              
              
              <li><a href="basic-signals.html">Signals</a></li>
              
              
              
              <li class="subfolders">
                  <a href="#"><span></span>Signal types</a>
                  <ul>
                      
                      
                      
                      <li><a href="basic-signals-command.html">Command</a></li>
                      
                      
                      
                      
                      
                      <li><a href="basic-signals-commandresponse.html">Command response</a></li>
                      
                      
                      
                      
                      
                      <li><a href="basic-signals-errorresponse.html">Error response</a></li>
                      
                      
                      
                      
                      
                      <li><a href="basic-signals-event.html">Event</a></li>
                      
                      
                      
                      
                      
                      <li><a href="basic-signals-announcement.html">Announcement</a></li>
                      
                      
                      
                      
                      
                      <li><a href="basic-enrichment.html">Signal enrichment</a></li>
                      
                      
                      
                  </ul>
              </li>
              
              
              
              
              
              
              <li><a href="basic-apis.html">APIs</a></li>
              
              
              
              
              
              
              <li><a href="basic-connections.html">Connections</a></li>
              
              
              
              
              
              
              <li><a href="basic-placeholders.html">Placeholders</a></li>
              
              
              
              
              
              
              <li><a href="basic-changenotifications.html">Change notifications</a></li>
              
              
              
              
              
              
              <li><a href="basic-rql.html">RQL expressions</a></li>
              
              
              
              
              
              
              <li><a href="basic-conditional-requests.html">Conditional requests</a></li>
              
              
              
              
              
              
              <li><a href="basic-search.html">Search</a></li>
              
              
              
              
              
              
              <li><a href="basic-history.html">History capabilities</a></li>
              
              
              
              
              
              
              <li><a href="basic-acknowledgements.html">Acknowledgements / QoS</a></li>
              
              
              
              <li class="subfolders">
                  <a href="#"><span></span>WoT (Web of Things)</a>
                  <ul>
                      
                      
                      
                      <li><a href="basic-wot-integration.html">WoT integration</a></li>
                      
                      
                      
                      
                      
                      <li><a href="basic-wot-integration-example.html">WoT integration example</a></li>
                      
                      
                      
                  </ul>
              </li>
              
              
              
              
          </ul>
        </li>
    
  
  
  
    
        <li class="subfolders">
          <a href="#"><span></span>Advanced concepts</a>
          <ul>
              
              
              
              <li><a href="advanced-data-by-pass.html">Data By-Pass</a></li>
              
              
              
              
          </ul>
        </li>
    
  
  
  
    
        <li class="subfolders">
          <a href="#"><span></span>Architecture</a>
          <ul>
              
              
              
              <li><a href="architecture-overview.html">Overview</a></li>
              
              
              
              <li class="subfolders">
                  <a href="#"><span></span>Services</a>
                  <ul>
                      
                      
                      
                      <li><a href="architecture-services-policies.html">Policies</a></li>
                      
                      
                      
                      
                      
                      <li><a href="architecture-services-things.html">Things</a></li>
                      
                      
                      
                      
                      
                      <li><a href="architecture-services-things-search.html">Things-Search</a></li>
                      
                      
                      
                      
                      
                      <li><a href="architecture-services-connectivity.html">Connectivity</a></li>
                      
                      
                      
                      
                      
                      <li><a href="architecture-services-gateway.html">Gateway</a></li>
                      
                      
                      
                  </ul>
              </li>
              
              
              
              
          </ul>
        </li>
    
  
  
  
    
        <li class="subfolders">
          <a href="#"><span></span>HTTP API</a>
          <ul>
              
              
              
              <li><a href="httpapi-overview.html">Overview</a></li>
              
              
              
              
              
              
              <li><a href="httpapi-concepts.html">Concepts</a></li>
              
              
              
              
              
              
              <li><a href="httpapi-search.html">Search</a></li>
              
              
              
              
              
              
              <li><a href="httpapi-messages.html">Messages</a></li>
              
              
              
              
              
              
              <li><a href="httpapi-protocol-bindings-websocket.html">WebSocket protocol binding</a></li>
              
              
              
              
              
              
              <li><a href="httpapi-protocol-bindings-cloudevents.html">Cloud Events HTTP protocol binding</a></li>
              
              
              
              
              
              
              <li><a href="httpapi-sse.html">Server sent events</a></li>
              
              
              
              
          </ul>
        </li>
    
  
  
  
    
        <li class="subfolders">
          <a href="#"><span></span>Connectivity API</a>
          <ul>
              
              
              
              <li><a href="connectivity-overview.html">Overview</a></li>
              
              
              
              <li class="subfolders">
                  <a href="#"><span></span>Manage connections</a>
                  <ul>
                      
                      
                      
                      <li><a href="connectivity-manage-connections.html">via HTTP API</a></li>
                      
                      
                      
                      
                      
                      <li><a href="connectivity-manage-connections-piggyback.html">via Piggyback commands</a></li>
                      
                      
                      
                  </ul>
              </li>
              
              
              
              
              
              
              <li><a href="connectivity-protocol-bindings-amqp091.html">AMQP 0.9.1 protocol binding</a></li>
              
              
              
              
              
              
              <li><a href="connectivity-protocol-bindings-amqp10.html">AMQP 1.0 protocol binding</a></li>
              
              
              
              
              
              
              <li><a href="connectivity-protocol-bindings-mqtt.html">MQTT 3.1.1 protocol binding</a></li>
              
              
              
              
              
              
              <li><a href="connectivity-protocol-bindings-mqtt5.html">MQTT 5 protocol binding</a></li>
              
              
              
              
              
              
              <li><a href="connectivity-protocol-bindings-http.html">HTTP 1.1 protocol binding</a></li>
              
              
              
              
              
              
              <li><a href="connectivity-protocol-bindings-kafka2.html">Kafka 2.x protocol binding</a></li>
              
              
              
              
              
              
              <li><a href="connectivity-protocol-bindings-hono.html">Hono connection binding</a></li>
              
              
              
              
              
              
              <li class="active"><a href="connectivity-mapping.html">Payload mapping</a></li>
              
              
              
              
              
              
              <li><a href="connectivity-header-mapping.html">Header mapping</a></li>
              
              
              
              
              
              
              <li><a href="connectivity-tls-certificates.html">TLS certificates</a></li>
              
              
              
              
              
              
              <li><a href="connectivity-ssh-tunneling.html">SSH tunneling</a></li>
              
              
              
              
              
              
              <li><a href="connectivity-hmac-signing.html">HMAC signing</a></li>
              
              
              
              
          </ul>
        </li>
    
  
  
  
    
        <li class="subfolders">
          <a href="#"><span></span>Client SDK</a>
          <ul>
              
              
              
              <li><a href="client-sdk-overview.html">Overview</a></li>
              
              
              
              
              
              
              <li><a href="client-sdk-java.html">Java</a></li>
              
              
              
              
              
              
              <li><a href="client-sdk-javascript.html">JavaScript</a></li>
              
              
              
              
          </ul>
        </li>
    
  
  
  
    
        <li class="subfolders">
          <a href="#"><span></span>Ditto Protocol</a>
          <ul>
              
              
              
              <li><a href="protocol-overview.html">Overview</a></li>
              
              
              
              
              
              
              <li><a href="protocol-twinlive.html">Twin/live channel</a></li>
              
              
              
              
              
              
              <li><a href="protocol-specification.html">Specification</a></li>
              
              
              
              
              
              
              <li><a href="protocol-specification-topic.html">Protocol topic</a></li>
              
              
              
              
              
              
              <li><a href="protocol-specification-errors.html">Errors</a></li>
              
              
              
              
              
              
              <li><a href="protocol-specification-things.html">Things group</a></li>
              
              
              
              <li class="subfolders">
                  <a href="#"><span></span>→ commands/events</a>
                  <ul>
                      
                      
                      
                      <li><a href="protocol-specification-things-create-or-modify.html">Create/Modify</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-specification-things-merge.html">Merge</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-specification-things-retrieve.html">Retrieve</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-specification-things-delete.html">Delete</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-specification-acks.html">Acknowledgements</a></li>
                      
                      
                      
                  </ul>
              </li>
              
              
              
              <li class="subfolders">
                  <a href="#"><span></span>→ search/messages</a>
                  <ul>
                      
                      
                      
                      <li><a href="protocol-specification-things-search.html">Search</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-specification-things-messages.html">Messages</a></li>
                      
                      
                      
                  </ul>
              </li>
              
              
              
              
              
              
              <li><a href="protocol-specification-policies.html">Policies group</a></li>
              
              
              
              <li class="subfolders">
                  <a href="#"><span></span>→ commands/announcements</a>
                  <ul>
                      
                      
                      
                      <li><a href="protocol-specification-policies-create-or-modify.html">Create/Modify</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-specification-policies-retrieve.html">Retrieve</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-specification-policies-delete.html">Delete</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-specification-policies-announcement.html">Announcement</a></li>
                      
                      
                      
                  </ul>
              </li>
              
              
              
              
              
              
              <li><a href="protocol-specification-connections.html">Connections group</a></li>
              
              
              
              <li class="subfolders">
                  <a href="#"><span></span>→ announcements</a>
                  <ul>
                      
                      
                      
                      <li><a href="protocol-specification-connections-announcement.html">Announcement</a></li>
                      
                      
                      
                  </ul>
              </li>
              
              
              
              
              
              
              <li><a href="protocol-specification-streaming-subscription.html">Streaming subscriptions (history)</a></li>
              
              
              
              
              
              
              <li><a href="protocol-bindings.html">Bindings</a></li>
              
              
              
              
              
              
              <li><a href="protocol-examples.html">Examples</a></li>
              
              
              
              <li class="subfolders">
                  <a href="#"><span></span>→ Things examples</a>
                  <ul>
                      
                      
                      
                      <li><a href="protocol-examples-creatething.html">Create a Thing</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-deletething.html">Delete a Thing</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-modifything.html">Modify a Thing</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-retrievething.html">Retrieve a Thing</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-retrievethings.html">Retrieve multiple Things</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-modifypolicyid.html">Modify the Policy ID of a Thing</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-createattributes.html">Create Attributes</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-deleteattributes.html">Delete Attributes</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-modifyattributes.html">Modify Attributes</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-retrieveattributes.html">Retrieve Attributes</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-createattribute.html">Create a single Attribute</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-deleteattribute.html">Delete a single Attribute</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-modifyattribute.html">Modify a single Attribute</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-retrieveattribute.html">Retrieve a single Attribute</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-createthingdefinition.html">Create a Definition</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-deletethingdefinition.html">Delete a Definition</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-modifythingdefinition.html">Modify a Definition</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-retrievethingdefinition.html">Retrieve a Definition</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-createfeatures.html">Create Features</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-deletefeatures.html">Delete Features</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-modifyfeatures.html">Modify Features</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-retrievefeatures.html">Retrieve Features</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-createfeature.html">Create a single Feature</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-deletefeature.html">Delete a single Feature</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-modifyfeature.html">Modify a single Feature</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-retrievefeature.html">Retrieve a single Feature</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-createdefinition.html">Create Feature Definition</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-deletedefinition.html">Delete Feature Definition</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-modifydefinition.html">Modify Feature Definition</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-retrievedefinition.html">Retrieve Feature Definition</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-createproperties.html">Create Feature Properties</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-deleteproperties.html">Delete Feature Properties</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-modifyproperties.html">Modify Feature Properties</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-retrieveproperties.html">Retrieve Feature Properties</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-createproperty.html">Create a single Property</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-deleteproperty.html">Delete a single Property</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-modifyproperty.html">Modify a single Property</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-retrieveproperty.html">Retrieve a single Property</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-createdesiredproperties.html">Create desired Feature Properties</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-deletedesiredproperties.html">Delete desired Feature Properties</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-modifydesiredproperties.html">Modify desired Feature Properties</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-retrievedesiredproperties.html">Retrieve desired Feature Properties</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-createdesiredproperty.html">Create a single desired Property</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-deletedesiredproperty.html">Delete a single desired Property</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-modifydesiredproperty.html">Modify a single desired Property</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-retrievedesiredproperty.html">Retrieve a single desired Property</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-errorresponses.html">Error responses</a></li>
                      
                      
                      
                  </ul>
              </li>
              
              
              
              <li class="subfolders">
                  <a href="#"><span></span>→ Things merge examples</a>
                  <ul>
                      
                      
                      
                      <li><a href="protocol-examples-mergething.html">Merge a Thing</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-mergepolicyid.html">Merge the Policy ID of a Thing</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-mergeattributes.html">Merge Attributes</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-mergeattribute.html">Merge a single Attribute</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-mergethingdefinition.html">Merge a Definition</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-mergefeatures.html">Merge Features</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-mergefeature.html">Merge a single Feature</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-mergefeaturedefinition.html">Merge Feature Definition</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-mergeproperties.html">Merge Feature Properties</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-mergeproperty.html">Merge a single Property</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-mergedesiredproperties.html">Merge desired Feature Properties</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-mergedesiredproperty.html">Merge a single desired Property</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-errorresponses.html">Error responses</a></li>
                      
                      
                      
                  </ul>
              </li>
              
              
              
              <li class="subfolders">
                  <a href="#"><span></span>→ Policies examples</a>
                  <ul>
                      
                      
                      
                      <li><a href="protocol-examples-policies-createpolicy.html">Create a Policy</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-policies-deletepolicy.html">Delete a Policy</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-policies-modifypolicy.html">Modify a Policy</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-policies-retrievepolicy.html">Retrieve a Policy</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-policies-modifypolicyentries.html">Modify entries</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-policies-retrievepolicyentries.html">Retrieve entries</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-policies-createpolicyentry.html">Create a single entry</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-policies-deletepolicyentry.html">Delete a single entry</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-policies-modifypolicyentry.html">Modify a single entry</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-policies-retrievepolicyentry.html">Retrieve a single entry</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-policies-modifysubjects.html">Modify subjects</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-policies-retrievesubjects.html">Retrieve subjects</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-policies-createsubject.html">Create a single subject</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-policies-deletesubject.html">Delete a single subject</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-policies-modifysubject.html">Modify a single subject</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-policies-retrievesubject.html">Retrieve a single subject</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-policies-modifyresources.html">Modify resources</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-policies-retrieveresources.html">Retrieve resources</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-policies-createresource.html">Create a single resource</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-policies-deleteresource.html">Delete a single resource</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-policies-modifyresource.html">Modify a single resource</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-policies-retrieveresource.html">Retrieve a single resource</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-policies-modifyimports.html">Modify policy imports</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-policies-retrieveimports.html">Retrieve policy imports</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-policies-deleteimport.html">Delete a single policy import</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-policies-modifyimport.html">Modify a single policy import</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-policies-retrieveimport.html">Retrieve a single policy import</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-policies-errorresponses.html">Error responses</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-policies-announcement-subjectDeletion.html">Announcement for subject deletion</a></li>
                      
                      
                      
                  </ul>
              </li>
              
              
              
              <li class="subfolders">
                  <a href="#"><span></span>→ Connections examples</a>
                  <ul>
                      
                      
                      
                      <li><a href="protocol-examples-connections-announcement-opened.html">Announcement for connection opened</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-connections-announcement-closed.html">Announcement for connection gracefully closed</a></li>
                      
                      
                      
                  </ul>
              </li>
              
              
              
              
              
              
              <li><a href="protocol-examples-search.html">→ Search examples</a></li>
              
              
              
              
          </ul>
        </li>
    
  
  
  
    
    <li><a href="user-interface.html">User Interface</a></li>
    
  
  
  
    
    <li><a href="sandbox.html">Sandbox</a></li>
    
  
  
  
    
    <li><a href="presentations.html">Presentations</a></li>
    
  
  
  
    
    <li><a href="glossary.html">Glossary</a></li>
    
  
  
  
    
    <li><a href="feedback.html">Feedback</a></li>
    
  
  
  
    
         <p class="external">
             <a href="#" id="collapseAll">Collapse All</a> | <a href="#" id="expandAll">Expand All</a>
         </p>
    
</ul>

<!-- this highlights the active parent class in the sidebar. this is critical so that the parent expands when you're viewing a page. This must appear below the sidebar code above. Otherwise, if placed inside customscripts.js, the script runs before the sidebar code runs and the class never gets inserted.-->
<script>$("li.active").parents('li').toggleClass("active");
</script>

            </div>
            
        

        <!-- Content Column -->
        <div class="col-md-9" id="tg-sb-content">
            <div class="post-header">
   <h1 class="post-title-main">Payload mapping in connectivity service</h1>
</div>



<div class="post-content">

   

    
    
<!-- this handles the automatic toc. use ## for subheads to auto-generate the on-page minitoc. if you use html tags, you must supply an ID for the heading element in order for it to appear in the minitoc. -->
<script>
$( document ).ready(function() {
  // Handler for .ready() called.

$('#toc').toc({ minimumHeaders: 0, listType: 'ul', showSpeed: 0, headers: 'h2,h3,h4' });

/* this offset helps account for the space taken up by the floating toolbar. */
$('#toc').on('click', 'a', function() {
  var target = $(this.getAttribute('href'))
    , scroll_target = target.offset().top

  $(window).scrollTop(scroll_target - 10);
  return false
})
  
});
</script>

<div id="toc"></div>

    


    
    

    <a target="_blank" href="https://github.com/eclipse/ditto/edit/master/documentation/src/main/resources/pages/ditto/connectivity-mapping.md" class="btn btn-default githubEditButton" role="button"><i class="fa fa-github fa-lg"></i> Edit this page</a>

    
    


    

  <div class="bs-callout bs-callout-primary"><strong>TL;DR</strong><br />The payload mapping feature in Ditto’s connectivity APIs can be used to 
    transform arbitrary payload consumed via the different supported protocols 
    to <a href="protocol-overview.html">Ditto Protocol</a> messages and vice versa.</div>

<h2 id="motivation">Motivation</h2>

<p>Eclipse Ditto is about providing access to IoT devices via the <a href="intro-digitaltwins.html">digital twin</a> pattern. 
In order to provide structured APIs for different heterogeneous devices Ditto defines a lightweight JSON based 
<a href="basic-overview.html">model</a>.</p>

<p>A <a href="basic-thing.html">Thing</a> might look like in the following example:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"thingId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"the.namespace:the-thing-id"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"policyId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"the.namespace:the-policy-id"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"location"</span><span class="p">:</span><span class="w"> </span><span class="s2">"kitchen"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"features"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"transmission"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
       </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
         </span><span class="nl">"cur_speed"</span><span class="p">:</span><span class="w"> </span><span class="mi">90</span><span class="w">
       </span><span class="p">}</span><span class="w">
     </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Devices in the IoT, may they be brownfield devices or newly produced devices, will probably not send their data to the
cloud in the structure and <a href="protocol-overview.html">protocol</a> Ditto requires.</p>

<p>They should not need to be aware of something like Ditto running in the cloud mirroring them as digital twins.</p>

<p>So for example device payload could look like this:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"val"</span><span class="p">:</span><span class="w"> </span><span class="s2">"23.42 °C"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"ts"</span><span class="p">:</span><span class="w"> </span><span class="mi">1523946112727</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>In case of constrained devices or IoT protocols, even binary payload might be common.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0x08BD (hex representation)
</code></pre></div></div>

<h2 id="builtin-mappers">Builtin mappers</h2>

<p>The following message mappers are included in the Ditto codebase:</p>

<table>
  <thead>
    <tr>
      <th>Mapper Alias</th>
      <th>Description</th>
      <th>Inbound</th>
      <th>Outbound</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><a href="#ditto-mapper">Ditto</a></td>
      <td>Assumes that inbound/outbound messages are already in <a href="protocol-overview.html">Ditto Protocol</a> (JSON) format.</td>
      <td>✓</td>
      <td>✓</td>
    </tr>
    <tr>
      <td><a href="#javascript-mapper">JavaScript</a></td>
      <td>Converts arbitrary messages from and to the <a href="protocol-overview.html">Ditto Protocol</a> format using <strong>custom</strong> JavaScript code executed by Ditto.</td>
      <td>✓</td>
      <td>✓</td>
    </tr>
    <tr>
      <td><a href="#normalized-mapper">Normalized</a></td>
      <td>Transforms the payload of events to a normalized view.</td>
      <td> </td>
      <td>✓</td>
    </tr>
    <tr>
      <td><a href="#connectionstatus-mapper">ConnectionStatus</a></td>
      <td>This mapper handles messages containing <code class="language-plaintext highlighter-rouge">creation-time</code> and <code class="language-plaintext highlighter-rouge">ttd</code> headers by updating a feature of the targeted thing with <a href="basic-feature.html#feature-definition">definition</a> <a href="https://github.com/eclipse/vorto/tree/development/models/org.eclipse.ditto-ConnectionStatus-1.0.0.fbmodel">ConnectionStatus</a>.</td>
      <td>✓</td>
      <td> </td>
    </tr>
    <tr>
      <td><a href="#rawmessage-mapper">RawMessage</a></td>
      <td>For outgoing message commands and responses, this mapper extracts the payload for publishing directly into the channel. For incoming messages, this mapper wraps them in a configured message command or response envelope.</td>
      <td>✓</td>
      <td>✓</td>
    </tr>
    <tr>
      <td><a href="#implicitthingcreation-mapper">ImplicitThingCreation</a></td>
      <td>This mapper handles messages for which a Thing should be created automatically based on a defined template.</td>
      <td>✓</td>
      <td> </td>
    </tr>
    <tr>
      <td><a href="#updatetwinwithliveresponse-mapper">UpdateTwinWithLiveResponse</a></td>
      <td>This mapper creates a <a href="protocol-specification-things-merge.html">merge Thing command</a> when an indiviudal <a href="protocol-specification-things-retrieve.html">retrieve command</a> for an single Thing was received via the <a href="protocol-twinlive.html#live">live channel</a> patching exactly the retrieved “live” data into the twin.</td>
      <td>✓</td>
      <td> </td>
    </tr>
    <tr>
      <td><a href="#cloudevents-mapper">CloudEvents Mapper</a></td>
      <td>The mapper maps incoming CloudEvent to Ditto Protocol. Supports both Binary and Structured CloudEvent.</td>
      <td>✓</td>
      <td>✓</td>
    </tr>
  </tbody>
</table>

<h3 id="ditto-mapper">Ditto mapper</h3>

<p>This is the default <a href="protocol-overview.html">Ditto Protocol</a> mapper. If you do not specify any payload mapping this
 mapper is used to map inbound and outbound messages. The mapper requires no mandatory options, so its alias can
 be directly used as a mapper reference.</p>

<p>It assumes that received messages are in <a href="protocol-specification.html">Ditto Protocol JSON</a> and emits outgoing messages
 also in that format.</p>

<h3 id="javascript-mapper">JavaScript mapper</h3>

<p>This mapper may be used whenever any inbound messages are not yet in <a href="protocol-overview.html">Ditto Protocol</a>. 
By using the built in <a href="#javascript-mapping-engine">JavaScript mapping engine</a> (based on Rhino) custom defined 
JavaScript scripts can be executed which are responsible for creating <a href="protocol-specification.html">Ditto Protocol JSON</a> 
message from arbitrary consumed payload.</p>

<p>The same is possible for outbound messages in order to transform <a href="protocol-specification.html">Ditto Protocol JSON</a> 
messages (e.g. events or responses) to arbitrary other formats.</p>

<h4 id="configuration-options">Configuration options</h4>

<ul>
  <li><code class="language-plaintext highlighter-rouge">incomingScript</code> (required): the mapping script for incoming messages</li>
  <li><code class="language-plaintext highlighter-rouge">outgoingScript</code> (required):  the mapping script for outgoing messages</li>
  <li><code class="language-plaintext highlighter-rouge">loadBytebufferJS</code> (optional, default: <code class="language-plaintext highlighter-rouge">"false"</code>): whether to load ByteBufferJS library</li>
  <li><code class="language-plaintext highlighter-rouge">loadLongJS</code> (optional, default: <code class="language-plaintext highlighter-rouge">"false"</code>): whether to load LongJS library</li>
</ul>

<h3 id="normalized-mapper">Normalized mapper</h3>

<p>This mapper transforms <code class="language-plaintext highlighter-rouge">created</code> and <code class="language-plaintext highlighter-rouge">modified</code> events (other type of messages are dropped) to a normalized view. 
Events are mapped to a nested sparse JSON.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"topic"</span><span class="p">:</span><span class="w"> </span><span class="s2">"thing/id/things/twin/events/modified"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"headers"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"content-type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"application/json"</span><span class="w"> </span><span class="p">},</span><span class="w">
  </span><span class="nl">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/features/sensors/properties/temperature/indoor/value"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mi">42</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>would result in the following normalized JSON representation:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"thingId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"thing:id"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"features"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"sensors"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"temperature"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"indoor"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mi">42</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"_context"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"topic"</span><span class="p">:</span><span class="w"> </span><span class="s2">"thing/id/things/twin/events/modified"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/features/sensors/properties/temperature/indoor/value"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mi">42</span><span class="p">,</span><span class="w">
    </span><span class="nl">"headers"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"content-type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"application/json"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<p>The <code class="language-plaintext highlighter-rouge">_context</code> field contains the original message content excluding the <code class="language-plaintext highlighter-rouge">value</code>.</p>

<h4 id="configuration-options-1">Configuration options</h4>

<ul>
  <li><code class="language-plaintext highlighter-rouge">fields</code> (optional, default: all fields): comma separated list of fields that are contained in the result (see also
 chapter about <a href="httpapi-concepts.html#with-field-selector">field selectors</a>)</li>
</ul>

<h3 id="connectionstatus-mapper">ConnectionStatus mapper</h3>
<p>This mapper transforms the information from the <code class="language-plaintext highlighter-rouge">ttd</code> and <code class="language-plaintext highlighter-rouge">creation-time</code> message headers 
(see Eclipse Hono <a href="https://www.eclipse.org/hono/docs/concepts/device-notifications/">device notifications</a>) into a 
ModifyFeature command that complies with the <a href="https://github.com/eclipse/vorto/tree/development/models/org.eclipse.ditto-ConnectionStatus-1.0.0.fbmodel">Vorto functionblock</a> <code class="language-plaintext highlighter-rouge">org.eclipse.ditto:ConnectionStatus</code>.</p>

<p>The connectivity state of the device is then represented in a Feature.<br />
It is mostly used in conjunction with another mapper that transforms the payload e.g.:<br />
<code class="language-plaintext highlighter-rouge">"payloadMapping": [ "Ditto" , "connectionStatus" ]</code></p>

<p>Example of a resulting <code class="language-plaintext highlighter-rouge">ConnectionStatus</code> feature:</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"thingId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"eclipse:ditto"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"features"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"ConnectionStatus"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"definition"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">"org.eclipse.ditto:ConnectionStatus:1.0.0"</span><span class="w"> </span><span class="p">],</span><span class="w">
      </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"readySince"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2019-10-29T14:16:18Z"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"readyUntil"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2019-10-29T14:21:18Z"</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h4 id="configuration-options-2">Configuration options</h4>

<ul>
  <li><code class="language-plaintext highlighter-rouge">thingId</code> (required): The ID of the Thing that is updated with the connectivity state. It can either be a fixed value
 or a header placeholder (e.g. <code class="language-plaintext highlighter-rouge">{{ header:device_id }}</code>).</li>
  <li><code class="language-plaintext highlighter-rouge">featureId</code> (optional, default: <code class="language-plaintext highlighter-rouge">ConnectionStatus</code>): The ID of the Feature that is updated. It can either be a
 fixed value or resolved from a message header (e.g. <code class="language-plaintext highlighter-rouge">{{ header:feature_id }}</code>).</li>
</ul>

<h3 id="rawmessage-mapper">RawMessage mapper</h3>

<p>This mapper relates the payload in the <code class="language-plaintext highlighter-rouge">"value"</code> field of message commands and message responses to the payload
of AMQP, MQTT and Kafka messages and the body of HTTP requests. The encoding of the payload is chosen according to
the configured content type. The subject, direction, thing ID and feature ID of the envelope for incoming message
commands and responses need to be configured.</p>

<p>Messages with the Ditto protocol content type <code class="language-plaintext highlighter-rouge">application/vnd.eclipse.ditto+json</code> or signals that are not message
commands or responses are mapped by the <a href="#ditto-mapper">Ditto mapper</a> instead.</p>

<p>For example, the mapper maps between the feature message command response</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"topic"</span><span class="p">:</span><span class="w"> </span><span class="s2">"org.eclipse.ditto/smartcoffee/things/live/messages/heatUp"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"headers"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"content-type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"application/octet-stream"</span><span class="w"> </span><span class="p">},</span><span class="w">
  </span><span class="nl">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/features/water-tank/inbox/messages/heatUp"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="s2">"AQIDBAUG"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">200</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<p>and an AMQP, MQTT 5, Kafka message with payload or an HTTP request with body of 6 bytes</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0x01 02 03 04 05 06
</code></pre></div></div>
<p>and headers</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>content-type: application/octet-stream
status: 200
ditto-message-subject: heatUp
ditto-message-direction: TO
ditto-message-thing-id: org.eclipse.ditto:smartcoffee
ditto-message-feature-id: water-tank
</code></pre></div></div>
<p>The headers are lost for connection protocols without application headers such as MQTT 3.</p>

<h4 id="configuration-options-3">Configuration options</h4>

<p>Example configuration:</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"outgoingContentType"</span><span class="p">:</span><span class="w"> </span><span class="s2">"application/octet-stream"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"incomingMessageHeaders"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"content-type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"{{ header:content-type | fn:default('application/octet-stream') }}"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"{{ header:status }}"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"ditto-message-subject"</span><span class="p">:</span><span class="w"> </span><span class="s2">"{{ header:ditto-message-subject | fn:default('fallback-subject') }}"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"ditto-message-direction"</span><span class="p">:</span><span class="w"> </span><span class="s2">"TO"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"ditto-message-thing-id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"{{ header:ditto-message-thing-id | fn:default('ns:fallback-thing') }}"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"ditto-message-feature-id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"{{ header:ditto-message-feature-id }}"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">outgoingContentType</code> (optional): The fallback content-type for outgoing message commands and responses without
the content-type header. Default to <code class="language-plaintext highlighter-rouge">text/plain; charset=UTF-8</code>.</li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">incomingMessageHeaders</code> (optional): A JSON object containing the following headers needed to construct a message
command or response envelope containing the incoming message as payload in the field <code class="language-plaintext highlighter-rouge">"value"</code>. 
The following placeholders may be used in the headers:</p>

    <table>
      <thead>
        <tr>
          <th>Placeholder</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><code class="language-plaintext highlighter-rouge">{{ header:&lt;header-name&gt; }}</code></td>
          <td>header value from the external message, e.g. from protocol headers</td>
        </tr>
        <tr>
          <td><code class="language-plaintext highlighter-rouge">{{ request:subjectId }}</code></td>
          <td>the first authenticated subjectId which did the request - the one of the connection source in this case</td>
        </tr>
        <tr>
          <td><code class="language-plaintext highlighter-rouge">{{ time:now }}</code></td>
          <td>the current timestamp in ISO-8601 format as string in UTC timezone</td>
        </tr>
        <tr>
          <td><code class="language-plaintext highlighter-rouge">{{ time:now_epoch_millis }}</code></td>
          <td>the current timestamp in “milliseconds since epoch” formatted as string</td>
        </tr>
      </tbody>
    </table>

    <ul>
      <li><code class="language-plaintext highlighter-rouge">content-type</code> (optional): The content type with which to encode the incoming message as payload.
 Default to <code class="language-plaintext highlighter-rouge">{{ header:content-type | fn:default('application/octet-stream') }}</code>.
 If resolved to the Ditto protocol content type <code class="language-plaintext highlighter-rouge">application/vnd.eclipse.ditto+json</code>, then the entire payload
 is interpreted as a Ditto protocol message instead.</li>
      <li><code class="language-plaintext highlighter-rouge">status</code> (optional): Include for message responses. Exclude for message commands. Default to
<code class="language-plaintext highlighter-rouge">{{ header:status }}</code>.</li>
      <li><code class="language-plaintext highlighter-rouge">ditto-message-subject</code> (mandatory for MQTT 3): Subject of the message. Default to <code class="language-plaintext highlighter-rouge">{{ header:ditto-message-subject }}</code>.
 Mapping will fail if not resolvable.</li>
      <li><code class="language-plaintext highlighter-rouge">ditto-message-direction</code> (optional): The message direction. Default to <code class="language-plaintext highlighter-rouge">TO</code>, which corresponds to <code class="language-plaintext highlighter-rouge">inbox</code> in
 message commands and responses.</li>
      <li><code class="language-plaintext highlighter-rouge">ditto-message-thing-id</code> (mandatory for MQTT 3): ID of the thing to send the message command or response to.
Default to <code class="language-plaintext highlighter-rouge">{{ header:ditto-message-thing-id }}</code>. Mapping will fail if not resolvable.</li>
      <li><code class="language-plaintext highlighter-rouge">ditto-message-feature-id</code> (optional): Include to send the message or message response to a feature of the thing.
Exclude to send it to the thing itself. Default to <code class="language-plaintext highlighter-rouge">{{ header:ditto-message-feature-id }}</code>.</li>
    </ul>
  </li>
</ul>

<h3 id="implicitthingcreation-mapper">ImplicitThingCreation mapper</h3>

<p>This mapper implicitly creates a new thing for an incoming message.</p>

<p>The created thing contains the values defined in the template, configured in the <code class="language-plaintext highlighter-rouge">mappingDefinitions</code> <code class="language-plaintext highlighter-rouge">options</code>.</p>

<h4 id="configuration-options-4">Configuration options</h4>

<ul>
  <li><code class="language-plaintext highlighter-rouge">thing</code> (required): The values of the thing that is created implicitly. It can either contain fixed values
 or header placeholders (e.g. <code class="language-plaintext highlighter-rouge">{{ header:device_id }}</code>).
    <ul>
      <li>
        <p>the following placeholders may be used inside the <code class="language-plaintext highlighter-rouge">"thing"</code> JSON:</p>

        <table>
          <thead>
            <tr>
              <th>Placeholder</th>
              <th>Description</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code class="language-plaintext highlighter-rouge">{{ header:&lt;header-name&gt; }}</code></td>
              <td>header value from the external message, e.g. from protocol headers</td>
            </tr>
            <tr>
              <td><code class="language-plaintext highlighter-rouge">{{ request:subjectId }}</code></td>
              <td>the first authenticated subjectId which did the request - the one of the connection source in this case</td>
            </tr>
            <tr>
              <td><code class="language-plaintext highlighter-rouge">{{ time:now }}</code></td>
              <td>the current timestamp in ISO-8601 format as string in UTC timezone</td>
            </tr>
            <tr>
              <td><code class="language-plaintext highlighter-rouge">{{ time:now_epoch_millis }}</code></td>
              <td>the current timestamp in “milliseconds since epoch” formatted as string</td>
            </tr>
          </tbody>
        </table>
      </li>
      <li>
        <p>The <code class="language-plaintext highlighter-rouge">"thing"</code> JSON may also include:</p>
        <ul>
          <li>an inline policy: <code class="language-plaintext highlighter-rouge">"_policy"</code> containing the <a href="basic-policy.html#model-specification">Policy JSON</a> to create a new policy
from and link with the thing</li>
          <li>a “copy policy from” statement: <code class="language-plaintext highlighter-rouge">"_copyPolicyFrom"</code> - see also <a href="protocol-examples-creatething.html#alternative-creatething-commands">create Thing alternatives</a>
            <ul>
              <li>either including a policyId to copy from</li>
              <li>or containing the link to a thing to copy the policy from in the form: <code class="language-plaintext highlighter-rouge">{{ ref:things/&lt;theThingId&gt;/policyId }}</code></li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">commandHeaders</code> (optional, default: <code class="language-plaintext highlighter-rouge">{"If-None-Match": "*"}</code>): The Ditto headers to use for constructing the “create thing” command for creating the
twin and to use for creating errors.
    <ul>
      <li>
        <p>in this configured headers, the following placeholders may be used:</p>

        <table>
          <thead>
            <tr>
              <th>Placeholder</th>
              <th>Description</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code class="language-plaintext highlighter-rouge">{{ header:&lt;header-name&gt; }}</code></td>
              <td>header value from the external message, e.g. from protocol headers</td>
            </tr>
            <tr>
              <td><code class="language-plaintext highlighter-rouge">{{ request:subjectId }}</code></td>
              <td>the first authenticated subjectId which did the request - the one of the connection source in this case</td>
            </tr>
            <tr>
              <td><code class="language-plaintext highlighter-rouge">{{ time:now }}</code></td>
              <td>the current timestamp in ISO-8601 format as string in UTC timezone</td>
            </tr>
            <tr>
              <td><code class="language-plaintext highlighter-rouge">{{ time:now_epoch_millis }}</code></td>
              <td>the current timestamp in “milliseconds since epoch” formatted as string</td>
            </tr>
          </tbody>
        </table>
      </li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">allowPolicyLockout</code> (optional, default: <code class="language-plaintext highlighter-rouge">true</code>): whether it should be allowed to create policies without having <code class="language-plaintext highlighter-rouge">WRITE</code>
permissions in the created policy for the subject which creates the policy 
(the <a href="connectivity-manage-connections.html#authorization">authorizationContext</a> of the connection source which 
received the message for which a thing should be created implicitly)</li>
</ul>

<p>Example of a template defined in <code class="language-plaintext highlighter-rouge">options</code>:</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"thing"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"thingId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"{{ header:device_id }}"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"CreatedBy"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ImplicitThingCreation"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"commandHeaders"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"If-None-Match"</span><span class="p">:</span><span class="w"> </span><span class="s2">"*"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"correlation-id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"{{ header:correlation-id }}"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"allowPolicyLockout"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h3 id="updatetwinwithliveresponse-mapper">UpdateTwinWithLiveResponse mapper</h3>

<p>This mapper creates a <a href="protocol-specification-things-merge.html">merge Thing command</a> when a 
<a href="protocol-specification-things-retrieve.html">retrieve command</a> was received via the 
<a href="protocol-twinlive.html#live">live channel</a> patching exactly the retrieved “live” data into the twin.</p>

<h4 id="configuration-options-5">Configuration options</h4>

<ul>
  <li><code class="language-plaintext highlighter-rouge">dittoHeadersForMerge</code> (optional): The Ditto headers to use for constructing the “merge thing”
command for updating the twin, may for example add a condition to apply in order to update the twin
(default applied Ditto headers if not configured: <code class="language-plaintext highlighter-rouge">"response-required": false</code>, <code class="language-plaintext highlighter-rouge">"if-match": "*"</code>).
    <ul>
      <li>
        <p>in this configured headers, the following placeholders may be used:</p>

        <table>
          <thead>
            <tr>
              <th>Placeholder</th>
              <th>Description</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code class="language-plaintext highlighter-rouge">{{ header:&lt;header-name&gt; }}</code></td>
              <td>header value from the external message, e.g. from protocol headers</td>
            </tr>
            <tr>
              <td><code class="language-plaintext highlighter-rouge">{{ request:subjectId }}</code></td>
              <td>the first authenticated subjectId which did the request - the one of the connection source in this case</td>
            </tr>
            <tr>
              <td><code class="language-plaintext highlighter-rouge">{{ time:now }}</code></td>
              <td>the current timestamp in ISO-8601 format as string in UTC timezone</td>
            </tr>
            <tr>
              <td><code class="language-plaintext highlighter-rouge">{{ time:now_epoch_millis }}</code></td>
              <td>the current timestamp in “milliseconds since epoch” formatted as string</td>
            </tr>
          </tbody>
        </table>
      </li>
    </ul>
  </li>
</ul>

<p>Example configuration:</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"dittoHeadersForMerge"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"if-match"</span><span class="p">:</span><span class="w"> </span><span class="s2">"*"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"response-required"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
    </span><span class="nl">"put-metadata"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="p">{</span><span class="nl">"key"</span><span class="p">:</span><span class="s2">"*/updated-by"</span><span class="p">,</span><span class="nl">"value"</span><span class="p">:</span><span class="s2">"{{ request:subjectId }}"</span><span class="p">},</span><span class="w">
      </span><span class="p">{</span><span class="nl">"key"</span><span class="p">:</span><span class="s2">"*/updated-via"</span><span class="p">,</span><span class="nl">"value"</span><span class="p">:</span><span class="s2">"device-live-response"</span><span class="p">},</span><span class="w">
      </span><span class="p">{</span><span class="nl">"key"</span><span class="p">:</span><span class="s2">"*/update-hint"</span><span class="p">,</span><span class="nl">"value"</span><span class="p">:</span><span class="s2">"{{ header:some-custom-hint }}"</span><span class="p">},</span><span class="w">
      </span><span class="p">{</span><span class="nl">"key"</span><span class="p">:</span><span class="s2">"*/updated-at"</span><span class="p">,</span><span class="nl">"value"</span><span class="p">:</span><span class="s2">"{{ time:now }}"</span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<h3 id="cloudevents-mapper">CloudEvents Mapper</h3>

<p>This mapper maps incoming <a href="https://github.com/cloudevents/spec/blob/v1.0.2/cloudevents/spec.md">CloudEvent</a> to Ditto Protocol. It provides support for both Binary CloudEvents as well as Structured CloudEvents.</p>

<p><strong>Note</strong>: The mapper supports incoming Structured CloudEvents  messages with <code class="language-plaintext highlighter-rouge">content-type:application/cloudevents+json</code> and Binary CloudEvents message with <code class="language-plaintext highlighter-rouge">content-type:application/vnd.eclipse.ditto+json</code></p>

<h4 id="cloudevents-examples">CloudEvents examples</h4>

<p>Incoming messages need to have the mandatory CloudEvents fields.
For example, a Binary CloudEvent for Ditto would look like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  headers:
      ce-specversion:1.0
      ce-id:some-id
      ce-type:some-type
      ce-source:generic-producer
      content-type:application/vnd.eclipse.ditto+json
</code></pre></div></div>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"topic"</span><span class="p">:</span><span class="w"> </span><span class="s2">"my.sensors/sensor01/things/twin/commands/modify"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"thingId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"my.sensors:sensor01"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"policyId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"my.test:policy"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"manufacturer"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Well known sensors producer"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"serial number"</span><span class="p">:</span><span class="w"> </span><span class="s2">"100"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"location"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Ground floor"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"features"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"measurements"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"temperature"</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w">
          </span><span class="nl">"humidity"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>A Structured CloudEvent for Ditto would look like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
headers:
  content-type:application/cloudevents+json
</code></pre></div></div>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"specversion"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1.0"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"3212e"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"source"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http:somesite.com"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"com.site.com"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"topic"</span><span class="p">:</span><span class="w"> </span><span class="s2">"my.sensors/sensor01/things/twin/commands/modify"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"thingId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"my.sensors:sensor01"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"policyId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"my.test:policy"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"manufacturer"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Well known sensors producer"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"serial number"</span><span class="p">:</span><span class="w"> </span><span class="s2">"100"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"location"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Ground floor"</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"features"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"measurements"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"temperature"</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w">
            </span><span class="nl">"humidity"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h2 id="example-connection-with-multiple-mappers">Example connection with multiple mappers</h2>

<p>The following example connection defines a <code class="language-plaintext highlighter-rouge">ConnectionStatus</code> mapping with the ID <code class="language-plaintext highlighter-rouge">status</code> and references it in a source.<br />
Messages received via this source will be mapped by the <code class="language-plaintext highlighter-rouge">Ditto</code> mapping and the <code class="language-plaintext highlighter-rouge">ConnectionStatus</code> mapping.<br />
The <code class="language-plaintext highlighter-rouge">Ditto</code> mapping requires no options to be configured, so you can directly use its alias <code class="language-plaintext highlighter-rouge">Ditto</code>.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w"> 
  </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"exampleConnection"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"sources"</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="w">
      </span><span class="nl">"addresses"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"&lt;source&gt;"</span><span class="p">],</span><span class="w">
      </span><span class="nl">"authorizationContext"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"ditto:inbound"</span><span class="p">],</span><span class="w">
      </span><span class="nl">"payloadMapping"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"Ditto"</span><span class="p">,</span><span class="w"> </span><span class="s2">"status"</span><span class="p">]</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"mappingDefinitions"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"mappingEngine"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ConnectionStatus"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"options"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"thingId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"{{ header:device_id }}"</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<div class="alert alert-info" role="alert"><i class="fa fa-info-circle"></i> <b>Note:</b> Starting aliases with an uppercase character and IDs with a lowercase character is
 encouraged to avoid confusion but this is not enforced. </div>

<h2 id="example-connection-with-mapping-conditions">Example connection with mapping conditions</h2>

<p>The following example connection defines <code class="language-plaintext highlighter-rouge">incomingConditions</code> and <code class="language-plaintext highlighter-rouge">outgoingConditions</code>for the ConnectionStatus 
mapping engine.<br />
Optional incomingConditions are validated before the mapping of inbound messages.<br />
Optional outgoingConditions are validated before the mapping of outbound messages.<br />
Conditional Mapping can be achieved by using <a href="basic-placeholders.html#function-expressions">function expressions</a>.
When multiple incoming or outgoing conditions are set for one <code class="language-plaintext highlighter-rouge">mappingEngine</code>, 
all have to equal true for the mapping to be executed.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w"> 
  </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"exampleConnection"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"sources"</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="w">
      </span><span class="nl">"addresses"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"&lt;source&gt;"</span><span class="p">],</span><span class="w">
      </span><span class="nl">"authorizationContext"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"ditto:inbound"</span><span class="p">],</span><span class="w">
      </span><span class="nl">"payloadMapping"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"status"</span><span class="p">]</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"mappingDefinitions"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"mappingEngine"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ConnectionStatus"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"incomingConditions"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"sampleCondition"</span><span class="p">:</span><span class="w"> </span><span class="s2">"fn:filter(header:incoming-mapping-required,'eq','true')"</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"outgoingConditions"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"sampleCondition"</span><span class="p">:</span><span class="w"> </span><span class="s2">"fn:filter(header:outgoing-mapping-required,'eq','true')"</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"options"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"thingId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"{{ header:device_id }}"</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h2 id="javascript-mapping-engine">JavaScript mapping engine</h2>

<p>Ditto utilizes the <a href="https://github.com/mozilla/rhino">Rhino</a> JavaScript engine for Java for evaluating the JavaScript
to apply for mapping payloads.</p>

<p>Using Rhino instead of Nashorn, the newer JavaScript engine shipped with Java, has the benefit that sandboxing can be 
applied in a better way.</p>

<p>Sandboxing of different payload scripts is required as Ditto is intended to be run as cloud service where multiple
connections to different endpoints are managed for different tenants at the same time. This requires the isolation of
each single script to avoid interference with other scripts and to protect the JVM executing the script against harmful
code execution.</p>

<h3 id="constraints">Constraints</h3>

<p>Rhino does not fully support EcmaScript 6. Check which language constructs are supported before using
them in a mapping function. See <a href="https://mozilla.github.io/rhino/compat/engines.html">https://mozilla.github.io/rhino/compat/engines.html</a>.</p>

<p>Ditto currently includes Rhino version <code class="language-plaintext highlighter-rouge">1.7.14</code> and has the <code class="language-plaintext highlighter-rouge">VERSION_ES6</code> flag enabled.</p>

<h4 id="sandboxing">Sandboxing</h4>

<p>For sandboxing/security reasons following restrictions apply:</p>

<ul>
  <li>access to Java packages and classes is not possible</li>
  <li>using <code class="language-plaintext highlighter-rouge">exit</code>, <code class="language-plaintext highlighter-rouge">quit</code>, <code class="language-plaintext highlighter-rouge">print</code>, etc. is not possible</li>
  <li>file access is not possible</li>
  <li>doing remote calls (e.g. to foreign web-servers) is not possible</li>
  <li>programming an endless-loop will terminate the script</li>
  <li>programming a recursion will terminate the script</li>
  <li>the file size of the script is limited</li>
  <li>no foreign JS libraries can be loaded (unless they fit in the file size limit and are included into the mapping script)</li>
</ul>

<h3 id="helper-libraries">Helper libraries</h3>

<p>In order to work more conveniently with binary payloads, the following libraries may be loaded for payload transformations:</p>

<ul>
  <li><a href="https://github.com/dcodeIO/bytebuffer.js">bytebuffer.js</a> a ByteBuffer implementation using ArrayBuffers</li>
  <li><a href="https://github.com/dcodeIO/long.js">long.js</a> for representing a 64-bit two’s-complement integer value</li>
</ul>

<h3 id="adding-additional-js-libraries">Adding additional JS libraries</h3>

<p>The used <a href="https://github.com/mozilla/rhino">Rhino JS engine</a> allows making use of “CommonJS” in order to load JS
modules via <code class="language-plaintext highlighter-rouge">require('')</code> into the engine.<br />
This feature is exposed to Ditto, configuring the configuration key <code class="language-plaintext highlighter-rouge">commonJsModulePath</code> or environment variable 
<code class="language-plaintext highlighter-rouge">CONNECTIVITY_MESSAGE_MAPPING_JS_COMMON_JS_MODULE_PATH</code> of the connectivity service to a path in the
connectivity Docker container where to load additional CommonJS modules from - e.g. use a volume mount in order to get
additional JS modules into the container.</p>

<p>For example, configure this variable to a folder to which you add (our mount) JavaScript libraries:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CONNECTIVITY_MESSAGE_MAPPING_JS_COMMON_JS_MODULE_PATH=/opt/commonjs-modules/
</code></pre></div></div>

<p>Then, for example, put <a href="https://www.npmjs.com/package/pbf"><code class="language-plaintext highlighter-rouge">pbf.js</code></a> (or any other JS library you want to use) 
into that folder.</p>

<p>Afterwards, the library can be used in your JS snippet using:</p>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">Pbf</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">pbf</span><span class="dl">'</span><span class="p">);</span>
</code></pre></div></div>

<h3 id="helper-functions">Helper functions</h3>

<p>Ditto comes with a few helper functions, which makes writing the mapping scripts easier. They are available under the
<code class="language-plaintext highlighter-rouge">Ditto</code> scope:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Builds a Ditto Protocol message from the passed parameters.
 * @param {string} namespace - The namespace of the entity in java package notation, e.g.: "org.eclipse.ditto". Or "_"
 * (underscore) for connection announcements.
 * @param {string} name - The name of the entity, e.g.: "device".
 * @param {string} channel - The channel for the signal: "twin"|"live"|"none"
 * @param {string} group - The affected group/entity: "things"|"policies"|"connections".
 * @param {string} criterion - The criterion to apply: "commands"|"events"|"search"|"messages"|"announcements"|"errors".
 * @param {string} action - The action to perform: "create"|"retrieve"|"modify"|"delete". Or the announcement name:
 * "opened"|"closed"|"subjectDeletion". Or the subject of the message.
 * @param {string} path - The path which is affected by the message (e.g.: "/attributes"), or the destination
 * of a message (e.g.: "inbox"|"outbox").
 * @param {Object.&lt;string, string&gt;} dittoHeaders - The headers Object containing all Ditto Protocol header values.
 * @param {*} [value] - The value to apply / which was applied (e.g. in a "modify" action).
 * @param {number} [status] - The status code that indicates the result of the command. If setting a status code,
 * the Ditto Protocol Message will be interpreted as a response (e.g. content will be ignored when using 204).
 * @param {Object} [extra] - The enriched extra fields when selected via "extraFields" option.
 * @returns {DittoProtocolMessage} dittoProtocolMessage(s) -
 *  The mapped Ditto Protocol message or
 *  &lt;code&gt;null&lt;/code&gt; if the message could/should not be mapped
 */</span>
<span class="kd">function</span> <span class="nf">buildDittoProtocolMsg</span><span class="p">(</span><span class="nx">namespace</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">group</span><span class="p">,</span> <span class="nx">channel</span><span class="p">,</span> <span class="nx">criterion</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">dittoHeaders</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">extra</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">topic</span> <span class="o">=</span> <span class="nf">buildTopic</span><span class="p">(</span><span class="nx">namespace</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">group</span><span class="p">,</span> <span class="nx">channel</span><span class="p">,</span> <span class="nx">criterion</span><span class="p">,</span> <span class="nx">action</span><span class="p">);</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="na">topic</span><span class="p">:</span> <span class="nx">topic</span><span class="p">,</span>
        <span class="na">path</span><span class="p">:</span> <span class="nx">path</span><span class="p">,</span>
        <span class="na">headers</span><span class="p">:</span> <span class="nx">dittoHeaders</span><span class="p">,</span>
        <span class="na">value</span><span class="p">:</span> <span class="nx">value</span><span class="p">,</span>
        <span class="na">status</span><span class="p">:</span> <span class="nx">status</span><span class="p">,</span>
        <span class="na">extra</span><span class="p">:</span> <span class="nx">extra</span><span class="p">,</span>
    <span class="p">};</span>
<span class="p">}</span>

<span class="cm">/**
 * Builds a Ditto Protocol topic from the passed parameters.
 * @param {string} namespace - The namespace of the entity in java package notation, e.g.: "org.eclipse.ditto". Or "_"
 * (underscore) for connection announcements.
 * @param {string} name - The name of the entity, e.g.: "device".
 * @param {string} channel - The channel for the signal: "twin"|"live"|"none"
 * @param {string} group - The affected group/entity: "things"|"policies"|"connections".
 * @param {string} criterion - The criterion to apply: "commands"|"events"|"search"|"messages"|"announcements"|"errors".
 * @param {string} action - The action to perform: "create"|"retrieve"|"modify"|"delete". Or the announcement name:
 * "opened"|"closed"|"subjectDeletion". Or the subject of the message.
 * @returns {string} topic - the topic.
 */</span>
<span class="kd">function</span> <span class="nf">buildTopic</span><span class="p">(</span><span class="nx">namespace</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">group</span><span class="p">,</span> <span class="nx">channel</span><span class="p">,</span> <span class="nx">criterion</span><span class="p">,</span> <span class="nx">action</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">topicChannel</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">none</span><span class="dl">'</span> <span class="o">===</span> <span class="nx">channel</span> <span class="p">?</span> <span class="dl">''</span> <span class="p">:</span> <span class="dl">'</span><span class="s1">/</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">channel</span><span class="p">;</span>

    <span class="k">return</span> <span class="nx">namespace</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">/</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">name</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">/</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">group</span> <span class="o">+</span> <span class="nx">topicChannel</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">/</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">criterion</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">/</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">action</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**
 * Builds an external message from the passed parameters.
 * @param {Object.&lt;string, string&gt;} headers - The external headers Object containing header values
 * @param {string} [textPayload] - The external mapped String
 * @param {ArrayBuffer} [bytePayload] - The external mapped bytes as ArrayBuffer
 * @param {string} [contentType] - The returned Content-Type
 * @returns {ExternalMessage} externalMessage - 
 *  the mapped external message
 *  or &lt;code&gt;null&lt;/code&gt; if the message could/should not be mapped
 */</span>
<span class="kd">function</span> <span class="nf">buildExternalMsg</span><span class="p">(</span><span class="nx">headers</span><span class="p">,</span> <span class="nx">textPayload</span><span class="p">,</span> <span class="nx">bytePayload</span><span class="p">,</span> <span class="nx">contentType</span><span class="p">)</span> <span class="p">{</span>

  <span class="k">return</span> <span class="p">{</span>
    <span class="na">headers</span><span class="p">:</span> <span class="nx">headers</span><span class="p">,</span>
    <span class="na">textPayload</span><span class="p">:</span> <span class="nx">textPayload</span><span class="p">,</span>
    <span class="na">bytePayload</span><span class="p">:</span> <span class="nx">bytePayload</span><span class="p">,</span>
    <span class="na">contentType</span><span class="p">:</span> <span class="nx">contentType</span><span class="p">,</span>
  <span class="p">};</span>
<span class="p">}</span>

<span class="cm">/**
 * Transforms the passed ArrayBuffer to a String interpreting the content of the passed arrayBuffer as unsigned 8
 * bit integers.
 *
 * @param {ArrayBuffer} arrayBuffer the ArrayBuffer to transform to a String
 * @returns {String} the transformed String
 */</span>
<span class="kd">function</span> <span class="nf">arrayBufferToString</span><span class="p">(</span><span class="nx">arrayBuffer</span><span class="p">)</span> <span class="p">{</span>

  <span class="k">return</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">.</span><span class="nf">apply</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="k">new</span> <span class="nc">Uint8Array</span><span class="p">(</span><span class="nx">arrayBuffer</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**
 * Transforms the passed String to an ArrayBuffer using unsigned 8 bit integers.
 *
 * @param {String} string the String to transform to an ArrayBuffer
 * @returns {ArrayBuffer} the transformed ArrayBuffer
 */</span>
<span class="kd">function</span> <span class="nf">stringToArrayBuffer</span><span class="p">(</span><span class="nx">string</span><span class="p">)</span> <span class="p">{</span>

  <span class="kd">let</span> <span class="nx">buf</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayBuffer</span><span class="p">(</span><span class="nx">string</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
  <span class="kd">let</span> <span class="nx">bufView</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Uint8Array</span><span class="p">(</span><span class="nx">buf</span><span class="p">);</span>
  <span class="k">for </span><span class="p">(</span><span class="kd">let</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nx">strLen</span><span class="o">=</span><span class="nx">string</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">strLen</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">bufView</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">string</span><span class="p">.</span><span class="nf">charCodeAt</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">buf</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**
 * Transforms the passed ArrayBuffer to a {ByteBuffer} (from bytebuffer.js library which needs to be loaded).
 *
 * @param {ArrayBuffer} arrayBuffer the ArrayBuffer to transform
 * @returns {ByteBuffer} the transformed ByteBuffer
 */</span>
<span class="kd">function</span> <span class="nf">asByteBuffer</span><span class="p">(</span><span class="nx">arrayBuffer</span><span class="p">)</span> <span class="p">{</span>
    
  <span class="kd">let</span> <span class="nx">byteBuffer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayBuffer</span><span class="p">(</span><span class="nx">arrayBuffer</span><span class="p">.</span><span class="nx">byteLength</span><span class="p">);</span>
  <span class="k">new</span> <span class="nc">Uint8Array</span><span class="p">(</span><span class="nx">byteBuffer</span><span class="p">).</span><span class="nf">set</span><span class="p">(</span><span class="k">new</span> <span class="nc">Uint8Array</span><span class="p">(</span><span class="nx">arrayBuffer</span><span class="p">));</span>
  <span class="k">return</span> <span class="nx">dcodeIO</span><span class="p">.</span><span class="nx">ByteBuffer</span><span class="p">.</span><span class="nf">wrap</span><span class="p">(</span><span class="nx">byteBuffer</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="mapping-incoming-messages">Mapping incoming messages</h3>

<p>Incoming external messages can be mapped to Ditto Protocol conform messages by implementing the following JavaScript function:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Maps the passed parameters to a Ditto Protocol message.
 * @param {Object.&lt;string, string&gt;} headers - The headers Object containing all received header values
 * @param {string} [textPayload] - The String to be mapped
 * @param {ArrayBuffer} [bytePayload] - The bytes to be mapped as ArrayBuffer
 * @param {string} [contentType] - The received Content-Type, e.g. "application/json"
 * @returns {(DittoProtocolMessage|Array&lt;DittoProtocolMessage&gt;)} dittoProtocolMessage(s) -
 *  the mapped Ditto Protocol message,
 *  an array of Ditto Protocol messages or
 *  &lt;code&gt;null&lt;/code&gt; if the message could/should not be mapped
 */</span>
<span class="kd">function</span> <span class="nf">mapToDittoProtocolMsg</span><span class="p">(</span>
  <span class="nx">headers</span><span class="p">,</span>
  <span class="nx">textPayload</span><span class="p">,</span>
  <span class="nx">bytePayload</span><span class="p">,</span>
  <span class="nx">contentType</span>
<span class="p">)</span> <span class="p">{</span>

  <span class="c1">// ### Insert/adapt your mapping logic here.</span>
  <span class="c1">// Use helper function Ditto.buildDittoProtocolMsg to build Ditto protocol message</span>
  <span class="c1">// based on incoming payload.</span>
  <span class="c1">// See https://websites.eclipseprojects.io/ditto/connectivity-mapping.html#helper-functions for details.</span>
  <span class="c1">// ### example code assuming the Ditto protocol content type for incoming messages.</span>
  <span class="k">if </span><span class="p">(</span><span class="nx">contentType</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">application/vnd.eclipse.ditto+json</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Message is sent as Ditto protocol text payload and can be used directly</span>
    <span class="k">return</span> <span class="nx">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="nx">textPayload</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if </span><span class="p">(</span><span class="nx">contentType</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">application/octet-stream</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Message is sent as binary payload; assume Ditto protocol message (JSON).</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="nx">Ditto</span><span class="p">.</span><span class="nf">arrayBufferToString</span><span class="p">(</span><span class="nx">bytePayload</span><span class="p">));</span>
    <span class="p">}</span> <span class="k">catch </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// parsing failed (no JSON document); return null to drop the message</span>
      <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if </span><span class="p">(</span><span class="nx">contentType</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">application/json</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">parsedJson</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="nx">textPayload</span><span class="p">);</span>
    <span class="c1">// the following variables would be determined from the "parsedJson" and from the "headers":</span>
    <span class="kd">let</span> <span class="nx">namespace</span> <span class="o">=</span> <span class="dl">""</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">name</span> <span class="o">=</span> <span class="dl">""</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">group</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">things</span><span class="dl">"</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">channel</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">twin</span><span class="dl">"</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">criterion</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">commands</span><span class="dl">"</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">action</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">modify</span><span class="dl">"</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">path</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">/attributes</span><span class="dl">"</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">dittoHeaders</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="kd">let</span> <span class="nx">value</span> <span class="o">=</span> <span class="p">{</span>
      <span class="dl">"</span><span class="s2">a</span><span class="dl">"</span><span class="p">:</span> <span class="mi">1</span>
    <span class="p">};</span>
    <span class="k">return</span> <span class="nx">Ditto</span><span class="p">.</span><span class="nf">buildDittoProtocolMsg</span><span class="p">(</span>
      <span class="nx">namespace</span><span class="p">,</span> 
      <span class="nx">name</span><span class="p">,</span> 
      <span class="nx">group</span><span class="p">,</span> 
      <span class="nx">channel</span><span class="p">,</span> 
      <span class="nx">criterion</span><span class="p">,</span> 
      <span class="nx">action</span><span class="p">,</span> 
      <span class="nx">path</span><span class="p">,</span> 
      <span class="nx">dittoHeaders</span><span class="p">,</span> 
      <span class="nx">value</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="c1">// no mapping logic matched; return null to drop the message</span>
  <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The result of the function has to be a JavaScript object in <a href="protocol-overview.html">Ditto Protocol</a> or an array of 
such JavaScript objects. That’s where the helper method <code class="language-plaintext highlighter-rouge">Ditto.buildDittoProtocolMsg</code> is useful: 
it explicitly defines which parameters are required for the Ditto Protocol message.</p>

<p>There is another JavaScript function which is helpful when access to the complete external message is needed.
It is possible to define the <code class="language-plaintext highlighter-rouge">mapToDittoProtocolMsgWrapper</code> in the incoming payload mapping and access the original
<code class="language-plaintext highlighter-rouge">externalMsg</code>.</p>

<p>This is the default implementation of <code class="language-plaintext highlighter-rouge">mapToDittoProtocolMsgWrapper</code>, delegating to <code class="language-plaintext highlighter-rouge">mapToDittoProtocolMsg</code>:</p>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Maps the passed external message to a Ditto Protocol message.
 * @param {ExternalMessage} externalMsg - The external message to map to a Ditto Protocol message
 * @returns {(DittoProtocolMessage|Array&lt;DittoProtocolMessage&gt;)} dittoProtocolMessage(s) -
 *  The mapped Ditto Protocol message,
 *  an array of Ditto Protocol messages or
 *  &lt;code&gt;null&lt;/code&gt; if the message could/should not be mapped
 */</span>
<span class="kd">function</span> <span class="nf">mapToDittoProtocolMsgWrapper</span><span class="p">(</span><span class="nx">externalMsg</span><span class="p">)</span> <span class="p">{</span>

  <span class="kd">let</span> <span class="nx">headers</span> <span class="o">=</span> <span class="nx">externalMsg</span><span class="p">.</span><span class="nx">headers</span><span class="p">;</span>
  <span class="kd">let</span> <span class="nx">textPayload</span> <span class="o">=</span> <span class="nx">externalMsg</span><span class="p">.</span><span class="nx">textPayload</span><span class="p">;</span>
  <span class="kd">let</span> <span class="nx">bytePayload</span> <span class="o">=</span> <span class="nx">externalMsg</span><span class="p">.</span><span class="nx">bytePayload</span><span class="p">;</span>
  <span class="kd">let</span> <span class="nx">contentType</span> <span class="o">=</span> <span class="nx">externalMsg</span><span class="p">.</span><span class="nx">contentType</span><span class="p">;</span>

  <span class="k">return</span> <span class="nf">mapToDittoProtocolMsg</span><span class="p">(</span><span class="nx">headers</span><span class="p">,</span> <span class="nx">textPayload</span><span class="p">,</span> <span class="nx">bytePayload</span><span class="p">,</span> <span class="nx">contentType</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="mapping-outgoing-messages">Mapping outgoing messages</h3>

<p>Outgoing Ditto Protocol messages (e.g. <a href="basic-signals-commandresponse.html">responses</a> or <a href="basic-signals-event.html">events</a>) 
can be mapped to external messages by implementing the following JavaScript function:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Maps the passed parameters which originated from a Ditto Protocol message to an external message.
 * @param {string} namespace - The namespace of the entity in java package notation, e.g.: "org.eclipse.ditto". Or "_" 
 * (underscore) for connection announcements.
 * @param {string} name - The name of the entity, e.g.: "device".
 * @param {string} group - The affected group/entity: "things"|"policies"|"connections".
 * @param {string} channel - The channel for the signal: "twin"|"live"|"none"
 * @param {string} criterion - The criterion to apply: "commands"|"events"|"search"|"messages"|"announcements"|
 * "errors".
 * @param {string} action - The action to perform: "create"|"retrieve"|"modify"|"delete". Or the announcement name: 
 * "opened"|"closed"|"subjectDeletion". Or the subject of the message.
 * @param {string} path - The path which is affected by the message (e.g.: "/attributes"), or the destination
 * of a message (e.g.: "inbox"|"outbox").
 * @param {Object.&lt;string, string&gt;} dittoHeaders - The headers Object containing all Ditto Protocol header values.
 * @param {*} [value] - The value to apply / which was applied (e.g. in a "modify" action).
 * @param {number} [status] - The status code that indicates the result of the command. When this field is set,
 * it indicates that the Ditto Protocol Message contains a response.
 * @param {Object} [extra] - The enriched extra fields when selected via "extraFields" option.
 * @returns {(ExternalMessage|Array&lt;ExternalMessage&gt;)} externalMessage - The mapped external message, an array of 
 * external messages or &lt;code&gt;null&lt;/code&gt; if the message could/should not be mapped.
 */</span>
<span class="kd">function</span> <span class="nf">mapFromDittoProtocolMsg</span><span class="p">(</span>
  <span class="nx">namespace</span><span class="p">,</span>
  <span class="nx">name</span><span class="p">,</span>
  <span class="nx">group</span><span class="p">,</span>
  <span class="nx">channel</span><span class="p">,</span>
  <span class="nx">criterion</span><span class="p">,</span>
  <span class="nx">action</span><span class="p">,</span>
  <span class="nx">path</span><span class="p">,</span>
  <span class="nx">dittoHeaders</span><span class="p">,</span>
  <span class="nx">value</span><span class="p">,</span>
  <span class="nx">status</span><span class="p">,</span>
  <span class="nx">extra</span>
<span class="p">)</span> <span class="p">{</span>

  <span class="c1">// ###</span>
  <span class="c1">// Insert your mapping logic here</span>
  <span class="c1">// ### example code using the Ditto protocol content type.</span>
  <span class="kd">let</span> <span class="nx">headers</span> <span class="o">=</span> <span class="nx">dittoHeaders</span><span class="p">;</span>
  <span class="kd">let</span> <span class="nx">textPayload</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nf">stringify</span><span class="p">(</span><span class="nx">Ditto</span><span class="p">.</span><span class="nf">buildDittoProtocolMsg</span><span class="p">(</span><span class="nx">namespace</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">group</span><span class="p">,</span> <span class="nx">channel</span><span class="p">,</span> <span class="nx">criterion</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> 
                                                               <span class="nx">path</span><span class="p">,</span> <span class="nx">dittoHeaders</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">extra</span><span class="p">));</span>
  <span class="kd">let</span> <span class="nx">bytePayload</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="kd">let</span> <span class="nx">contentType</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">application/vnd.eclipse.ditto+json</span><span class="dl">'</span><span class="p">;</span>
  <span class="k">return</span> <span class="nx">Ditto</span><span class="p">.</span><span class="nf">buildExternalMsg</span><span class="p">(</span>
    <span class="nx">headers</span><span class="p">,</span> <span class="c1">// The external headers Object containing header values</span>
    <span class="nx">textPayload</span><span class="p">,</span> <span class="c1">// The external mapped String</span>
    <span class="nx">bytePayload</span><span class="p">,</span> <span class="c1">// The external mapped byte[]</span>
    <span class="nx">contentType</span> <span class="c1">// The returned Content-Type</span>
  <span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The result of the function has to be a JavaScript object or, an array of JavaScript objects with the fields <code class="language-plaintext highlighter-rouge">headers</code>, 
<code class="language-plaintext highlighter-rouge">textPayload</code>, <code class="language-plaintext highlighter-rouge">bytePayload</code> and <code class="language-plaintext highlighter-rouge">contentType</code>. That’s where the helper method <code class="language-plaintext highlighter-rouge">Ditto.buildExternalMsg</code> is useful: 
it explicitly defines which parameters are required for the external message.</p>

<p>There is another JavaScript function which is helpful when access to the complete Ditto protocol message is needed.
It is possible to define the <code class="language-plaintext highlighter-rouge">mapFromDittoProtocolMsgWrapper</code> in the outgoing payload mapping and access the
original <code class="language-plaintext highlighter-rouge">dittoProtocolMsg</code>.<br />
Please refer to the <a href="protocol-specification.html#dittoProtocolEnvelope">Ditto Protocol specification</a>
to inspect which JSON fields are available when.</p>

<p>This is the default implementation of <code class="language-plaintext highlighter-rouge">mapFromDittoProtocolMsgWrapper</code>, delegating to <code class="language-plaintext highlighter-rouge">mapFromDittoProtocolMsg</code>:</p>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Maps the passed Ditto Protocol message to an external message.
 * @param {DittoProtocolMessage} dittoProtocolMsg - The Ditto Protocol message to map
 * @returns {(ExternalMessage|Array&lt;ExternalMessage&gt;)} externalMessage -
 *  The mapped external message,
 *  an array of external messages or
 *  &lt;code&gt;null&lt;/code&gt; if the message could/should not be mapped
 */</span>
<span class="kd">function</span> <span class="nf">mapFromDittoProtocolMsgWrapper</span><span class="p">(</span><span class="nx">dittoProtocolMsg</span><span class="p">)</span> <span class="p">{</span>

  <span class="kd">let</span> <span class="nx">topic</span> <span class="o">=</span> <span class="nx">dittoProtocolMsg</span><span class="p">.</span><span class="nx">topic</span><span class="p">;</span>
  <span class="kd">let</span> <span class="nx">splitTopic</span> <span class="o">=</span> <span class="nx">topic</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="dl">"</span><span class="s2">/</span><span class="dl">"</span><span class="p">);</span>

  <span class="kd">let</span> <span class="nx">namespace</span> <span class="o">=</span> <span class="nx">splitTopic</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
  <span class="kd">let</span> <span class="nx">name</span> <span class="o">=</span> <span class="nx">splitTopic</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
  <span class="kd">let</span> <span class="nx">group</span> <span class="o">=</span> <span class="nx">splitTopic</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

  <span class="kd">let</span> <span class="nx">channel</span><span class="p">;</span>
  <span class="kd">let</span> <span class="nx">criterion</span><span class="p">;</span>
  <span class="kd">let</span> <span class="nx">action</span><span class="p">;</span>
  <span class="k">if </span><span class="p">(</span><span class="nf">hasChannel</span><span class="p">(</span><span class="nx">group</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">channel</span> <span class="o">=</span> <span class="nx">splitTopic</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
    <span class="nx">criterion</span> <span class="o">=</span> <span class="nx">splitTopic</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
    <span class="nx">action</span> <span class="o">=</span> <span class="nx">splitTopic</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">channel</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">none</span><span class="dl">'</span><span class="p">;</span>
    <span class="nx">criterion</span> <span class="o">=</span> <span class="nx">splitTopic</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
    <span class="nx">action</span> <span class="o">=</span> <span class="nx">splitTopic</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
  <span class="p">}</span>

  <span class="kd">let</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">dittoProtocolMsg</span><span class="p">.</span><span class="nx">path</span><span class="p">;</span>
  <span class="kd">let</span> <span class="nx">dittoHeaders</span> <span class="o">=</span> <span class="nx">dittoProtocolMsg</span><span class="p">.</span><span class="nx">headers</span><span class="p">;</span>
  <span class="kd">let</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">dittoProtocolMsg</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
  <span class="kd">let</span> <span class="nx">status</span> <span class="o">=</span> <span class="nx">dittoProtocolMsg</span><span class="p">.</span><span class="nx">status</span><span class="p">;</span>
  <span class="kd">let</span> <span class="nx">extra</span> <span class="o">=</span> <span class="nx">dittoProtocolMsg</span><span class="p">.</span><span class="nx">extra</span><span class="p">;</span>

  <span class="k">return</span> <span class="nf">mapFromDittoProtocolMsg</span><span class="p">(</span><span class="nx">namespace</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">group</span><span class="p">,</span> <span class="nx">channel</span><span class="p">,</span> <span class="nx">criterion</span><span class="p">,</span> <span class="nx">action</span><span class="p">,</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">dittoHeaders</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">extra</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="javascript-payload-types">JavaScript payload types</h2>

<p>Both, text payloads and byte payloads may be mapped.</p>

<h3 id="text-payloads">Text payloads</h3>

<p>Working with text payloads is as easy as it gets in JavaScript. For example, for the content-type <code class="language-plaintext highlighter-rouge">application/json</code>
structured data may be processed like this:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">value</span><span class="p">;</span>
<span class="k">if </span><span class="p">(</span><span class="nx">contentType</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">application/json</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">parsedJson</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="nx">textPayload</span><span class="p">);</span>
  <span class="nx">value</span> <span class="o">=</span> <span class="nx">parsedJson</span><span class="p">.</span><span class="nx">number1</span> <span class="o">+</span> <span class="nx">parsedJson</span><span class="p">[</span><span class="dl">'</span><span class="s1">sub-field</span><span class="dl">'</span><span class="p">];</span> <span class="c1">// remember to access JSON keys with dashes in a JS special way</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
  <span class="c1">// a script may decide to not map other content-types than application/json</span>
  <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">}</span>
<span class="c1">// proceed ...</span>
</code></pre></div></div>

<h3 id="byte-payloads">Byte payloads</h3>

<p>Working with byte payloads is also possible but does require a little bit of knowledge about JavaScript’s 
<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/ArrayBuffer">ArrayBuffer</a> 
<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/TypedArray">TypedArrays</a> and
<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/DataView">DataView</a>.</p>

<p>What you get in the mapping scripts is a <code class="language-plaintext highlighter-rouge">bytePayload</code> of type <code class="language-plaintext highlighter-rouge">ArrayBuffer</code> which lets you work on the bytes 
in different ways:</p>

<h4 id="typed-arrays">Typed Arrays</h4>

<blockquote>
  <p>A TypedArray [is] a view into an ArrayBuffer where every item has the same size and type.<br /> <a href="https://hacks.mozilla.org/2017/01/typedarray-or-dataview-understanding-byte-order/">source</a></p>
</blockquote>

<p>With TypedArrays you can simply wrap the <code class="language-plaintext highlighter-rouge">bytePayload</code> <code class="language-plaintext highlighter-rouge">ArrayBuffer</code> and work on all the items e.g. 
as unsigned 8-bit integers:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">bytes</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Uint8Array</span><span class="p">(</span><span class="nx">bytePayload</span><span class="p">);</span>
<span class="nx">bytes</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="c1">// access the first byte</span>
<span class="nx">bytes</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span> <span class="c1">// access the second byte</span>
</code></pre></div></div>

<h4 id="dataviews">DataViews</h4>

<blockquote>
  <p>The DataView [is] another view into an ArrayBuffer, but one which allows items of different size and type in the ArrayBuffer.<br /> <a href="https://hacks.mozilla.org/2017/01/typedarray-or-dataview-understanding-byte-order/">source</a></p>
</blockquote>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">view</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DataView</span><span class="p">(</span><span class="nx">bytePayload</span><span class="p">);</span>
<span class="nx">view</span><span class="p">.</span><span class="nf">getInt8</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="c1">// access a 8-bit signed integer (byte) on offset=0</span>
<span class="nx">view</span><span class="p">.</span><span class="nf">getUint16</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="c1">// access a 16-bit unsigned integer (usigned short) on offset=1</span>
</code></pre></div></div>

<p>DataViews also allow to <code class="language-plaintext highlighter-rouge">set</code> bytes to an underlying ArrayBuffer conveniently.</p>

<h4 id="bytebufferjs">ByteBuffer.js</h4>

<p>Alternatively, Ditto’s JavaScript transformation may be loaded with the <a href="#helper-libraries">above mentioned</a> libraries, 
e.g. “bytebuffer.js”.<br />
With <code class="language-plaintext highlighter-rouge">ByteBuffer</code>, the content of an <code class="language-plaintext highlighter-rouge">ArrayBuffer</code> can be accessed in a buffered way:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">byteBuf</span> <span class="o">=</span> <span class="nx">Ditto</span><span class="p">.</span><span class="nf">asByteBuffer</span><span class="p">(</span><span class="nx">bytePayload</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">numberFromBytes</span> <span class="o">=</span> <span class="nf">parseInt</span><span class="p">(</span><span class="nx">byteBuf</span><span class="p">.</span><span class="nf">toHex</span><span class="p">(),</span> <span class="mi">16</span><span class="p">);</span>

<span class="kd">let</span> <span class="nx">base64encoded</span> <span class="o">=</span> <span class="nx">byteBuf</span><span class="p">.</span><span class="nf">toBase64</span><span class="p">();</span>
<span class="kd">let</span> <span class="nx">buf</span> <span class="o">=</span> <span class="nx">dcodeIO</span><span class="p">.</span><span class="nx">ByteBuffer</span><span class="p">.</span><span class="nf">fromBase64</span><span class="p">(</span><span class="nx">base64encoded</span><span class="p">);</span>

<span class="nx">buf</span><span class="p">.</span><span class="nf">readInt</span><span class="p">();</span> <span class="c1">// read a 32bit signed integer + advances the offset in the buffer</span>
<span class="nx">buf</span><span class="p">.</span><span class="nf">readUTF8String</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span> <span class="c1">// read 4 characters of UTF-8 encoded string + advances the offset in the buffer</span>
<span class="nx">buf</span><span class="p">.</span><span class="nf">remaining</span><span class="p">();</span> <span class="c1">// gets the number of remaining readable bytes in the buffer</span>
</code></pre></div></div>

<p>Check the <a href="https://github.com/dcodeIO/bytebuffer.js/wiki/API">ByteBuffer API documentation</a> to find out what is possible 
with that helper.</p>

<h2 id="javascript-examples">JavaScript Examples</h2>

<h3 id="text-payload-example">Text payload example</h3>

<p>Let’s assume your device sends telemetry data via <a href="https://www.eclipse.org/hono/">Eclipse Hono’s</a> MQTT adapter 
into the cloud. And, that an example payload of your device is:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"temp"</span><span class="p">:</span><span class="w"> </span><span class="s2">"23.42 °C"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"hum"</span><span class="p">:</span><span class="w"> </span><span class="mi">78</span><span class="p">,</span><span class="w">
  </span><span class="nl">"pres"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mi">760</span><span class="p">,</span><span class="w">
    </span><span class="nl">"unit"</span><span class="p">:</span><span class="w"> </span><span class="s2">"mmHg"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>We want to map a single message of this device containing updates for all 3 values to a Thing in the following structure:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"thingId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"the.namespace:the-thing-id"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"policyId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"the.namespace:the-policy-id"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"features"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"temperature"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
       </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
         </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mf">23.42</span><span class="w">
       </span><span class="p">}</span><span class="w">
     </span><span class="p">},</span><span class="w">
    </span><span class="nl">"pressure"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
       </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
         </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mi">760</span><span class="w">
       </span><span class="p">}</span><span class="w">
     </span><span class="p">},</span><span class="w">
    </span><span class="nl">"humidity"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
       </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
         </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mi">78</span><span class="w">
       </span><span class="p">}</span><span class="w">
     </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Therefore, we define following <code class="language-plaintext highlighter-rouge">incoming</code> mapping function:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nf">mapToDittoProtocolMsg</span><span class="p">(</span>
    <span class="nx">headers</span><span class="p">,</span>
    <span class="nx">textPayload</span><span class="p">,</span>
    <span class="nx">bytePayload</span><span class="p">,</span>
    <span class="nx">contentType</span>
<span class="p">)</span> <span class="p">{</span>
    
    <span class="k">if </span><span class="p">(</span><span class="nx">contentType</span> <span class="o">!==</span> <span class="dl">'</span><span class="s1">application/json</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="p">;</span> <span class="c1">// only handle messages with content-type application/json</span>
    <span class="p">}</span>
    
    <span class="kd">let</span> <span class="nx">jsonData</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="nx">textPayload</span><span class="p">);</span>
    
    <span class="kd">let</span> <span class="nx">value</span> <span class="o">=</span> <span class="p">{</span>
        <span class="na">temperature</span><span class="p">:</span> <span class="p">{</span>
            <span class="na">properties</span><span class="p">:</span> <span class="p">{</span>
                <span class="na">value</span><span class="p">:</span> <span class="nx">jsonData</span><span class="p">.</span><span class="nx">temp</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="dl">"</span><span class="s2"> </span><span class="dl">"</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="c1">// omit the unit</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="na">pressure</span><span class="p">:</span> <span class="p">{</span>
            <span class="na">properties</span><span class="p">:</span> <span class="p">{</span>
                <span class="na">value</span><span class="p">:</span> <span class="nx">jsonData</span><span class="p">.</span><span class="nx">pres</span><span class="p">.</span><span class="nx">value</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="na">humidity</span><span class="p">:</span> <span class="p">{</span>
            <span class="na">properties</span><span class="p">:</span> <span class="p">{</span>
                <span class="na">value</span><span class="p">:</span> <span class="nx">jsonData</span><span class="p">.</span><span class="nx">hum</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">};</span>

    <span class="k">return</span> <span class="nx">Ditto</span><span class="p">.</span><span class="nf">buildDittoProtocolMsg</span><span class="p">(</span>
        <span class="dl">'</span><span class="s1">org.eclipse.ditto</span><span class="dl">'</span><span class="p">,</span> <span class="c1">// in this example always the same</span>
        <span class="nx">headers</span><span class="p">[</span><span class="dl">'</span><span class="s1">device_id</span><span class="dl">'</span><span class="p">],</span> <span class="c1">// Eclipse Hono sets the authenticated device_id as AMQP 1.0 header</span>
        <span class="dl">'</span><span class="s1">things</span><span class="dl">'</span><span class="p">,</span> <span class="c1">// we deal with a Thing</span>
        <span class="dl">'</span><span class="s1">twin</span><span class="dl">'</span><span class="p">,</span> <span class="c1">// we want to update the twin</span>
        <span class="dl">'</span><span class="s1">commands</span><span class="dl">'</span><span class="p">,</span> <span class="c1">// we want to create a command to update a twin</span>
        <span class="dl">'</span><span class="s1">modify</span><span class="dl">'</span><span class="p">,</span> <span class="c1">// modify the twin</span>
        <span class="dl">'</span><span class="s1">/features</span><span class="dl">'</span><span class="p">,</span> <span class="c1">// modify all features at once</span>
        <span class="nx">headers</span><span class="p">,</span> <span class="c1">// pass through the headers from AMQP 1.0</span>
        <span class="nx">value</span>
    <span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>When your device now sends its payload via the MQTT adapter of Eclipse Hono:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mosquitto_pub <span class="nt">-u</span> <span class="s1">'sensor1@DEFAULT_TENANT'</span> <span class="nt">-P</span> hono-secret <span class="nt">-t</span> telemetry <span class="nt">-m</span> <span class="s1">'{"temp": "23.42 °C","hum": 78,"pres": {"value": 760,"unit": "mmHg"}}'</span>
</code></pre></div></div>

<p>Your digital twin is updated by applying the specified script and extracting the relevant values from the passed <code class="language-plaintext highlighter-rouge">textPayload</code>.</p>

<h3 id="bytes-payload-example">Bytes payload example</h3>

<p>For this example, let’s assume your device sends telemetry data via <a href="https://www.eclipse.org/hono/">Eclipse Hono’s</a> 
HTTP adapter into the cloud. An example payload of your device - displayed as hexadecimal - is:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0x09EF03F72A
</code></pre></div></div>

<p>Let us now also assume that</p>

<ul>
  <li>the first 2 bytes <code class="language-plaintext highlighter-rouge">09 EF</code> represent
    <ul>
      <li>the temperature as 16bit signed integer (thus, may also be negative)</li>
      <li>this is not a float in oder to save space (as float needs at least 32 bit)</li>
    </ul>
  </li>
  <li>the second 2 bytes <code class="language-plaintext highlighter-rouge">03 F7</code> represent the pressure as 16bit signed integer</li>
  <li>the last byte <code class="language-plaintext highlighter-rouge">2A</code> represents the humidity as 8bit unsigned integer of our device.</li>
</ul>

<p>We want to map a single message of this device containing updates for all 3 values to a Thing in the following structure:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"thingId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"the.namespace:the-thing-id"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"policyId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"the.namespace:the-policy-id"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"features"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"temperature"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
       </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
         </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mf">25.43</span><span class="w">
       </span><span class="p">}</span><span class="w">
     </span><span class="p">},</span><span class="w">
    </span><span class="nl">"pressure"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
       </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
         </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mi">1015</span><span class="w">
       </span><span class="p">}</span><span class="w">
     </span><span class="p">},</span><span class="w">
    </span><span class="nl">"humidity"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
       </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
         </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mi">42</span><span class="w">
       </span><span class="p">}</span><span class="w">
     </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Therefore, we define following <code class="language-plaintext highlighter-rouge">incoming</code> mapping function:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nf">mapToDittoProtocolMsg</span><span class="p">(</span>
    <span class="nx">headers</span><span class="p">,</span>
    <span class="nx">textPayload</span><span class="p">,</span>
    <span class="nx">bytePayload</span><span class="p">,</span>
    <span class="nx">contentType</span>
<span class="p">)</span> <span class="p">{</span>
    
    <span class="k">if </span><span class="p">(</span><span class="nx">contentType</span> <span class="o">!==</span> <span class="dl">'</span><span class="s1">application/octet-stream</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="p">;</span> <span class="c1">// only handle messages with content-type application/octet-stream</span>
    <span class="p">}</span>
    
    <span class="kd">let</span> <span class="nx">view</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DataView</span><span class="p">(</span><span class="nx">bytePayload</span><span class="p">);</span>
    
    <span class="kd">let</span> <span class="nx">value</span> <span class="o">=</span> <span class="p">{</span>
        <span class="na">temperature</span><span class="p">:</span> <span class="p">{</span>
            <span class="na">properties</span><span class="p">:</span> <span class="p">{</span>
                <span class="c1">// interpret the first 2 bytes (16 bit) as signed int and divide through 100.0:</span>
                <span class="na">value</span><span class="p">:</span> <span class="nx">view</span><span class="p">.</span><span class="nf">getInt16</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">100.0</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="na">pressure</span><span class="p">:</span> <span class="p">{</span>
            <span class="na">properties</span><span class="p">:</span> <span class="p">{</span>
                <span class="c1">// interpret the next 2 bytes (16 bit) as signed int:</span>
                <span class="na">value</span><span class="p">:</span> <span class="nx">view</span><span class="p">.</span><span class="nf">getInt16</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="na">humidity</span><span class="p">:</span> <span class="p">{</span>
            <span class="na">properties</span><span class="p">:</span> <span class="p">{</span>
                <span class="c1">// interpret the next 1 bytes (8 bit) as unsigned int:</span>
                <span class="na">value</span><span class="p">:</span> <span class="nx">view</span><span class="p">.</span><span class="nf">getUint8</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">};</span>

    <span class="k">return</span> <span class="nx">Ditto</span><span class="p">.</span><span class="nf">buildDittoProtocolMsg</span><span class="p">(</span>
        <span class="dl">'</span><span class="s1">org.eclipse.ditto</span><span class="dl">'</span><span class="p">,</span> <span class="c1">// in this example always the same</span>
        <span class="nx">headers</span><span class="p">[</span><span class="dl">'</span><span class="s1">device_id</span><span class="dl">'</span><span class="p">],</span> <span class="c1">// Eclipse Hono sets the authenticated device_id as AMQP 1.0 header</span>
        <span class="dl">'</span><span class="s1">things</span><span class="dl">'</span><span class="p">,</span> <span class="c1">// we deal with a Thing</span>
        <span class="dl">'</span><span class="s1">twin</span><span class="dl">'</span><span class="p">,</span> <span class="c1">// we want to update the twin</span>
        <span class="dl">'</span><span class="s1">commands</span><span class="dl">'</span><span class="p">,</span> <span class="c1">// we want to create a command to update a twin</span>
        <span class="dl">'</span><span class="s1">modify</span><span class="dl">'</span><span class="p">,</span> <span class="c1">// modify the twin</span>
        <span class="dl">'</span><span class="s1">/features</span><span class="dl">'</span><span class="p">,</span> <span class="c1">// modify all features at once</span>
        <span class="nx">headers</span><span class="p">,</span> <span class="c1">// pass through the headers from AMQP 1.0</span>
        <span class="nx">value</span>
    <span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>When your device now sends its payload via the HTTP adapter of Eclipse Hono:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">echo</span> <span class="nt">-e</span> <span class="k">$((</span><span class="m">0</span>x09EF03F72A<span class="k">))</span> | curl <span class="nt">-i</span> <span class="nt">-X</span> POST <span class="nt">-u</span> sensor1@DEFAULT_TENANT:hono-secret <span class="nt">-H</span> <span class="s1">'Content-Type: application/octet-stream'</span> <span class="nt">--data-binary</span> @- http://127.0.0.1:8080/telemetry
</code></pre></div></div>

<p>Your digital twin is updated by applying the specified script and extracting the relevant values from the passed <code class="language-plaintext highlighter-rouge">bytePayload</code>.</p>

<h2 id="custom-java-based-implementation">Custom Java based implementation</h2>

<p>Beside the JavaScript based mapping - which can be configured/changed at runtime without the need of restarting the
connectivity service - there is also the possibility to implement a custom Java based mapper.</p>

<p>The interface to be implemented is
<a href="https://github.com/eclipse-ditto/ditto/blob/master/connectivity/service/src/main/java/org/eclipse/ditto/connectivity/service/mapping/MessageMapper.java"><code class="language-plaintext highlighter-rouge">MessageMapper</code></a>)
and there is an abstract class <a href="https://github.com/eclipse-ditto/ditto/blob/master/connectivity/service/src/main/java/org/eclipse/ditto/connectivity/service/mapping/AbstractMessageMapper.java"><code class="language-plaintext highlighter-rouge">AbstractMessageMapper</code></a>
which eases implementation of a custom mapper.</p>

<p>Simply extend from <code class="language-plaintext highlighter-rouge">AbstractMessageMapper</code> to provide a custom mapper:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">FooMapper</span> <span class="kd">extends</span> <span class="nc">AbstractMessageMapper</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">MAPPER_ALIAS</span> <span class="o">=</span> <span class="s">"Foo"</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">FooMapper</span><span class="o">(</span><span class="nc">ActorSystem</span> <span class="n">actorSystem</span><span class="o">,</span> <span class="nc">Config</span> <span class="n">config</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">actorSystem</span><span class="o">,</span> <span class="n">config</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nf">FooMapper</span><span class="o">(</span><span class="nc">AbstractMessageMapper</span> <span class="n">copyFromMapper</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">copyFromMapper</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getAlias</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="no">MAPPER_ALIAS</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isConfigurationMandatory</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">MessageMapper</span> <span class="nf">createNewMapperInstance</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">FooMapper</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Adaptable</span><span class="o">&gt;</span> <span class="nf">map</span><span class="o">(</span><span class="nc">ExternalMessage</span> <span class="n">externalMessage</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// TODO implement mapping inbound messages consumed via "sources" to DittoProtocol adaptables</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">DittoHeaders</span> <span class="nf">getAdditionalInboundHeaders</span><span class="o">(</span><span class="nc">ExternalMessage</span> <span class="n">externalMessage</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">DittoHeaders</span><span class="o">.</span><span class="na">empty</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">ExternalMessage</span><span class="o">&gt;</span> <span class="nf">map</span><span class="o">(</span><span class="nc">Adaptable</span> <span class="n">adaptable</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// TODO implement mapping DittoProtocol adaptables to outbound messages published via "targets"</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">doConfigure</span><span class="o">(</span><span class="nc">Connection</span> <span class="n">connection</span><span class="o">,</span> <span class="nc">MappingConfig</span> <span class="n">mappingConfig</span><span class="o">,</span>
            <span class="nc">MessageMapperConfiguration</span> <span class="n">configuration</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// extract configuration if needed</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>After instantiation of the custom <code class="language-plaintext highlighter-rouge">MessageMapper</code>, the <code class="language-plaintext highlighter-rouge">doConfigure</code> method is called with all the <em>options</em> which were 
provided to the mapper in the <a href="connectivity-manage-connections.html#create-connection">configured connection</a>. 
Use them in order to pass in configurations, thresholds, etc.</p>

<p>Then, simply implement both of the <code class="language-plaintext highlighter-rouge">map</code> methods:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">List&lt;Adaptable&gt; map(ExternalMessage message)</code> maps from an incoming external message to
    <ul>
      <li>an empty list of <code class="language-plaintext highlighter-rouge">Adaptable</code>s if the incoming message should be dropped</li>
      <li>a list of one or many <a href="protocol-overview.html">Ditto Protocol</a> <code class="language-plaintext highlighter-rouge">Adaptable</code>s</li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">List&lt;ExternalMessage&gt; map(Adaptable adaptable)</code> maps from an outgoing <a href="protocol-overview.html">Ditto Protocol</a> <code class="language-plaintext highlighter-rouge">Adaptable</code> to
    <ul>
      <li>an empty list of <code class="language-plaintext highlighter-rouge">ExternalMessage</code>s if the outgoing message should be dropped</li>
      <li>a list of one or many external messages</li>
    </ul>
  </li>
</ul>

<p>In order to use this custom Java based mapper implementation, the following steps are required:</p>

<ul>
  <li>the alias has to be defined via the implemented <code class="language-plaintext highlighter-rouge">getAlias()</code> method - it must be unique and <em>should</em> start with an uppercase letter</li>
  <li>if the custom mapper requires mandatory options then implement <code class="language-plaintext highlighter-rouge">isConfigurationMandatory()</code> to return <code class="language-plaintext highlighter-rouge">true</code></li>
  <li>the mapper class needs to be on the classpath of the <a href="architecture-services-connectivity.html">connectivity</a> 
microservice in order to be loaded.<br />
Follow the instructions of 
<a href="installation-extending.html#providing-additional-functionality-by-adding-jars-to-the-classpath">how to extend Ditto</a>
to achieve that.</li>
  <li>the mapper needs to be registered via configuration in the connectivity service, 
<a href="installation-extending.html#adjusting-configuration-of-ditto">extend the configuration</a> or add the mapper via 
<a href="installation-operating.html#ditto-configuration">system properties</a> configuration</li>
  <li>when creating a new connection you have to specify the alias of your mapper as the <code class="language-plaintext highlighter-rouge">mappingEngine</code> in the
connection’s <code class="language-plaintext highlighter-rouge">mappingDefinitions</code> and reference the ID of your mapper in a source or a target</li>
</ul>

<div class="alert alert-success" role="alert"><i class="fa fa-check-square-o"></i> <b>Tip:</b> If your mapper does not require any options (<code class="language-plaintext highlighter-rouge">isConfigurationMandatory() = true</code>), you can
    directly reference the alias in a source or a target without first defining it inside <code class="language-plaintext highlighter-rouge">mappingDefinitions</code>.</div>

<h3 id="example-for-custom-java-based-mapper">Example for Custom Java based mapper</h3>

<p>Please have a look at the following Ditto example project:</p>
<ul>
  <li><a href="https://github.com/eclipse-ditto/ditto-examples/tree/master/custom-ditto-java-payload-mapper">custom-ditto-java-payload-mapper</a></li>
</ul>

<p>This shows how to implement, add and configure a custom, Protobuf based, Java payload mapper for Ditto to use in the
connectivity service for mapping a custom domain specific Protbuf encoded payload.</p>


    <div class="tags">
        
        <b>Tags: </b>
        
        
        
        <a href="tag_connectivity.html" class="btn btn-default navbar-btn cursorNorm" role="button">connectivity</a>
        
        
        
    </div>

</div>

<hr class="shaded"/>

<footer>
            <div class="row">
                <div class="col-lg-12 footer">
                    <div class="logo">
                        <a href="https://eclipse.org"><img src="images/eclipse_foundation_logo.svg" alt="Eclipse logo"/></a>
                    </div>
                    <p class="notice">
                        &copy;2025 Eclipse Ditto™.
                         Site last generated: Feb 26, 2025 <br />
                    </p>
                    <div class="quickLinks">
                        <a href="https://www.eclipse.org/legal/privacy.php" target="_blank">
                            &gt; Privacy Policy
                        </a>
                        <a href="https://www.eclipse.org/legal/termsofuse.php" target="_blank">
                            &gt; Terms of Use
                        </a>
                        <a href="https://www.eclipse.org/legal/copyright.php" target="_blank">
                            &gt; Copyright Agent
                        </a>
                        <a href="https://www.eclipse.org/legal" target="_blank">
                            &gt; Legal
                        </a>
                        <a href="https://www.eclipse.org/legal/epl-2.0/" target="_blank">
                            &gt; License
                        </a>
                        <a href="https://eclipse.org/security" target="_blank">
                            &gt; Report a Vulnerability
                        </a>
                    </div>
                </div>
            </div>
</footer>


        </div>
    <!-- /.row -->
</div>
<!-- /.container -->
</div>
<!-- /#main -->
    </div>

</body>
</html>
