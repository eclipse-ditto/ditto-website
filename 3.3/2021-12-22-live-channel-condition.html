<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="">
<meta name="keywords" content="bloghttp,  ">
<title>  Conditionally direct retrieving API calls to either live or twin channel • Eclipse Ditto™</title>

<link rel="stylesheet" href="css/syntax.css">
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" crossorigin="anonymous">
<link rel="stylesheet" href="css/modern-business.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" crossorigin="anonymous">
<link rel="stylesheet" href="css/customstyles.css">
<link rel="stylesheet" href="css/boxshadowproperties.css">
<link rel="stylesheet" href="css/theme-ditto.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,700|Source+Code+Pro:300,600|Titillium+Web:400,600,700">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/2.0.0/anchor.min.js" crossorigin="anonymous"></script>
<script src="js/toc.js"></script>
<script src="js/customscripts.js"></script>

<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Organization",
  "url": "https://www.eclipse.dev/ditto/",
  "logo": "https://www.eclipse.dev/ditto/images/ditto.svg"
}
</script>

<link rel="icon" type="image/png" href="images/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="images/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="images/favicon-96x96.png" sizes="96x96">

<link rel="alternate" type="application/rss+xml" title="Eclipse Ditto Blog" href="https://www.eclipse.dev/ditto/feed.xml">

<!-- Eclipse Foundation cookie consent: -->
<link rel="stylesheet" type="text/css" href="https://www.eclipse.org/eclipse.org-common/themes/solstice/public/stylesheets/vendor/cookieconsent/cookieconsent.min.css" />
<script src="https://www.eclipse.org/eclipse.org-common/themes/solstice/public/javascript/vendor/cookieconsent/default.min.js"></script>

    <script>
        $(document).ready(function() {
            $("#tg-sb-link").click(function() {
                $("#tg-sb-sidebar").toggle();
                $("#tg-sb-content").toggleClass('col-md-9');
                $("#tg-sb-content").toggleClass('col-md-12');
                $("#tg-sb-icon").toggleClass('fa-toggle-on');
                $("#tg-sb-icon").toggleClass('fa-toggle-off');
            });
        });
    </script>
</head>


<script>
    (function(w,d,s,l,i){
        w[l]=w[l]||[];
        w[l].push({'gtm.start':
            new Date().getTime(),event:'gtm.js'});
        var f=d.getElementsByTagName(s)[0],
            j=d.createElement(s),
            dl=l!='dataLayer'?'&l='+l:'';
        j.async=true;
        j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;
        f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-5WLCZXC');
</script>



<body>
<!-- Navigation -->
<nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container topnavlinks">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-ditto-home" href="index.html">&nbsp;<img src="images/ditto_allwhite_symbolonly.svg" class="ditto-navbar-symbol" alt="Home"> <img src="images/ditto_allwhite_textonly.svg" class="ditto-navbar-symbol-text" alt="Eclipse Ditto™"></a>
        </div>
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <!-- toggle sidebar button -->
                <!--<li><a id="tg-sb-link" href="#"><i id="tg-sb-icon" class="fa fa-toggle-on"></i> Nav</a></li>-->
                <!-- entries without drop-downs appear here -->




                
                
                
                <li><a href="blog.html">Blog</a></li>
                
                
                
                <li><a href="intro-overview.html">Documentation</a></li>
                
                
                
                <li><a href="http-api-doc.html">HTTP API</a></li>
                
                
                
                <li><a href="sandbox.html">Sandbox</a></li>
                
                
                
                  
                  <li><a href="https://github.com/eclipse-ditto/ditto" target="_blank">
                    <img src="images/GitHub-Mark-Light-32px.png" alt="Sources at GitHub">
                  </a></li>
                  
                
                
                
                  
                  <li><a href="https://github.com/eclipse-ditto/ditto-clients" target="_blank">
                    <img src="images/GitHub-Mark-Light-32px.png" alt="SDK sources at GitHub">SDKs
                  </a></li>
                  
                
                
                
                  
                  <li><a href="https://github.com/eclipse-ditto/ditto-examples" target="_blank">
                    <img src="images/GitHub-Mark-Light-32px.png" alt="Example sources at GitHub">examples
                  </a></li>
                  
                
                
                
                <!-- entries with drop-downs appear here -->
                <!-- conditional logic to control which topnav appears for the audience defined in the configuration file.-->
                
                
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Links<b class="caret"></b></a>
                    <ul class="dropdown-menu">
                        
                        
                        <li><a href="https://projects.eclipse.org/projects/iot.ditto" target="_blank">Eclipse Ditto Project</a></li>
                        
                        
                        
                        <li><a href="https://www.eclipse.org/forums/index.php/f/364/" target="_blank">Forum</a></li>
                        
                        
                        
                        <li><a href="https://ci.eclipse.org/ditto/" target="_blank">Jenkins</a></li>
                        
                        
                        
                        <li><a href="https://dev.eclipse.org/mhonarc/lists/ditto-dev/" target="_blank">Mailing list archives</a></li>
                        
                        
                        
                        <li><a href="https://gitter.im/eclipse/ditto" target="_blank">Gitter.im chat</a></li>
                        
                        
                    </ul>
                </li>
                
                
                
                <!--comment out this block if you want to hide search-->
                <li>
                    <!--start search-->
                    <div id="search-demo-container">
                        <input type="text" id="search-input" placeholder="search...">
                        <ul id="results-container"></ul>
                    </div>
                    <script src="https://cdnjs.cloudflare.com/ajax/libs/simple-jekyll-search/0.0.9/jekyll-search.js" type="text/javascript"></script>
                    <script type="text/javascript">
                            SimpleJekyllSearch.init({
                                searchInput: document.getElementById('search-input'),
                                resultsContainer: document.getElementById('results-container'),
                                dataSource: 'search.json',
                                searchResultTemplate: '<li><a href="{url}" title="Conditionally direct retrieving API calls to either live or twin channel">{title}</a></li>',
                                noResultsText: 'No results found.',
                                limit: 10,
                                fuzzy: true,
                    })
                    </script>
                    <!--end search-->
                </li>
            </ul>
        </div>
    </div>
    <!-- /.container -->
</nav>

<!-- Page Content -->
<div class="container">
  <div id="main">
    <!-- Content Row -->
    <div class="row">
        
        

        <!-- Content Column -->
        <div class="col-md-12" id="tg-sb-content">
            <!-- Look the author details up from the site config. -->


<!-- Output author details if some exist. -->
<!-- Output author details if some exist. -->
<!---->
<!--<span>-->
    <!--&lt;!&ndash; Mugshot. &ndash;&gt;-->
    <!--<img src="https://www.gravatar.com/avatar/1993375e06bf8a2b236b5862792a0532?s=135" alt="A photo of Thomas Jäckle" />-->

<!--&lt;!&ndash; Personal Info. &ndash;&gt;-->
    <!--Written by <a href="https://github.com/thjaeckle" target="_blank">Thomas Jäckle</a>-->
<!--</span>-->
<!---->

<article class="post" itemscope itemtype="http://schema.org/BlogPosting">

    <header class="post-header">
        <h1 class="post-title" itemprop="name headline">Conditionally direct retrieving API calls to either live or twin channel</h1>
        <p class="post-meta">Published by <img src="https://www.gravatar.com/avatar/1993375e06bf8a2b236b5862792a0532?s=135" alt="A photo of Thomas Jäckle" style="width:50px;border-radius:50%;display:inline-block;margin-right:5px;" /><span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name"><a href="https://github.com/thjaeckle" target="_blank">Thomas Jäckle</a> </span></span> on <time datetime="2021-12-22T00:00:00+00:00" itemprop="datePublished">Dec 22, 2021</time> - Tags:
            
            
            
            <a href="tag_blog.html">blog</a>, 
            
            
            
            <a href="tag_http.html">http</a>
            
            
            

        </p>


    </header>

    <div class="post-content" itemprop="articleBody">

        

        
        
<!-- this handles the automatic toc. use ## for subheads to auto-generate the on-page minitoc. if you use html tags, you must supply an ID for the heading element in order for it to appear in the minitoc. -->
<script>
$( document ).ready(function() {
  // Handler for .ready() called.

$('#toc').toc({ minimumHeaders: 0, listType: 'ul', showSpeed: 0, headers: 'h2,h3,h4' });

/* this offset helps account for the space taken up by the floating toolbar. */
$('#toc').on('click', 'a', function() {
  var target = $(this.getAttribute('href'))
    , scroll_target = target.offset().top

  $(window).scrollTop(scroll_target - 10);
  return false
})
  
});
</script>

<div id="toc"></div>

        

        <p>After the added option to target the <a href="protocol-twinlive.html#live">live channel</a> by adding the <code class="highlighter-rouge">channel=live</code> to HTTP
requests (see also <a href="2021-12-20-http-live-channel.html">blog post about “HTTP live channel”</a>), Eclipse Ditto 
<strong>version 2.3.0</strong> will in addition support to define a 
<a href="basic-conditional-requests.html#live-channel-condition">live channel condition</a>, which, when evaluating to <code class="highlighter-rouge">true</code>, 
will retrieve data from a device via the live channel, or fall back to the persisted <a href="protocol-twinlive.html#twin">twin</a> 
otherwise.</p>

<div class="alert alert-info" role="alert"><i class="fa fa-info-circle"></i> <b>Note:</b> In order to use the live channel, the device receiving live commands must be able to understand
    and answer in <a href="protocol-specification.html">Ditto Protocol messages</a> with the
<a href="protocol-specification-topic.html#live-channel">topic’s channel being <code class="highlighter-rouge">live</code></a>.</div>

<h2 id="relying-on-conditions">Relying on conditions</h2>

<p>Ditto 2.1.0 added support for <a href="basic-conditional-requests.html">conditional requests</a> by e.g. specifying a <code class="highlighter-rouge">condition</code>
query parameter for HTTP API calls.</p>

<p>This mechanism can now additionally be used to formulate a condition through the query parameter <code class="highlighter-rouge">live-channel-condition</code>
whether data shall be retrieved via the <code class="highlighter-rouge">live</code> channel from the device.</p>

<h2 id="optionally-update-twin-automatically-based-on-retrieved-live-data">Optionally update twin automatically based on retrieved live data</h2>

<p>Whenever a device reports back its actual sensor readings, one can be sure that this data is the most recent “truth”.<br />
It therefore is obvious to use that data in order to update the persisted twin managed by Ditto.</p>

<p>This can optionally be enabled by configuring the new 
<a href="connectivity-mapping.html#updatetwinwithliveresponse-mapper">UpdateTwinWithLiveResponse mapper</a> in a Ditto 
<a href="basic-connections.html">managed connection</a>.<br />
This mapper will transform each “live response” retrieving and transporting data from a device to an additional 
<a href="protocol-specification-things-merge.html">merge command</a> modifying the twin with that <code class="highlighter-rouge">live</code> data.</p>

<h2 id="example-device-is-marked-to-be-polled">Example: Device is marked to be polled</h2>

<p>This is for example helpful if the device does not push its newest sensor readings actively into its twin 
representation managed by Ditto, but relies on being polled for the newest readings.<br />
In that case, the twin could be marked e.g. as <code class="highlighter-rouge">attributes/polling-mode=true</code>:</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="s2">"thingId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"my.namespace:my-polling-device-1"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"policyId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"my.namespace:my-polling-device-1"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="s2">"polling-mode"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="s2">"features"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="s2">"temperature"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="s2">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"value"</span><span class="p">:</span><span class="w"> </span><span class="mf">23.42</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>When an IoT application now needs to retrieve the latest temperature value, it can formulate a query (e.g. in HTTP):</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET /api/2/things/my.namespace:my-polling-device-1/features/temperature/properties/value
  ?live-channel-condition=eq(attributes/polling-mode,true)
  &amp;timeout=10s
  &amp;live-channel-timeout-strategy=use-twin
</code></pre></div></div>

<p>The specified <code class="highlighter-rouge">live-channel-condition</code> will evaluate to <code class="highlighter-rouge">true</code>, meaning that the retrieve is transformed to a 
<a href="protocol-twinlive.html#live">live command</a> and sent to the device, e.g. connected via a 
<a href="basic-connections.html">managed connection</a>.<br />
Upon receiving the “live retrieve” at the device, the device can create a command response correlated with the same
<code class="highlighter-rouge">correlation-id</code> and send it back to Ditto with the current value.<br />
This value is then returned as result of the <code class="highlighter-rouge">GET</code>, the HTTP response header <code class="highlighter-rouge">channel</code> will indicate that the data was
sent by the device by having the value <code class="highlighter-rouge">live</code>.</p>

<p>If the device does not answer with a correctly correlated response within the given <code class="highlighter-rouge">timeout</code>, the request will fall back
to the <a href="protocol-twinlive.html#twin">twin</a> channel, retrieving the data from the last known persisted temperature value 
in the twin managed by Ditto.<br />
The HTTP response header <code class="highlighter-rouge">channel</code> will indicate that the data was received by the persisted twin by having the value 
<code class="highlighter-rouge">twin</code>.</p>

<h2 id="example-device-contains-a-connection-status">Example: Device contains a connection status</h2>

<p>Another perfect fit for that feature is when the device (or the device connectivity layer) is able to reflect the 
connection status of the device in the Ditto managed twin.<br />
When e.g. using <a href="https://www.eclipse.org/hono/">Eclipse Hono</a> in combination with Ditto, the 
<a href="connectivity-mapping.html#connectionstatus-mapper">ConnectionStatus</a> mapper can be configured in a Ditto 
<a href="basic-connections.html">managed connection</a> which will automatically update a <a href="basic-thing.html#features">feature</a> in
the twin based on Hono’s <a href="https://www.eclipse.org/hono/docs/concepts/device-notifications/">device notifications</a> 
reflecting a <code class="highlighter-rouge">"readySince"</code> and <code class="highlighter-rouge">"readyUntil"</code> timestamp:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="s2">"thingId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"my.namespace:my-connection-aware-device-1"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"policyId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"my.namespace:my-connection-aware-device-1"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"features"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="s2">"ConnectionStatus"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="s2">"definition"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">"org.eclipse.ditto:ConnectionStatus:1.0.0"</span><span class="w"> </span><span class="p">],</span><span class="w">
      </span><span class="s2">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"status"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="s2">"readySince"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2021-12-22T14:16:18Z"</span><span class="p">,</span><span class="w">
          </span><span class="s2">"readyUntil"</span><span class="p">:</span><span class="w"> </span><span class="s2">"9999-12-31T23:59:59Z"</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"temperature"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="s2">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"value"</span><span class="p">:</span><span class="w"> </span><span class="mf">23.42</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>In that case, the <code class="highlighter-rouge">"readyUntil"</code> will contain a timestamp how long the device will be ready to receive commands, the 
timestamp <code class="highlighter-rouge">"9999-12-31T23:59:59Z"</code> being an alias for indefinitely (once the device disconnects, e.g. from the MQTT 
adapter of Eclipse Hono, this timestamp will be set to the disconnection time).</p>

<p>Utilizing this “connection awareness”, we can now easily define a query to retrieve data from the real device when it 
is connected and use the persisted <code class="highlighter-rouge">twin</code> when it is not connected or runs into a timeout.<br />
For using the current time as ISO-8601 timestamp, a new placeholder <code class="highlighter-rouge">time:now</code> was also introduced, usable in RQL
expressions everywhere in Ditto:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET /api/2/things/my.namespace:my-connection-aware-device-1/features/temperature/properties/value
  ?live-channel-condition=gt(features/ConnectionStatus/properties/status/readyUntil,time:now)
  &amp;timeout=10s
  &amp;live-channel-timeout-strategy=use-twin
</code></pre></div></div>

<p>Of course every other field in the persisted twin may also be used in the <code class="highlighter-rouge">live-channel-condition</code>, if your devices e.g.
are aware if they are connected or not by other means (e.g. by setting an attribute), this can be utilized as well.</p>

<h2 id="feedback">Feedback?</h2>

<p>Please <a href="feedback.html">get in touch</a> if you have feedback or questions towards this new functionality.</p>

<p><br />
<br /></p>
<figure><img class="docimage" src="images/ditto.svg" alt="Ditto" style="max-width: 500px" /></figure>

<p>–<br /> 
The Eclipse Ditto team</p>

    </div>



</article>

<hr class="shaded"/>

<footer>
            <div class="row">
                <div class="col-lg-12 footer">
                    <div class="logo">
                        <a href="https://eclipse.org"><img src="images/eclipse_foundation_logo.svg" alt="Eclipse logo"/></a>
                    </div>
                    <p class="notice">
                        &copy;2023 Eclipse Ditto™.
                         Site last generated: Jul 21, 2023 <br />
                    </p>
                    <div class="quickLinks">
                        <a href="https://www.eclipse.org/legal/privacy.php" target="_blank">
                            &gt; Privacy Policy
                        </a>
                        <a href="https://www.eclipse.org/legal/termsofuse.php" target="_blank">
                            &gt; Terms of Use
                        </a>
                        <a href="https://www.eclipse.org/legal/copyright.php" target="_blank">
                            &gt; Copyright Agent
                        </a>
                        <a href="https://www.eclipse.org/legal" target="_blank">
                            &gt; Legal
                        </a>
                        <a href="https://www.eclipse.org/legal/epl-2.0/" target="_blank">
                            &gt; License
                        </a>
                        <a href="https://eclipse.org/security" target="_blank">
                            &gt; Report a Vulnerability
                        </a>
                    </div>
                </div>
            </div>
</footer>


        </div>
    <!-- /.row -->
</div>
<!-- /.container -->
</div>
<!-- /#main -->
    </div>

</body>
</html>
