<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="">
<meta name="keywords" content="installation,  operating, docker, docker-compose, devops, logging, logstash, elk, monitoring, prometheus, grafana, tracing, metrics">
<title>  Operating Ditto • Eclipse Ditto™ • a digital twin framework</title>

<link rel="stylesheet" href="css/syntax.css">
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" crossorigin="anonymous">
<link rel="stylesheet" href="css/modern-business.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" crossorigin="anonymous">
<link rel="stylesheet" href="css/customstyles.css">
<link rel="stylesheet" href="css/boxshadowproperties.css">
<link rel="stylesheet" href="css/theme-ditto.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,700|Source+Code+Pro:300,600|Titillium+Web:400,600,700">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/2.1.0/anchor.min.js" crossorigin="anonymous"></script>
<script src="js/toc.js"></script>
<script src="js/customscripts.js"></script>

<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Organization",
  "url": "https://www.eclipse.dev/ditto/",
  "logo": "https://www.eclipse.dev/ditto/images/ditto.svg"
}
</script>

<link rel="icon" type="image/png" href="images/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="images/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="images/favicon-96x96.png" sizes="96x96">

<link rel="alternate" type="application/rss+xml" title="Eclipse Ditto Blog" href="https://www.eclipse.dev/ditto/feed.xml">

<!-- Eclipse Foundation cookie consent: -->
<link rel="stylesheet" type="text/css" href="https://www.eclipse.org/eclipse.org-common/themes/solstice/public/stylesheets/vendor/cookieconsent/cookieconsent.min.css" />
<script src="https://www.eclipse.org/eclipse.org-common/themes/solstice/public/javascript/vendor/cookieconsent/default.min.js"></script>

    <script>
        $(document).ready(function() {
            $("#tg-sb-link").click(function() {
                $("#tg-sb-sidebar").toggle();
                $("#tg-sb-content").toggleClass('col-md-9');
                $("#tg-sb-content").toggleClass('col-md-12');
                $("#tg-sb-icon").toggleClass('fa-toggle-on');
                $("#tg-sb-icon").toggleClass('fa-toggle-off');
            });
        });
    </script>
</head>


<script>
    (function(w,d,s,l,i){
        w[l]=w[l]||[];
        w[l].push({'gtm.start':
            new Date().getTime(),event:'gtm.js'});
        var f=d.getElementsByTagName(s)[0],
            j=d.createElement(s),
            dl=l!='dataLayer'?'&l='+l:'';
        j.async=true;
        j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;
        f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-5WLCZXC');
</script>



<body>
<!-- Navigation -->
<nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container topnavlinks">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-ditto-home" href="index.html">&nbsp;<img src="images/ditto_allwhite_symbolonly.svg" class="ditto-navbar-symbol" alt="Home"> <img src="images/ditto_allwhite_textonly.svg" class="ditto-navbar-symbol-text" alt="Eclipse Ditto™"></a>
        </div>
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <!-- toggle sidebar button -->
                <!--<li><a id="tg-sb-link" href="#"><i id="tg-sb-icon" class="fa fa-toggle-on"></i> Nav</a></li>-->
                <!-- entries without drop-downs appear here -->




                
                
                
                <li><a href="blog.html">Blog</a></li>
                
                
                
                <li><a href="intro-overview.html">Documentation</a></li>
                
                
                
                <li><a href="http-api-doc.html">HTTP API</a></li>
                
                
                
                <li><a href="sandbox.html">Sandbox</a></li>
                
                
                
                  
                  <li><a href="https://github.com/eclipse-ditto/ditto" target="_blank">
                    <img src="images/GitHub-Mark-Light-32px.png" alt="Sources at GitHub">
                  </a></li>
                  
                
                
                
                  
                  <li><a href="https://github.com/eclipse-ditto/ditto-clients" target="_blank">
                    <img src="images/GitHub-Mark-Light-32px.png" alt="SDK sources at GitHub">SDKs
                  </a></li>
                  
                
                
                
                  
                  <li><a href="https://github.com/eclipse-ditto/ditto-examples" target="_blank">
                    <img src="images/GitHub-Mark-Light-32px.png" alt="Example sources at GitHub">examples
                  </a></li>
                  
                
                
                
                <!-- entries with drop-downs appear here -->
                <!-- conditional logic to control which topnav appears for the audience defined in the configuration file.-->
                
                
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Links<b class="caret"></b></a>
                    <ul class="dropdown-menu">
                        
                        
                        <li><a href="https://projects.eclipse.org/projects/iot.ditto" target="_blank">Eclipse Ditto Project</a></li>
                        
                        
                        
                        <li><a href="https://www.eclipse.org/forums/index.php/f/364/" target="_blank">Forum</a></li>
                        
                        
                        
                        <li><a href="https://ci.eclipse.org/ditto/" target="_blank">Jenkins</a></li>
                        
                        
                        
                        <li><a href="https://dev.eclipse.org/mhonarc/lists/ditto-dev/" target="_blank">Mailing list archives</a></li>
                        
                        
                        
                        <li><a href="https://gitter.im/eclipse/ditto" target="_blank">Gitter.im chat</a></li>
                        
                        
                    </ul>
                </li>
                
                
                
                <!--comment out this block if you want to hide search-->
                <li>
                    <!--start search-->
                    <div id="search-demo-container">
                        <input type="text" id="search-input" placeholder="search...">
                        <ul id="results-container"></ul>
                    </div>
                    <script src="https://cdnjs.cloudflare.com/ajax/libs/simple-jekyll-search/0.0.9/jekyll-search.js" type="text/javascript"></script>
                    <script type="text/javascript">
                            SimpleJekyllSearch.init({
                                searchInput: document.getElementById('search-input'),
                                resultsContainer: document.getElementById('results-container'),
                                dataSource: 'search.json',
                                searchResultTemplate: '<li><a href="{url}" title="Operating Ditto">{title}</a></li>',
                                noResultsText: 'No results found.',
                                limit: 10,
                                fuzzy: true,
                    })
                    </script>
                    <!--end search-->
                </li>
            </ul>
        </div>
    </div>
    <!-- /.container -->
</nav>

<!-- Page Content -->
<div class="container">
  <div id="main">
    <!-- Content Row -->
    <div class="row">
        
        
            <!-- Sidebar Column -->
            <div class="col-md-3" id="tg-sb-sidebar">
                

<ul id="mysidebar" class="nav">
  <li class="sidebarTitle">
    <label for="docVersion">Eclipse Ditto™ version:</label>
    <div class="select-wrapper">
      <select id="docVersion" name="docVersion">
        
        <option value="">development</option>
        
        <option value="3.7">3.7</option>
        
        <option value="3.6">3.6</option>
        
        <option value="3.5">3.5</option>
        
        <option value="3.4">3.4</option>
        
        <option value="3.3">3.3</option>
        
        <option value="3.2">3.2</option>
        
        <option value="3.1">3.1</option>
        
        <option value="3.0">3.0</option>
        
        <option value="2.4">2.4</option>
        
      </select>
    </div>
    <div id="dev-warning">
      <div markdown="span" class="alert alert-warning" role="alert" style="font-size:0.6em"><i class="fa fa-warning"></i> <b>Important:</b> This documentation reflects the latest 'development'. You might want to choose a released version.</div>
    </div>
  </li>
  
  
  
    
        <li class="subfolders">
          <a href="#"><span></span>Introduction</a>
          <ul>
              
              
              
              <li><a href="intro-overview.html">Overview</a></li>
              
              
              
              
              
              
              <li><a href="intro-digitaltwins.html">Digital twins</a></li>
              
              
              
              
              
              
              <li><a href="intro-hello-world.html">Hello world</a></li>
              
              
              
              
          </ul>
        </li>
    
  
  
  
    
        <li class="subfolders">
          <a href="#"><span></span>Release Notes</a>
          <ul>
              
              
              
              <li><a href="release_notes_372.html">3.7.2</a></li>
              
              
              
              
              
              
              <li><a href="release_notes_371.html">3.7.1</a></li>
              
              
              
              
              
              
              <li><a href="release_notes_370.html">3.7.0</a></li>
              
              
              
              
              
              
              <li><a href="release_notes_3611.html">3.6.11</a></li>
              
              
              
              
              
              
              <li><a href="release_notes_3610.html">3.6.10</a></li>
              
              
              
              
              
              
              <li><a href="release_notes_369.html">3.6.9</a></li>
              
              
              
              
              
              
              <li><a href="release_notes_368.html">3.6.8</a></li>
              
              
              
              
              
              
              <li><a href="release_notes_367.html">3.6.7</a></li>
              
              
              
              
              
              
              <li><a href="release_notes_365.html">3.6.5</a></li>
              
              
              
              
              
              
              <li><a href="release_notes_364.html">3.6.4</a></li>
              
              
              
              
              
              
              <li><a href="release_notes_363.html">3.6.3</a></li>
              
              
              
              
              
              
              <li><a href="release_notes_362.html">3.6.2</a></li>
              
              
              
              
              
              
              <li><a href="release_notes_361.html">3.6.1</a></li>
              
              
              
              
              
              
              <li><a href="release_notes_360.html">3.6.0</a></li>
              
              
              
              <li class="subfolders">
                  <a href="#"><span></span>Archive</a>
                  <ul>
                      
                      
                      
                      <li><a href="release_notes_3512.html">3.5.12</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_3511.html">3.5.11</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_3510.html">3.5.10</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_359.html">3.5.9</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_358.html">3.5.8</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_357.html">3.5.7</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_356.html">3.5.6</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_355.html">3.5.5</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_354.html">3.5.4</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_353.html">3.5.3</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_352.html">3.5.2</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_351.html">3.5.1</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_350.html">3.5.0</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_345.html">3.4.5</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_344.html">3.4.4</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_343.html">3.4.3</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_342.html">3.4.2</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_341.html">3.4.1</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_340.html">3.4.0</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_337.html">3.3.7</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_336.html">3.3.6</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_335.html">3.3.5</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_334.html">3.3.4</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_333.html">3.3.3</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_332.html">3.3.2</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_330.html">3.3.0</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_321.html">3.2.1</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_320.html">3.2.0</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_312.html">3.1.2</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_311.html">3.1.1</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_310.html">3.1.0</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_300.html">3.0.0</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_242.html">2.4.2</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_241.html">2.4.1</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_240.html">2.4.0</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_232.html">2.3.2</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_231.html">2.3.1</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_230.html">2.3.0</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_222.html">2.2.2</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_221.html">2.2.1</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_220.html">2.2.0</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_213.html">2.1.3</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_212.html">2.1.2</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_211.html">2.1.1</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_210.html">2.1.0</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_201.html">2.0.1</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_200.html">2.0.0</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_151.html">1.5.1</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_150.html">1.5.0</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_140.html">1.4.0</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_130.html">1.3.0</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_121.html">1.2.1</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_120.html">1.2.0</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_115.html">1.1.5</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_113.html">1.1.3</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_112.html">1.1.2</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_111.html">1.1.1</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_110.html">1.1.0</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_100.html">1.0.0</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_090.html">0.9.0</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_080.html">0.8.0</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_100-M2.html">1.0.0-M2</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_100-M1a.html">1.0.0-M1a</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_090-M2.html">0.9.0-M2</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_090-M1.html">0.9.0-M1</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_080-M3.html">0.8.0-M3</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_080-M2.html">0.8.0-M2</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_080-M1.html">0.8.0-M1</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_030-M2.html">0.3.0-M2</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_030-M1.html">0.3.0-M1</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_020-M1.html">0.2.0-M1</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_010-M3.html">0.1.0-M3</a></li>
                      
                      
                      
                      
                      
                      <li><a href="release_notes_010-M1.html">0.1.0-M1</a></li>
                      
                      
                      
                  </ul>
              </li>
              
              
              
              
          </ul>
        </li>
    
  
  
  
    
        <li class="subfolders">
          <a href="#"><span></span>Installation</a>
          <ul>
              
              
              
              <li><a href="installation-building.html">Building Ditto</a></li>
              
              
              
              
              
              
              <li><a href="installation-running.html">Running Ditto</a></li>
              
              
              
              
              
              
              <li class="active"><a href="installation-operating.html">Operating Ditto</a></li>
              
              
              
              
              
              
              <li><a href="installation-extending.html">Extending Ditto</a></li>
              
              
              
              
          </ul>
        </li>
    
  
  
  
    
        <li class="subfolders">
          <a href="#"><span></span>Basic concepts</a>
          <ul>
              
              
              
              <li><a href="basic-overview.html">Overview</a></li>
              
              
              
              <li class="subfolders">
                  <a href="#"><span></span>Model entities</a>
                  <ul>
                      
                      
                      
                      <li><a href="basic-thing.html">Thing</a></li>
                      
                      
                      
                      
                      
                      <li><a href="basic-feature.html">Feature</a></li>
                      
                      
                      
                      
                      
                      <li><a href="basic-policy.html">Policy</a></li>
                      
                      
                      
                      
                      
                      <li><a href="basic-namespaces-and-names.html">Namespaces and Names</a></li>
                      
                      
                      
                      
                      
                      <li><a href="basic-metadata.html">Thing Metadata</a></li>
                      
                      
                      
                      
                      
                      <li><a href="basic-errors.html">Errors</a></li>
                      
                      
                      
                  </ul>
              </li>
              
              
              
              
              
              
              <li><a href="basic-auth.html">Authentication and Authorization</a></li>
              
              
              
              <li class="subfolders">
                  <a href="#"><span></span>Checking Permissions for Resources</a>
                  <ul>
                      
                  </ul>
              </li>
              
              
              
              
              
              
              <li><a href="basic-messages.html">Messages</a></li>
              
              
              
              
              
              
              <li><a href="basic-signals.html">Signals</a></li>
              
              
              
              <li class="subfolders">
                  <a href="#"><span></span>Signal types</a>
                  <ul>
                      
                      
                      
                      <li><a href="basic-signals-command.html">Command</a></li>
                      
                      
                      
                      
                      
                      <li><a href="basic-signals-commandresponse.html">Command response</a></li>
                      
                      
                      
                      
                      
                      <li><a href="basic-signals-errorresponse.html">Error response</a></li>
                      
                      
                      
                      
                      
                      <li><a href="basic-signals-event.html">Event</a></li>
                      
                      
                      
                      
                      
                      <li><a href="basic-signals-announcement.html">Announcement</a></li>
                      
                      
                      
                      
                      
                      <li><a href="basic-enrichment.html">Signal enrichment</a></li>
                      
                      
                      
                  </ul>
              </li>
              
              
              
              
              
              
              <li><a href="basic-apis.html">APIs</a></li>
              
              
              
              
              
              
              <li><a href="basic-connections.html">Connections</a></li>
              
              
              
              
              
              
              <li><a href="basic-placeholders.html">Placeholders</a></li>
              
              
              
              
              
              
              <li><a href="basic-changenotifications.html">Change notifications</a></li>
              
              
              
              
              
              
              <li><a href="basic-rql.html">RQL expressions</a></li>
              
              
              
              
              
              
              <li><a href="basic-conditional-requests.html">Conditional requests</a></li>
              
              
              
              
              
              
              <li><a href="basic-search.html">Search</a></li>
              
              
              
              
              
              
              <li><a href="basic-history.html">History capabilities</a></li>
              
              
              
              
              
              
              <li><a href="basic-acknowledgements.html">Acknowledgements / QoS</a></li>
              
              
              
              <li class="subfolders">
                  <a href="#"><span></span>WoT (Web of Things)</a>
                  <ul>
                      
                      
                      
                      <li><a href="basic-wot-integration.html">WoT integration</a></li>
                      
                      
                      
                      
                      
                      <li><a href="basic-wot-integration-example.html">WoT integration example</a></li>
                      
                      
                      
                  </ul>
              </li>
              
              
              
              
          </ul>
        </li>
    
  
  
  
    
        <li class="subfolders">
          <a href="#"><span></span>Advanced concepts</a>
          <ul>
              
              
              
              <li><a href="advanced-data-by-pass.html">Data By-Pass</a></li>
              
              
              
              
          </ul>
        </li>
    
  
  
  
    
        <li class="subfolders">
          <a href="#"><span></span>Architecture</a>
          <ul>
              
              
              
              <li><a href="architecture-overview.html">Overview</a></li>
              
              
              
              <li class="subfolders">
                  <a href="#"><span></span>Services</a>
                  <ul>
                      
                      
                      
                      <li><a href="architecture-services-policies.html">Policies</a></li>
                      
                      
                      
                      
                      
                      <li><a href="architecture-services-things.html">Things</a></li>
                      
                      
                      
                      
                      
                      <li><a href="architecture-services-things-search.html">Things-Search</a></li>
                      
                      
                      
                      
                      
                      <li><a href="architecture-services-connectivity.html">Connectivity</a></li>
                      
                      
                      
                      
                      
                      <li><a href="architecture-services-gateway.html">Gateway</a></li>
                      
                      
                      
                  </ul>
              </li>
              
              
              
              
          </ul>
        </li>
    
  
  
  
    
        <li class="subfolders">
          <a href="#"><span></span>HTTP API</a>
          <ul>
              
              
              
              <li><a href="httpapi-overview.html">Overview</a></li>
              
              
              
              
              
              
              <li><a href="httpapi-concepts.html">Concepts</a></li>
              
              
              
              
              
              
              <li><a href="httpapi-search.html">Search</a></li>
              
              
              
              
              
              
              <li><a href="httpapi-messages.html">Messages</a></li>
              
              
              
              
              
              
              <li><a href="httpapi-protocol-bindings-websocket.html">WebSocket protocol binding</a></li>
              
              
              
              
              
              
              <li><a href="httpapi-protocol-bindings-cloudevents.html">Cloud Events HTTP protocol binding</a></li>
              
              
              
              
              
              
              <li><a href="httpapi-sse.html">Server sent events</a></li>
              
              
              
              
          </ul>
        </li>
    
  
  
  
    
        <li class="subfolders">
          <a href="#"><span></span>Connectivity API</a>
          <ul>
              
              
              
              <li><a href="connectivity-overview.html">Overview</a></li>
              
              
              
              <li class="subfolders">
                  <a href="#"><span></span>Manage connections</a>
                  <ul>
                      
                      
                      
                      <li><a href="connectivity-manage-connections.html">via HTTP API</a></li>
                      
                      
                      
                      
                      
                      <li><a href="connectivity-manage-connections-piggyback.html">via Piggyback commands</a></li>
                      
                      
                      
                  </ul>
              </li>
              
              
              
              
              
              
              <li><a href="connectivity-protocol-bindings-amqp091.html">AMQP 0.9.1 protocol binding</a></li>
              
              
              
              
              
              
              <li><a href="connectivity-protocol-bindings-amqp10.html">AMQP 1.0 protocol binding</a></li>
              
              
              
              
              
              
              <li><a href="connectivity-protocol-bindings-mqtt.html">MQTT 3.1.1 protocol binding</a></li>
              
              
              
              
              
              
              <li><a href="connectivity-protocol-bindings-mqtt5.html">MQTT 5 protocol binding</a></li>
              
              
              
              
              
              
              <li><a href="connectivity-protocol-bindings-http.html">HTTP 1.1 protocol binding</a></li>
              
              
              
              
              
              
              <li><a href="connectivity-protocol-bindings-kafka2.html">Kafka 2.x protocol binding</a></li>
              
              
              
              
              
              
              <li><a href="connectivity-protocol-bindings-hono.html">Hono connection binding</a></li>
              
              
              
              
              
              
              <li><a href="connectivity-mapping.html">Payload mapping</a></li>
              
              
              
              
              
              
              <li><a href="connectivity-header-mapping.html">Header mapping</a></li>
              
              
              
              
              
              
              <li><a href="connectivity-tls-certificates.html">TLS certificates</a></li>
              
              
              
              
              
              
              <li><a href="connectivity-ssh-tunneling.html">SSH tunneling</a></li>
              
              
              
              
              
              
              <li><a href="connectivity-hmac-signing.html">HMAC signing</a></li>
              
              
              
              
          </ul>
        </li>
    
  
  
  
    
        <li class="subfolders">
          <a href="#"><span></span>Client SDK</a>
          <ul>
              
              
              
              <li><a href="client-sdk-overview.html">Overview</a></li>
              
              
              
              
              
              
              <li><a href="client-sdk-java.html">Java</a></li>
              
              
              
              
              
              
              <li><a href="client-sdk-javascript.html">JavaScript</a></li>
              
              
              
              
          </ul>
        </li>
    
  
  
  
    
        <li class="subfolders">
          <a href="#"><span></span>Ditto Protocol</a>
          <ul>
              
              
              
              <li><a href="protocol-overview.html">Overview</a></li>
              
              
              
              
              
              
              <li><a href="protocol-twinlive.html">Twin/live channel</a></li>
              
              
              
              
              
              
              <li><a href="protocol-specification.html">Specification</a></li>
              
              
              
              
              
              
              <li><a href="protocol-specification-topic.html">Protocol topic</a></li>
              
              
              
              
              
              
              <li><a href="protocol-specification-errors.html">Errors</a></li>
              
              
              
              
              
              
              <li><a href="protocol-specification-things.html">Things group</a></li>
              
              
              
              <li class="subfolders">
                  <a href="#"><span></span>→ commands/events</a>
                  <ul>
                      
                      
                      
                      <li><a href="protocol-specification-things-create-or-modify.html">Create/Modify</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-specification-things-merge.html">Merge</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-specification-things-retrieve.html">Retrieve</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-specification-things-delete.html">Delete</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-specification-acks.html">Acknowledgements</a></li>
                      
                      
                      
                  </ul>
              </li>
              
              
              
              <li class="subfolders">
                  <a href="#"><span></span>→ search/messages</a>
                  <ul>
                      
                      
                      
                      <li><a href="protocol-specification-things-search.html">Search</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-specification-things-messages.html">Messages</a></li>
                      
                      
                      
                  </ul>
              </li>
              
              
              
              
              
              
              <li><a href="protocol-specification-policies.html">Policies group</a></li>
              
              
              
              <li class="subfolders">
                  <a href="#"><span></span>→ commands/announcements</a>
                  <ul>
                      
                      
                      
                      <li><a href="protocol-specification-policies-create-or-modify.html">Create/Modify</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-specification-policies-retrieve.html">Retrieve</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-specification-policies-delete.html">Delete</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-specification-policies-announcement.html">Announcement</a></li>
                      
                      
                      
                  </ul>
              </li>
              
              
              
              
              
              
              <li><a href="protocol-specification-connections.html">Connections group</a></li>
              
              
              
              <li class="subfolders">
                  <a href="#"><span></span>→ announcements</a>
                  <ul>
                      
                      
                      
                      <li><a href="protocol-specification-connections-announcement.html">Announcement</a></li>
                      
                      
                      
                  </ul>
              </li>
              
              
              
              
              
              
              <li><a href="protocol-specification-streaming-subscription.html">Streaming subscriptions (history)</a></li>
              
              
              
              
              
              
              <li><a href="protocol-bindings.html">Bindings</a></li>
              
              
              
              
              
              
              <li><a href="protocol-examples.html">Examples</a></li>
              
              
              
              <li class="subfolders">
                  <a href="#"><span></span>→ Things examples</a>
                  <ul>
                      
                      
                      
                      <li><a href="protocol-examples-creatething.html">Create a Thing</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-deletething.html">Delete a Thing</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-modifything.html">Modify a Thing</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-retrievething.html">Retrieve a Thing</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-retrievethings.html">Retrieve multiple Things</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-modifypolicyid.html">Modify the Policy ID of a Thing</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-createattributes.html">Create Attributes</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-deleteattributes.html">Delete Attributes</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-modifyattributes.html">Modify Attributes</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-retrieveattributes.html">Retrieve Attributes</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-createattribute.html">Create a single Attribute</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-deleteattribute.html">Delete a single Attribute</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-modifyattribute.html">Modify a single Attribute</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-retrieveattribute.html">Retrieve a single Attribute</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-createthingdefinition.html">Create a Definition</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-deletethingdefinition.html">Delete a Definition</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-modifythingdefinition.html">Modify a Definition</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-retrievethingdefinition.html">Retrieve a Definition</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-createfeatures.html">Create Features</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-deletefeatures.html">Delete Features</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-modifyfeatures.html">Modify Features</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-retrievefeatures.html">Retrieve Features</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-createfeature.html">Create a single Feature</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-deletefeature.html">Delete a single Feature</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-modifyfeature.html">Modify a single Feature</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-retrievefeature.html">Retrieve a single Feature</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-createdefinition.html">Create Feature Definition</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-deletedefinition.html">Delete Feature Definition</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-modifydefinition.html">Modify Feature Definition</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-retrievedefinition.html">Retrieve Feature Definition</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-createproperties.html">Create Feature Properties</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-deleteproperties.html">Delete Feature Properties</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-modifyproperties.html">Modify Feature Properties</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-retrieveproperties.html">Retrieve Feature Properties</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-createproperty.html">Create a single Property</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-deleteproperty.html">Delete a single Property</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-modifyproperty.html">Modify a single Property</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-retrieveproperty.html">Retrieve a single Property</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-createdesiredproperties.html">Create desired Feature Properties</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-deletedesiredproperties.html">Delete desired Feature Properties</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-modifydesiredproperties.html">Modify desired Feature Properties</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-retrievedesiredproperties.html">Retrieve desired Feature Properties</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-createdesiredproperty.html">Create a single desired Property</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-deletedesiredproperty.html">Delete a single desired Property</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-modifydesiredproperty.html">Modify a single desired Property</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-retrievedesiredproperty.html">Retrieve a single desired Property</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-errorresponses.html">Error responses</a></li>
                      
                      
                      
                  </ul>
              </li>
              
              
              
              <li class="subfolders">
                  <a href="#"><span></span>→ Things merge examples</a>
                  <ul>
                      
                      
                      
                      <li><a href="protocol-examples-mergething.html">Merge a Thing</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-mergepolicyid.html">Merge the Policy ID of a Thing</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-mergeattributes.html">Merge Attributes</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-mergeattribute.html">Merge a single Attribute</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-mergethingdefinition.html">Merge a Definition</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-mergefeatures.html">Merge Features</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-mergefeature.html">Merge a single Feature</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-mergefeaturedefinition.html">Merge Feature Definition</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-mergeproperties.html">Merge Feature Properties</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-mergeproperty.html">Merge a single Property</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-mergedesiredproperties.html">Merge desired Feature Properties</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-mergedesiredproperty.html">Merge a single desired Property</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-errorresponses.html">Error responses</a></li>
                      
                      
                      
                  </ul>
              </li>
              
              
              
              <li class="subfolders">
                  <a href="#"><span></span>→ Policies examples</a>
                  <ul>
                      
                      
                      
                      <li><a href="protocol-examples-policies-createpolicy.html">Create a Policy</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-policies-deletepolicy.html">Delete a Policy</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-policies-modifypolicy.html">Modify a Policy</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-policies-retrievepolicy.html">Retrieve a Policy</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-policies-modifypolicyentries.html">Modify entries</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-policies-retrievepolicyentries.html">Retrieve entries</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-policies-createpolicyentry.html">Create a single entry</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-policies-deletepolicyentry.html">Delete a single entry</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-policies-modifypolicyentry.html">Modify a single entry</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-policies-retrievepolicyentry.html">Retrieve a single entry</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-policies-modifysubjects.html">Modify subjects</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-policies-retrievesubjects.html">Retrieve subjects</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-policies-createsubject.html">Create a single subject</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-policies-deletesubject.html">Delete a single subject</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-policies-modifysubject.html">Modify a single subject</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-policies-retrievesubject.html">Retrieve a single subject</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-policies-modifyresources.html">Modify resources</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-policies-retrieveresources.html">Retrieve resources</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-policies-createresource.html">Create a single resource</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-policies-deleteresource.html">Delete a single resource</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-policies-modifyresource.html">Modify a single resource</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-policies-retrieveresource.html">Retrieve a single resource</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-policies-modifyimports.html">Modify policy imports</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-policies-retrieveimports.html">Retrieve policy imports</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-policies-deleteimport.html">Delete a single policy import</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-policies-modifyimport.html">Modify a single policy import</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-policies-retrieveimport.html">Retrieve a single policy import</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-policies-errorresponses.html">Error responses</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-policies-announcement-subjectDeletion.html">Announcement for subject deletion</a></li>
                      
                      
                      
                  </ul>
              </li>
              
              
              
              <li class="subfolders">
                  <a href="#"><span></span>→ Connections examples</a>
                  <ul>
                      
                      
                      
                      <li><a href="protocol-examples-connections-announcement-opened.html">Announcement for connection opened</a></li>
                      
                      
                      
                      
                      
                      <li><a href="protocol-examples-connections-announcement-closed.html">Announcement for connection gracefully closed</a></li>
                      
                      
                      
                  </ul>
              </li>
              
              
              
              
              
              
              <li><a href="protocol-examples-search.html">→ Search examples</a></li>
              
              
              
              
          </ul>
        </li>
    
  
  
  
    
    <li><a href="user-interface.html">User Interface</a></li>
    
  
  
  
    
    <li><a href="sandbox.html">Sandbox</a></li>
    
  
  
  
    
    <li><a href="presentations.html">Presentations</a></li>
    
  
  
  
    
    <li><a href="glossary.html">Glossary</a></li>
    
  
  
  
    
    <li><a href="feedback.html">Feedback</a></li>
    
  
  
  
    
         <p class="external">
             <a href="#" id="collapseAll">Collapse All</a> | <a href="#" id="expandAll">Expand All</a>
         </p>
    
</ul>

<!-- this highlights the active parent class in the sidebar. this is critical so that the parent expands when you're viewing a page. This must appear below the sidebar code above. Otherwise, if placed inside customscripts.js, the script runs before the sidebar code runs and the class never gets inserted.-->
<script>$("li.active").parents('li').toggleClass("active");
</script>

            </div>
            
        

        <!-- Content Column -->
        <div class="col-md-9" id="tg-sb-content">
            <div class="post-header">
   <h1 class="post-title-main">Operating Ditto</h1>
</div>



<div class="post-content">

   

    
    
<!-- this handles the automatic toc. use ## for subheads to auto-generate the on-page minitoc. if you use html tags, you must supply an ID for the heading element in order for it to appear in the minitoc. -->
<script>
$( document ).ready(function() {
  // Handler for .ready() called.

$('#toc').toc({ minimumHeaders: 0, listType: 'ul', showSpeed: 0, headers: 'h2,h3,h4' });

/* this offset helps account for the space taken up by the floating toolbar. */
$('#toc').on('click', 'a', function() {
  var target = $(this.getAttribute('href'))
    , scroll_target = target.offset().top

  $(window).scrollTop(scroll_target - 10);
  return false
})
  
});
</script>

<div id="toc"></div>

    


    
    

    <a target="_blank" href="https://github.com/eclipse/ditto/edit/master/documentation/src/main/resources/pages/ditto/installation-operating.md" class="btn btn-default githubEditButton" role="button"><i class="fa fa-github fa-lg"></i> Edit this page</a>

    
    


    

  
<p>Once you have successfully started Ditto, proceed with setting it up for continuous operation.</p>

<p>This page shows the basics for operating Ditto.</p>

<h2 id="configuration">Configuration</h2>

<p>Ditto has many config parameters which can be set in the config files or via environment variables.
This section will cover some of Ditto’s config parameters.</p>

<h3 id="mongodb-configuration">MongoDB configuration</h3>
<p>If you choose not to use the MongoDB container and instead use a dedicated MongoDB you can use
the following environment variables in order to configure the connection to the MongoDB.</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">MONGO_DB_URI</code>: Connection string to MongoDB</li>
  <li><code class="language-plaintext highlighter-rouge">MONGO_DB_SSL_ENABLED</code>: Enabled SSL connection to MongoDB</li>
  <li><code class="language-plaintext highlighter-rouge">MONGO_DB_CONNECTION_MIN_POOL_SIZE</code>: Configure MongoDB minimum connection pool size</li>
  <li><code class="language-plaintext highlighter-rouge">MONGO_DB_CONNECTION_POOL_SIZE</code>: Configure MongoDB connection pool size</li>
  <li><code class="language-plaintext highlighter-rouge">MONGO_DB_READ_PREFERENCE</code>: Configure MongoDB read preference</li>
  <li><code class="language-plaintext highlighter-rouge">MONGO_DB_WRITE_CONCERN</code>: Configure MongoDB write concern</li>
  <li><code class="language-plaintext highlighter-rouge">PEKKO_PERSISTENCE_MONGO_JOURNAL_WRITE_CONCERN</code>: Configure Pekko Persistence MongoDB journal write concern</li>
  <li><code class="language-plaintext highlighter-rouge">PEKKO_PERSISTENCE_MONGO_SNAPS_WRITE_CONCERN</code>: Configure Pekko Persistence MongoDB snapshot write concern</li>
</ul>

<h4 id="passwordless-authentication-at-mongodb-via-aws-iam">Passwordless authentication at MongoDB via AWS IAM</h4>

<p>Starting with Ditto <code class="language-plaintext highlighter-rouge">3.6.0</code>, it is possible to <a href="https://www.mongodb.com/docs/atlas/security/aws-iam-authentication/">set up authentication with AWS IAM</a>.</p>

<p>To enable this:</p>
<ol>
  <li>configure your Kubernetes serviceaccount with the role ARN via annotation <code class="language-plaintext highlighter-rouge">eks.amazonaws.com/role-arn</code></li>
  <li>configure Ditto’s services to assume that role during MongoDB authentication
    <ol>
      <li>either via environment variables:
        <ul>
          <li><code class="language-plaintext highlighter-rouge">MONGO_DB_USE_AWS_IAM_ROLE</code>: boolean configuring whether to use AWS IAM roles for authentication with MongoDB</li>
          <li><code class="language-plaintext highlighter-rouge">MONGO_DB_AWS_REGION</code>: string specifying the AWS region</li>
          <li><code class="language-plaintext highlighter-rouge">MONGO_DB_AWS_ROLE_ARN</code>: string specifying the ARN of the AWS IAM Role to be assumed for MongoDB authentication</li>
          <li><code class="language-plaintext highlighter-rouge">MONGO_DB_AWS_SESSION_NAME</code>: string the AWS session name to be used when assuming the IAM role</li>
        </ul>
      </li>
      <li>or - when using the Helm chart - via <code class="language-plaintext highlighter-rouge">values.yaml</code>
        <ul>
          <li>below <code class="language-plaintext highlighter-rouge">serviceAccount</code> key in order to annotate the k8s serviceaccount with the role ARN to assume</li>
          <li>below <code class="language-plaintext highlighter-rouge">dbconfig</code> key for each individual Ditto service</li>
        </ul>
      </li>
    </ol>
  </li>
</ol>

<h4 id="mongodb-tuning">MongoDB tuning</h4>

<p>This section contains known aspects when/how to tune Ditto working with MongoDB.</p>

<h5 id="background-aggregation-queries">Background aggregation queries</h5>

<p>Ditto runs several “background” queries against MongoDB (e.g. in order to clean up data in the background, 
depending on the current load to the DB) using <code class="language-plaintext highlighter-rouge">aggregate</code>.<br />
This mainly is done on the “snapshot” collections, e.g. <code class="language-plaintext highlighter-rouge">things_snaps</code>, <code class="language-plaintext highlighter-rouge">policies_snaps</code>, <code class="language-plaintext highlighter-rouge">connections_snaps</code>.</p>

<h6 id="mongodb-5">MongoDB 5</h6>

<p>In MongoDB 5, the default settings of Ditto work just fine - the MongoDB <code class="language-plaintext highlighter-rouge">aggregate</code> queries run quick enough and do
not cause much disk read operations.</p>

<h6 id="mongodb-6">MongoDB 6</h6>

<p>In MongoDB 6 however, the <code class="language-plaintext highlighter-rouge">aggregate</code> queries Ditto does to the snapshot collections drastically slowed down with much
data in the snapshot stores.<br />
If you encounter poor query performance and e.g. a lot of additional “disk read IOPS”, you are also affected by this
issue. In that case, there are options in Ditto to enable creation of additional indexes which speed up the aggregation 
queries to a comparable level than with MongoDB 5.</p>

<p>The following environment variables can be enabled to create those indexes:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">MONGODB_READ_JOURNAL_SHOULD_CREATE_ADDITIONAL_SNAPSHOT_AGGREGATION_INDEX_PID_ID</code>: <code class="language-plaintext highlighter-rouge">true</code></li>
  <li><code class="language-plaintext highlighter-rouge">MONGODB_READ_JOURNAL_SHOULD_CREATE_ADDITIONAL_SNAPSHOT_AGGREGATION_INDEX_PID_SN</code>: <code class="language-plaintext highlighter-rouge">true</code></li>
  <li><code class="language-plaintext highlighter-rouge">MONGODB_READ_JOURNAL_SHOULD_CREATE_ADDITIONAL_SNAPSHOT_AGGREGATION_INDEX_PID_SN_ID</code>: <code class="language-plaintext highlighter-rouge">true</code></li>
</ul>

<p>They are also configurable via Helm values, e.g. for the <code class="language-plaintext highlighter-rouge">things</code> service:</p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">things</span><span class="pi">:</span>
  <span class="na">config</span><span class="pi">:</span>
    <span class="c1"># holds configuration regarding the MongoReadJournal and e.g. the aggregation queries which are performed in it</span>
    <span class="na">readJournal</span><span class="pi">:</span>
      <span class="c1"># indexes contains configuration about additional indexes to create</span>
      <span class="na">indexes</span><span class="pi">:</span>
        <span class="c1"># whether to create the "pid"+"_id" compound index on the snapshot collection</span>
        <span class="na">createSnapshotAggregationIndexPidId</span><span class="pi">:</span> <span class="kc">true</span>
        <span class="c1"># whether to create the "pid"+"sn" compound index on the snapshot collection</span>
        <span class="na">createSnapshotAggregationIndexPidSn</span><span class="pi">:</span> <span class="kc">true</span>
        <span class="c1"># whether to create the "pid"+"sn"+"_id" compound index on the snapshot collection</span>
        <span class="na">createSnapshotAggregationIndexPidSnId</span><span class="pi">:</span> <span class="kc">true</span>
</code></pre></div></div>

<h3 id="ditto-configuration">Ditto configuration</h3>

<p>Each of Ditto’s microservice has many options for configuration, e.g. timeouts, cache sizes, etc.</p>

<p>In order to have a look at all possible configuration options and what default values they have, here are the 
configuration files of Ditto’s microservices:</p>
<ul>
  <li>Policies: <a href="https://github.com/eclipse-ditto/ditto/blob/master/policies/service/src/main/resources/policies.conf">policies.conf</a></li>
  <li>Things: <a href="https://github.com/eclipse-ditto/ditto/blob/master/things/service/src/main/resources/things.conf">things.conf</a></li>
  <li>Things-Search: <a href="https://github.com/eclipse-ditto/ditto/blob/master/thingsearch/service/src/main/resources/search.conf">things-search.conf</a></li>
  <li>Connectivity: <a href="https://github.com/eclipse-ditto/ditto/blob/master/connectivity/service/src/main/resources/connectivity.conf">connectivity.conf</a></li>
  <li>Gateway: <a href="https://github.com/eclipse-ditto/ditto/blob/master/gateway/service/src/main/resources/gateway.conf">gateway.conf</a></li>
</ul>

<p>Whenever you find the syntax <code class="language-plaintext highlighter-rouge">${?UPPER_CASE_ENV_NAME}</code> in the configuration files, you may overwrite the default value
by specifying that environment variable when running the container.</p>

<p>When no environment variable is defined in the config, you may change the default value anyway by specifying a
“System property” you pass to the Java process.</p>

<p>The following example configures the devops password of the gateway-service started via docker-compose. In order
to supply additional configuration one has to add the variable in the corresponding <code class="language-plaintext highlighter-rouge">command</code> section of the
<code class="language-plaintext highlighter-rouge">docker-compose.yml</code> file.</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">...</span>
<span class="c1"># Alternative approach for configuration of the service</span>
<span class="na">environment</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">JAVA_TOOL_OPTIONS=-Dditto.gateway.authentication.devops.password=foobar</span>
</code></pre></div></div>

<p>The executable for the microservice is called <code class="language-plaintext highlighter-rouge">starter.jar</code>. The configuration variables have to be set before
the <code class="language-plaintext highlighter-rouge">-jar</code> option.</p>

<h3 id="pre-authentication">Pre-authentication</h3>

<p>HTTP API calls to Ditto may be authenticated with a reverse proxy (e.g. a nginx) which:</p>
<ul>
  <li>authenticates a user/subject</li>
  <li>passes the authenticated username as HTTP header</li>
  <li>ensures that this HTTP header can never be written by the end-user</li>
</ul>

<p>By default, <code class="language-plaintext highlighter-rouge">pre-authentication</code> is <strong>disabled</strong> in the Ditto <a href="architecture-services-gateway.html">gateway</a> services.
It can however be enabled by configuring the environment variable <code class="language-plaintext highlighter-rouge">ENABLE_PRE_AUTHENTICATION</code> to the value <code class="language-plaintext highlighter-rouge">true</code>.</p>

<p>When it is enabled, the reverse proxy has to set the HTTP header <code class="language-plaintext highlighter-rouge">x-ditto-pre-authenticated</code>.<br />
The format of the “pre-authenticated” string is: <code class="language-plaintext highlighter-rouge">&lt;issuer&gt;:&lt;subject&gt;</code>. The issuer defines which system authenticated 
the user and the subject contains e.g. the user-id or -name.</p>

<p>This string must then be used in <a href="basic-policy.html#subjects">policies</a> as “Subject ID”.</p>

<p>Example for a nginx “proxy” configuration:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>auth_basic                    "Authentication required";
auth_basic_user_file          nginx.htpasswd;
...
proxy_set_header              x-ditto-pre-authenticated "nginx:${remote_user}";
</code></pre></div></div>

<h3 id="openid-connect">OpenID Connect</h3>

<p>The authentication provider must be added to the ditto-gateway configuration with unique configuration key 
(e.g. <code class="language-plaintext highlighter-rouge">myprovier</code> in the example below).</p>

<p>Either <code class="language-plaintext highlighter-rouge">issuer</code> as single supported JWT <code class="language-plaintext highlighter-rouge">"iss"</code> claim or <code class="language-plaintext highlighter-rouge">issuers</code> (as a list of supported JWT <code class="language-plaintext highlighter-rouge">"iss"</code> claims) has to be 
configured. If <code class="language-plaintext highlighter-rouge">issuers</code> is configured, this list has priority and the value configured in <code class="language-plaintext highlighter-rouge">issuer</code> will be ignored.</p>

<p>The configured <code class="language-plaintext highlighter-rouge">auth-subjects</code>, an optional field, takes a list of placeholders that will be
evaluated against incoming JWTs.<br />
For each entry in <code class="language-plaintext highlighter-rouge">auth-subjects</code> an authorization subject will be generated.
If the entry contains unresolvable placeholders, it will be ignored in full.
When <code class="language-plaintext highlighter-rouge">auth-subjects</code> is not provided, the <code class="language-plaintext highlighter-rouge">"sub"</code> claim (<code class="language-plaintext highlighter-rouge">{{ jwt:sub }}</code>) is used by default.</p>

<p>Please read <a href="basic-placeholders.html#scope-openid-connect-configuration">more details on the OpenId Connect configuration placeholder</a>
to find out what is possible when defining the <code class="language-plaintext highlighter-rouge">auth-subjects</code>.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ditto.gateway.authentication {
    oauth {
      openid-connect-issuers = {
        myprovider = {
          issuer = "localhost:9000"
          #issuers = [
          #  "localhost:9000/one"
          #  "localhost:9000/two"
          #]
          auth-subjects = [
            "{{ jwt:sub }}",
            "{{ jwt:sub }}/{{ jwt:scp }}",
            "{{ jwt:sub }}/{{ jwt:scp }}@{{ jwt:client_id }}",
            "{{ jwt:sub }}/{{ jwt:scp }}@{{ jwt:non_existing }}",
            "{{ jwt:roles/support }}"
          ]
        }
      }
    }
}
</code></pre></div></div>

<div class="alert alert-info" role="alert"><i class="fa fa-info-circle"></i> <b>Note:</b> The issuer <strong>must not</strong> include the <code class="language-plaintext highlighter-rouge">http://</code> or <code class="language-plaintext highlighter-rouge">https://</code> prefix as this is added 
    based on the configuration value of <code class="language-plaintext highlighter-rouge">ditto.gateway.authentication.oauth.protocol</code>.</div>

<p>In order to do this by specifying a Java system property, use the following:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">-Dditto</span>.gateway.authentication.oauth.openid-connect-issuers.myprovider.issuer<span class="o">=</span>localhost:9000
<span class="nt">-Dditto</span>.gateway.authentication.oauth.openid-connect-issuers.myprovider.auth-subjects.0<span class="o">=</span><span class="s1">'{{ jwt:sub }}/{{ jwt:scp }}'</span>

</code></pre></div></div>

<p>The configured subject-issuer will be used to prefix the value of each individual <code class="language-plaintext highlighter-rouge">auth-subject</code>.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"subjects"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"&lt;provider&gt;:&lt;auth-subject-0&gt;"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"generated"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="err">...</span><span class="w">
    </span><span class="nl">"&lt;provider&gt;:&lt;auth-subject-n&gt;"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"generated"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>As of the OAuth2.0 and OpenID Connect standards Ditto expects the headers <code class="language-plaintext highlighter-rouge">Authorization: Bearer &lt;JWT&gt;</code> and
<code class="language-plaintext highlighter-rouge">Content-Type: application/json</code>, containing the issued token of the provider.</p>

<p><strong>The token has to be issued beforehand. The required logic is not provided by Ditto.</strong></p>

<p>This can e.g. be done by an OIDC provider like <a href="https://www.keycloak.org/">Keycloak</a>.<br />
A project like <a href="https://github.com/oauth2-proxy/oauth2-proxy">oauth2-proxy</a>
may be put in front of Ditto to handle the token-logic like e.g. loading/saving the token from/to a Cookie and passing
it to Ditto as <code class="language-plaintext highlighter-rouge">Authorization</code> header.</p>

<p><strong>If the chosen OIDC provider uses a self-signed certificate</strong>, the certificate has to be retrieved and configured for 
the pekko-http ssl configuration.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssl-config {
  trustManager = {
    stores = [
      { type = "PEM", path = "/path/to/cert/globalsign.crt" }
    ]
  }
}
</code></pre></div></div>

<h3 id="encrypt-sensitive-data-in-connections">Encrypt sensitive data in Connections</h3>

<p>Since Ditto 3.1.0 there is the option to enable encryption on some connection fields before they are written to the
database.
This mechanism is transparent for the user and when data is retrieved by the standard connectivity managing endpoints
no encryption will be visible. It is applied on the db layer before data is written to the database.
Since ditto is using the event sourcing mechanism, if encryption is enabled on a system that have existing connections,
encryption will only be applied on events written to the database after it was enabled.
So for some time there will be events in the database that have the plain data until the background cleaner deletes the
old events that are no longer needed for the event sourcing.</p>

<p>Encryption is done using a 256-bit AES symmetrical key and the AES/GCM/NoPadding transformation.</p>

<h4 id="symmetric-key">Symmetric key</h4>

<p>To generate it you can use a convenience method already available
at <a href="https://github.com/eclipse-ditto/ditto/blob/master/connectivity/service/src/main/java/org/eclipse/ditto/connectivity/service/util/EncryptorAesGcm.java#L100">EncryptorAesGcm.generateAESKeyAsString()</a></p>

<p>or you can use the java standard library</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="n">javax</span><span class="o">.</span><span class="na">crypto</span><span class="o">.</span><span class="na">KeyGenerator</span> <span class="n">keyGen</span><span class="o">=</span><span class="nc">KeyGenerator</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="s">"AES"</span><span class="o">);</span>
        <span class="n">keyGen</span><span class="o">.</span><span class="na">init</span><span class="o">(</span><span class="mi">256</span><span class="o">);</span>
        <span class="n">javax</span><span class="o">.</span><span class="na">crypto</span><span class="o">.</span><span class="na">SecretKey</span> <span class="n">aes256SymetricKey</span> <span class="o">=</span> <span class="n">keyGen</span><span class="o">.</span><span class="na">generateKey</span><span class="o">();</span>
</code></pre></div></div>

<p>or with a terminal command.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>openssl rand 32 | basenc <span class="nt">--base64url</span>
</code></pre></div></div>

<p>The key must be <strong>256-bit <a href="https://www.rfc-editor.org/rfc/rfc4648#section-5">Base64-encoded with url-safe alphabet</a> using the UTF-8</strong> charset.
This is done already by the convenience method mentioned
above (<a href="https://github.com/eclipse-ditto/ditto/blob/master/connectivity/service/src/main/java/org/eclipse/ditto/connectivity/service/util/EncryptorAesGcm.java#L100">EncryptorAesGcm.generateAESKeyAsString()</a></p>

<h4 id="fields-config">Fields config</h4>
<p>The fields to be encrypted are configurable as json pointers and the default ones are:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        /uri
        /credentials/key
        /sshTunnel/credentials/password
        /sshTunnel/credentials/privateKey
        /credentials/parameters/accessKey
        /credentials/parameters/secretKey
        /credentials/parameters/sharedKey
        /credentials/clientSecret
</code></pre></div></div>

<p>Only string values are supported. If a configured pointer is pointing at an object it will be ignored.
Values that are valid URIs are treated specially and only the password of the user info part of that URI will be
encrypted.</p>

<p>Configuration can be seen at <a href="#ditto-configuration">Ditto service configuration files</a> in
the <a href="https://github.com/eclipse-ditto/ditto/blob/master/connectivity/service/src/main/resources/connectivity.conf">connectivity.conf</a>
at “ditto.connectivity.connection.encryption” section of the config.</p>

<p>If at some point encryption is decided to be disabled the symmetric key is important to be kept in the 
configuration otherwise the encrypted values will not be decrypted and the only way to fix the connections will be to edit
the encrypted parts and save them.</p>

<h3 id="rate-limiting">Rate limiting</h3>

<p>Since Ditto <em>2.4.0</em> , by default <a href="basic-connections.html">connections</a> and <a href="httpapi-protocol-bindings-websocket.html">websockets</a>
are no longer artificially throttled / rate limited when <em>consuming messages</em>.<br />
There are however configuration options in place in order to enable throttling on a “per-connection” / “per-websocket”
basis.<br />
Please consult the available <code class="language-plaintext highlighter-rouge">throttling</code> configuration sections in the 
<a href="#ditto-configuration">Ditto service configuration files</a>.</p>

<h2 id="restricting-entity-creation">Restricting entity creation</h2>

<p>By default, Ditto allows anyone to create a new entity (policy or thing) in any namespace. However, this behavior can
be customized, and the ability to create new entities can be restricted.</p>

<p>In the <code class="language-plaintext highlighter-rouge">ditto-entity-creation.conf</code>, you can re-configure the <code class="language-plaintext highlighter-rouge">entity-creation</code> section to suit your needs.<br />
The basic schema is:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># restrict entity creation
ditto.entity-creation {
   # this default entry allows every authenticated "auth-subject" to create any "resource-type" in any "namespace":
  grant = [
    {
      resource-types = [
//        "policy"
//        "thing"
      ]
      namespaces = [
//        "org.eclipse.ditto*"
      ]
      auth-subjects = [
//        "pre:ditto-*"
      ]
    }
  ]
  revoke = [
    # same as "grant", but rejecting requests which already passed "grant"
  ]
}
</code></pre></div></div>

<p>When enforcing, the logic is:</p>

<ul>
  <li>Find a matching entry in the <code class="language-plaintext highlighter-rouge">grant</code> list</li>
  <li>If one was found, ensure there is no matching entry in the <code class="language-plaintext highlighter-rouge">revoke</code> list</li>
  <li>If that is the case, accept the request, otherwise deny it</li>
</ul>

<p>An entry matches, when all the following conditions are met:</p>

<ul>
  <li>The resource types list is empty, or contains the requested resource type</li>
  <li>The namespace wildcard list is empty, or contains a wildcard that matches the requested namespace</li>
  <li>The auth subject wildcard list is empty, or contains at least one matching wildcard of the authorized subjects for the request</li>
</ul>

<p>This means, an existing entry, with all empty lists, will match. So the default configuration, allowing all access,
can be as simple as:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ditto.entity-creation {
  grant = [{}]
}
</code></pre></div></div>

<p>The resource types can be any of:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">policy</code></li>
  <li><code class="language-plaintext highlighter-rouge">thing</code></li>
</ul>

<p>The namespace wildcard list, is a list of wildcard patters, which must match the namespace. <code class="language-plaintext highlighter-rouge">*</code> will match any number
of characters, and <code class="language-plaintext highlighter-rouge">?</code> will match exactly one character.</p>

<p>The auth subject wildcard list requires only a single entry of the requests auth subjects to match, like <code class="language-plaintext highlighter-rouge">oauth:user-id</code>
or <code class="language-plaintext highlighter-rouge">pre-authenticated:service</code>. <code class="language-plaintext highlighter-rouge">*</code> will match any number of characters, and <code class="language-plaintext highlighter-rouge">?</code> will match exactly one character.</p>

<p>Example for configuring it via system properties.<br />
This would only allow the subjects authenticated as either <code class="language-plaintext highlighter-rouge">"pre:admin"</code> or <code class="language-plaintext highlighter-rouge">"integration:some-connection"</code> to create 
entities (things/policies) and no-one other:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">-Dditto</span>.entity-creation.grant.0.auth-subjects.0<span class="o">=</span>pre:admin
<span class="nt">-Dditto</span>.entity-creation.grant.0.auth-subjects.1<span class="o">=</span>integration:some-connection
</code></pre></div></div>

<p>These system properties would have to be configured for the “things” and “policies” services.</p>

<h2 id="configuring-pre-defined-extra-fields">Configuring pre-defined extra fields</h2>

<p>Starting with Ditto 3.7.0, it is possible to configure <a href="basic-enrichment.html">enrichment of <code class="language-plaintext highlighter-rouge">extraFields</code></a> statically 
via the configuration of the Ditto “things” service.</p>

<p>The benefit of doing this statically is a Ditto internal optimization to reduce internal traffic between Ditto services.<br />
By default, Ditto will internally do an additional roundtrip from an “edge” service (“gateway” or “connectivity”) to the
“things” service in order to retrieve configured <code class="language-plaintext highlighter-rouge">extraFields</code> (of a <a href="basic-connections.html#target-topics-and-enrichment">managed connection</a> or 
e.g. a <a href="httpapi-protocol-bindings-websocket.html#enrichment">WebSocket session</a>).</p>

<p>Those retrieved <code class="language-plaintext highlighter-rouge">extraFields</code> are additionally cached, so also require some memory as well.</p>

<p>If for a Ditto installation the <code class="language-plaintext highlighter-rouge">extraFields</code> are known upfront and will not change dynamically, it is possible to configure
them in the <a href="https://github.com/eclipse/ditto/blob/master/things/service/src/main/resources/things.conf">things.conf</a>.</p>

<p>This configuration is something for power operators of Ditto, needing to reduce resources and improving resiliency by
reducing internal lookups.</p>

<h3 id="pre-defined-extra-fields-configuration">Pre-defined extra fields configuration</h3>

<p>The configuration can be done for:</p>
<ul>
  <li>events: Thing Events emitted to subscriber</li>
  <li>messages: Thing Messages forwarded by Ditto to message subscribers</li>
</ul>

<p>Available options:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">pre-defined-extra-fields</code>: a list of pre-defined extra fields configurations
    <ul>
      <li><code class="language-plaintext highlighter-rouge">namespaces</code>: a list of namespaces for which the configuration applies
        <ul>
          <li>if this list is empty, the configuration applies to all namespaces</li>
          <li>the entries support wildcards (<code class="language-plaintext highlighter-rouge">*</code> matches any number of characters, <code class="language-plaintext highlighter-rouge">?</code> matches exactly one character)</li>
        </ul>
      </li>
      <li><code class="language-plaintext highlighter-rouge">condition</code>: a <a href="basic-rql.html">RQL condition</a> to check if the extra fields should be added</li>
      <li><code class="language-plaintext highlighter-rouge">extra-fields</code>: a list of extra fields (as JsonPointers) to proactively add for all matching <code class="language-plaintext highlighter-rouge">namespaces</code> and <code class="language-plaintext highlighter-rouge">condition</code> combinations</li>
    </ul>
  </li>
</ul>

<p>Example configuration:</p>
<div class="language-hocon highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">ditto</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="nl">things</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">thing</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">event</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">pre-defined-extra-fields</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="p">{</span><span class="w">
            </span><span class="nl">namespaces</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[]</span><span class="w">
            </span><span class="nl">condition</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">"exists(definition)"</span><span class="w">
            </span><span class="nl">extra-fields</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="w">
              </span><span class="s2">"definition"</span><span class="w">
            </span><span class="p">]</span><span class="w">
          </span><span class="p">},</span><span class="w">
          </span><span class="p">{</span><span class="w">
            </span><span class="nl">namespaces</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="w">
              </span><span class="s2">"org.eclipse.ditto.lamps"</span><span class="w">
            </span><span class="p">]</span><span class="w">
            </span><span class="nl">extra-fields</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="w">
              </span><span class="s2">"attributes/manufacturer"</span><span class="p">,</span><span class="w">
              </span><span class="s2">"attributes/serial"</span><span class="w">
            </span><span class="p">]</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">]</span><span class="w">
      </span><span class="p">}</span><span class="w">

      </span><span class="nl">message</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">pre-defined-extra-fields</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="p">{</span><span class="w">
            </span><span class="nl">namespaces</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[]</span><span class="w">
            </span><span class="nl">condition</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">"exists(definition)"</span><span class="w">
            </span><span class="nl">extra-fields</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="w">
              </span><span class="s2">"definition"</span><span class="w">
            </span><span class="p">]</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">]</span><span class="w">
    </span><span class="c1">//...</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>The above example configuration would always proactively send the <code class="language-plaintext highlighter-rouge">definition</code> of all Things (if it exists) in the published events
and all messages.<br />
If a consumer of events or messages is interested in this <code class="language-plaintext highlighter-rouge">extraField</code>, this would not lead to an additional internal 
lookup in Ditto and save an internal roundtrip + caching of the result.</p>

<p>For the namespace <code class="language-plaintext highlighter-rouge">org.eclipse.ditto.lamps</code> there would even be some defined attributes pre-defined to be available as
<code class="language-plaintext highlighter-rouge">extraFields</code> without the need for another internal lookup.</p>

<h2 id="limiting-indexed-fields">Limiting Indexed Fields</h2>

<p>The default behavior of Ditto is to index the complete JSON of a thing, which includes all its attributes and features.  This may not be desired behavior for certain use cases:</p>
<ul>
  <li>Increased load on the search database, leading to performance degradation and increased database cost.</li>
  <li>Only a few fields are ever used for searching.</li>
</ul>

<p>Since Ditto <em>3.5.0</em>, there is a configuration to specify, by a namespace pattern, which fields will be included in the search database.</p>

<p>To enable this functionality, there are two new options in the <code class="language-plaintext highlighter-rouge">thing-search.conf</code> configuration:</p>

<div class="language-hocon highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">ditto</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="c1">//...</span><span class="w">
  </span><span class="nl">caching-signal-enrichment-facade-provider</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="l">org.eclipse.ditto.thingsearch.service.persistence.write.streaming.SearchIndexingSignalEnrichmentFacadeProvider</span><span class="w">
  </span><span class="c1">//...</span><span class="w">
  </span><span class="nl">search</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">namespace-indexed-fields</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="p">{</span><span class="w">
        </span><span class="nl">namespace-pattern</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">"org.eclipse.test"</span><span class="w">
        </span><span class="nl">indexed-fields</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="w">
           </span><span class="s2">"attributes"</span><span class="p">,</span><span class="w">
           </span><span class="s2">"features/info/properties"</span><span class="p">,</span><span class="w">
           </span><span class="s2">"features/info/other"</span><span class="w">
        </span><span class="p">]</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="p">{</span><span class="w">
        </span><span class="nl">namespace-pattern</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">"org.eclipse*"</span><span class="w">
        </span><span class="nl">indexed-fields</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="w">
           </span><span class="s2">"attributes"</span><span class="p">,</span><span class="w">
           </span><span class="s2">"features/info"</span><span class="w">
        </span><span class="p">]</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>There is a new implementation of the caching signal enrichment facade provider that must be configured to enable this
functionality.</p>

<p>For each namespace pattern, only the selected fields are included in the search database. In the example above, for 
things in the “org.eclipse.test” namespace, the fields indexed in the search database will
only be “attributes”, “features/info/properties”, and “features/info/other”.<br />
Things matching the “org.eclipse*” namespace, only the “attributes” and “features/info” paths will be the only fields 
indexed in the search database.</p>

<p>Important notes:</p>
<ul>
  <li>Ditto will use the namespace of the thing and match the FIRST namespace-pattern it encounters. So make sure any
configured namespace-patterns are unique enough to match.</li>
  <li>Ditto will automatically add the system-level fields it needs to operate, so no manual configuration of these is
necessary.</li>
</ul>

<p>Example for configuring the same configuration via system properties for the <code class="language-plaintext highlighter-rouge">things-search</code> service:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">-Dditto</span>.search.namespace-indexed-fields.0.namespace-pattern<span class="o">=</span>org.eclipse.test
<span class="nt">-Dditto</span>.search.namespace-indexed-fields.0.indexed-fields.0<span class="o">=</span>attributes
<span class="nt">-Dditto</span>.search.namespace-indexed-fields.0.indexed-fields.1<span class="o">=</span>features/info/properties
<span class="nt">-Dditto</span>.search.namespace-indexed-fields.0.indexed-fields.2<span class="o">=</span>features/info/other
<span class="nt">-Dditto</span>.search.namespace-indexed-fields.1.namespace-pattern<span class="o">=</span>org.eclipse<span class="k">*</span>
<span class="nt">-Dditto</span>.search.namespace-indexed-fields.1.indexed-fields.0<span class="o">=</span>attributes
<span class="nt">-Dditto</span>.search.namespace-indexed-fields.1.indexed-fields.1<span class="o">=</span>features/info
</code></pre></div></div>

<h2 id="logging">Logging</h2>

<p>Gathering logs for a running Ditto installation can be achieved by:</p>

<ul>
  <li>sending logs to STDOUT/STDERR: this is the default
    <ul>
      <li>can be disabled by setting the environment variable <code class="language-plaintext highlighter-rouge">DITTO_LOGGING_DISABLE_SYSOUT_LOG</code> to <code class="language-plaintext highlighter-rouge">true</code></li>
      <li>Benefits: simple, works with all Docker logging drivers (e.g. “awslogs”, “splunk”, etc.)</li>
    </ul>
  </li>
  <li>pushing logs into ELK stack: this can be done by setting the environment variable <code class="language-plaintext highlighter-rouge">DITTO_LOGGING_LOGSTASH_SERVER</code>
    <ul>
      <li>configure <code class="language-plaintext highlighter-rouge">DITTO_LOGGING_LOGSTASH_SERVER</code> to contain the endpoint of a logstash server</li>
    </ul>
  </li>
  <li>writing logs to log files: this can be done by setting the environment variable <code class="language-plaintext highlighter-rouge">DITTO_LOGGING_FILE_APPENDER</code> to <code class="language-plaintext highlighter-rouge">true</code>
    <ul>
      <li>configure the amount of log files, and the total amount of space used for logs files via these environment 
variables. It is also possible to clean up old log files and archives at start up.
In case <code class="language-plaintext highlighter-rouge">DITTO_LOGGING_TOTAL_LOG_FILE_SIZE</code> is used it is necessary to configure also <code class="language-plaintext highlighter-rouge">DITTO_LOGGING_MAX_LOG_FILE_HISTORY</code>.
The detailed meaning of these config values is described in the <a href="https://logback.qos.ch/manual/appenders.html#TimeBasedRollingPolicy">logback documentation</a>.
        <ul>
          <li><code class="language-plaintext highlighter-rouge">DITTO_LOGGING_FILE_APPENDER_THRESHOLD</code> (default: <code class="language-plaintext highlighter-rouge">info</code>) - the threshold <code class="language-plaintext highlighter-rouge">level</code> to use for logging (only greater or equal levels will be logged)</li>
          <li><code class="language-plaintext highlighter-rouge">DITTO_LOGGING_FILE_NAME_PATTERN</code> (default: <code class="language-plaintext highlighter-rouge">/var/log/ditto/&lt;service-name&gt;.log.%d{yyyy-MM-dd}.gz</code>) - the rollover period is inferred from the fileNamePattern</li>
          <li><code class="language-plaintext highlighter-rouge">DITTO_LOGGING_MAX_LOG_FILE_HISTORY</code> (default: <code class="language-plaintext highlighter-rouge">10</code>)</li>
          <li><code class="language-plaintext highlighter-rouge">DITTO_LOGGING_TOTAL_LOG_FILE_SIZE</code> (default: <code class="language-plaintext highlighter-rouge">1GB</code>)</li>
          <li><code class="language-plaintext highlighter-rouge">DITTO_LOGGING_CLEAN_HISTORY_ON_START</code> (default: <code class="language-plaintext highlighter-rouge">false</code>)</li>
        </ul>
      </li>
      <li>the format in which logging is done is “LogstashEncoder” format - that way the logfiles may easily be imported into
an ELK stack</li>
      <li>when running Ditto in Kubernetes apply the <code class="language-plaintext highlighter-rouge">ditto-log-files.yaml</code> to your Kubernetes cluster in order to 
mount log files to the host system.</li>
    </ul>
  </li>
</ul>

<h2 id="monitoring">Monitoring</h2>

<p>In addition to logging, the Ditto images include monitoring features. Specific metrics are
automatically gathered and published on an HTTP port. There it can be scraped by a <a href="https://prometheus.io">Prometheus</a>
backend, from where the metrics can be accessed to display in dashboards (e.g. with <a href="https://grafana.com">Grafana</a>).</p>

<h3 id="monitoring-configuration">Monitoring configuration</h3>

<p>In the default configuration, each Ditto service opens a HTTP endpoint, where it provides the Prometheus metrics 
on port <code class="language-plaintext highlighter-rouge">9095</code>. This can be changed via the environment variable <code class="language-plaintext highlighter-rouge">PROMETHEUS_PORT</code>.</p>

<p>Ditto will automatically publish gathered metrics at the endpoint <code class="language-plaintext highlighter-rouge">http://&lt;container-host-or-ip&gt;:9095/</code>.</p>

<p>Further, Prometheus can be configured to poll on all Ditto service endpoints in order to persist the historical metrics.
Grafana can add a Prometheus server as its data source and can display
the metrics based on the keys mentioned in section <a href="#gathered-metrics">“Gathered metrics”</a>.</p>

<h3 id="gathered-metrics">Gathered metrics</h3>

<p>In order to inspect which metrics are exported to Prometheus, just visit the Prometheus HTTP endpoint of a Ditto service:
<code class="language-plaintext highlighter-rouge">http://&lt;container-host-or-ip&gt;:9095/</code>.</p>

<p>The following example shows an excerpt of metrics gathered for the
<a href="architecture-services-gateway.html">gateway-service</a>.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#Kamon Metrics
# TYPE jvm_threads gauge
jvm_threads{component="system-metrics",measure="total"} 72.0
# TYPE jvm_memory_buffer_pool_count gauge
jvm_memory_buffer_pool_count{component="system-metrics",pool="direct"} 14.0
# TYPE jvm_class_loading gauge
jvm_class_loading{component="system-metrics",mode="loaded"} 10491.0
# TYPE jvm_memory_buffer_pool_usage gauge
jvm_memory_buffer_pool_usage{component="system-metrics",pool="direct",measure="used"} 396336.0
# TYPE roundtrip_http_seconds histogram
roundtrip_http_seconds_bucket{le="0.05",ditto_request_path="/api/2/things/x",ditto_request_method="PUT",ditto_statusCode="201",segment="overall"} 1.0
roundtrip_http_seconds_sum{ditto_request_path="/api/2/things/x",ditto_statusCode="201",ditto_request_method="PUT",segment="overall"} 0.038273024
roundtrip_http_seconds_bucket{le="0.001",ditto_request_path="/api/2/things/x",ditto_request_method="PUT",ditto_statusCode="204",segment="overall"} 0.0
roundtrip_http_seconds_bucket{le="0.1",ditto_request_path="/api/2/things/x",ditto_request_method="PUT",ditto_statusCode="204",segment="overall"} 7.0
roundtrip_http_seconds_sum{ditto_request_path="/api/2/things/x",ditto_statusCode="204",ditto_request_method="PUT",segment="overall"} 0.828899328
# TYPE jvm_gc_promotion histogram
jvm_gc_promotion_sum{space="old"} 7315456.0
# TYPE jvm_gc_seconds histogram
jvm_gc_seconds_count{component="system-metrics",collector="scavenge"} 9.0
jvm_gc_seconds_sum{component="system-metrics",collector="scavenge"} 0.063
# TYPE jvm_memory_bytes histogram
jvm_memory_bytes_count{component="system-metrics",measure="used",segment="miscellaneous-non-heap-storage"} 54.0
jvm_memory_bytes_sum{component="system-metrics",measure="used",segment="miscellaneous-non-heap-storage"} 786350080.0
</code></pre></div></div>

<p>To put it in a nutshell, Ditto reports:</p>

<ul>
  <li>JVM metrics for all services
    <ul>
      <li>amount of garbage collections + GC times</li>
      <li>memory consumption (heap + non-heap)</li>
      <li>amount of threads + loaded classes</li>
    </ul>
  </li>
  <li>HTTP metrics for <a href="architecture-services-gateway.html">gateway-service</a>
    <ul>
      <li>roundtrip times from request to response</li>
      <li>amount of HTTP calls</li>
      <li>status code of HTTP responses</li>
    </ul>
  </li>
  <li>MongoDB metrics for <a href="architecture-services-things.html">things-service</a>,
<a href="architecture-services-policies.html">policies-service</a>, <a href="architecture-services-things-search.html">things-search-service</a>
    <ul>
      <li>inserts, updates, reads per second</li>
      <li>roundtrip times</li>
    </ul>
  </li>
  <li>connection metrics for <a href="architecture-services-connectivity.html">connectivity-service</a>
    <ul>
      <li>processed messages</li>
      <li>mapping times</li>
    </ul>
  </li>
</ul>

<p>Have a look at the 
<a href="https://github.com/eclipse-ditto/ditto/tree/master/deployment/operations/grafana-dashboards">example Grafana dashboards</a>
and build and share new ones back to the Ditto community.</p>

<h3 id="operator-defined-custom-metrics">Operator defined custom metrics</h3>

<p>Starting with Ditto 3.5.0, it is possible to configure “custom metrics” which are gathered by counting things matching
a defined namespace/filter combination.<br />
This is configured via the <a href="architecture-services-things-search.html">search</a> service configuration and builds on the
<a href="basic-search.html#search-count-queries">count things</a> functionality.</p>

<p>The idea behind this is that you want to show some statistic (e.g. in Grafana) about the amount of “Things” managed in
Ditto fulfilling a certain condition.</p>

<p>This would be an example search service configuration snippet for e.g. providing a metric named 
<code class="language-plaintext highlighter-rouge">all_produced_and_not_installed_devices</code> defining a query on existence of a <code class="language-plaintext highlighter-rouge">production-date</code> and absence of 
an <code class="language-plaintext highlighter-rouge">installation-date</code> attribute:</p>
<div class="language-hocon highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">ditto</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="nl">search</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">operator-metrics</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">enabled</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">true</span><span class="w">
      </span><span class="nl">scrape-interval</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">15</span><span class="l">m</span><span class="w">
      </span><span class="nl">custom-metrics</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">all_produced_and_not_installed_devices</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">scrape-interval</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">5</span><span class="l">m</span><span class="w"> </span><span class="c1"># overwrite scrape interval, run each 5 minutes</span><span class="w">
          </span><span class="nl">namespaces</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="s2">"org.eclipse.ditto.smokedetectors"</span><span class="w">
            </span><span class="s2">"org.eclipse.ditto.cameras"</span><span class="w">
          </span><span class="p">]</span><span class="w">
          </span><span class="nl">filter</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">"and(exists(attributes/production-date),not(exists(attributes/installation-date)))"</span><span class="w">
          </span><span class="nl">tags</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">company</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">"acme-corp"</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>In order to add custom metrics via System properties, the following example shows how the above metric can be configured:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>-Dditto.search.operator-metrics.custom-metrics.all_produced_and_not_installed_devices.enabled=true
-Dditto.search.operator-metrics.custom-metrics.all_produced_and_not_installed_devices.scrape-interval=5m
-Dditto.search.operator-metrics.custom-metrics.all_produced_and_not_installed_devices.namespaces.0=org.eclipse.ditto.smokedetectors
-Dditto.search.operator-metrics.custom-metrics.all_produced_and_not_installed_devices.namespaces.1=org.eclipse.ditto.cameras
-Dditto.search.operator-metrics.custom-metrics.all_produced_and_not_installed_devices.filter=and(exists(attributes/production-date),not(exists(attributes/installation-date)))
-Dditto.search.operator-metrics.custom-metrics.all_produced_and_not_installed_devices.tags.company=acme-corp
</code></pre></div></div>

<p>Ditto will perform a <a href="basic-search.html#search-count-queries">count things operation</a> each <code class="language-plaintext highlighter-rouge">5m</code> (5 minutes), providing
a gauge named <code class="language-plaintext highlighter-rouge">all_produced_and_not_installed_devices</code> with the count of the query, adding the tag <code class="language-plaintext highlighter-rouge">company="acme-corp"</code>.</p>

<p>In Prometheus format, this would look like:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>all_produced_and_not_installed_devices{company="acme-corp"} 42.0
</code></pre></div></div>

<h3 id="operator-defined-custom-aggregation-based-metrics">Operator defined custom aggregation based metrics</h3>
<p>Starting with Ditto 3.6.0, the “custom metrics” functionality is extended to support custom aggregation metrics.<br />
This is configured via the <a href="architecture-services-things-search.html">search</a> service configuration.</p>

<blockquote>
  <p>:warning: <strong>Abstain of defining grouping by fields that have a high cardinality, as this will lead to a high number of metrics and
may overload the Prometheus server!</strong></p>
</blockquote>

<p>Now you can augment the statistic about “Things” managed in Ditto
fulfilling a certain condition with tags with either predefined values,
values retrieved from the things or values which are defined based on the matching filter. 
This is fulfilled by using hardcoded values or placeholders in the tags configuration.
The supported placeholder types are <code class="language-plaintext highlighter-rouge">inline</code> and <code class="language-plaintext highlighter-rouge">group-by</code> placeholders.
<a href="basic-placeholders.html#function-expressions">Function expressions</a> are also supported
to manipulate the values of the placeholders before they are used in the tags.</p>

<p>This would be an example search service configuration snippet for e.g. providing a metric named
<code class="language-plaintext highlighter-rouge">online_devices</code> defining a query on the values of a <code class="language-plaintext highlighter-rouge">ConnectionStatus</code> feature:</p>
<div class="language-hocon highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">ditto</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="nl">search</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">operator-metrics</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">enabled</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">true</span><span class="w">
      </span><span class="nl">scrape-interval</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">30</span><span class="l">m</span><span class="w">
      </span><span class="nl">custom-metrics</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="l">...</span><span class="w">
      </span><span class="p">}</span><span class="w">
      </span><span class="nl">custom-aggregation-metrics</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">online_status</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">enabled</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">true</span><span class="w">
          </span><span class="nl">scrape-interval</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">20</span><span class="l">m</span><span class="w"> </span><span class="c1"># override scrape interval, run every 20 minutes</span><span class="w">
          </span><span class="nl">namespaces</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="s2">"org.eclipse.ditto"</span><span class="w">
          </span><span class="p">]</span><span class="w">
          </span><span class="nl">group-by</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"location"</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">"attributes/Info/location"</span><span class="w">
            </span><span class="nl">"isGateway"</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">"attributes/Info/gateway"</span><span class="w">
          </span><span class="p">}</span><span class="w">
          </span><span class="nl">tags</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"online"</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">"{{ inline:online_placeholder }}"</span><span class="w">
            </span><span class="nl">"health"</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">"{{ inline:health }}"</span><span class="w">
            </span><span class="nl">"hardcoded-tag"</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">"hardcoded_value"</span><span class="w">
            </span><span class="nl">"location"</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">"{{ group-by:location | fn:default('missing location') }}"</span><span class="w">
            </span><span class="nl">"isGateway"</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">"{{ group-by:isGateway }}"</span><span class="w">
          </span><span class="p">}</span><span class="w">
          </span><span class="nl">filters</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">online_filter</span><span class="w"> </span><span class="p">{</span><span class="w">
              </span><span class="nl">filter</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">"gt(features/ConnectionStatus/properties/status/readyUntil,time:now)"</span><span class="w">
              </span><span class="nl">inline-placeholder-values</span><span class="w">  </span><span class="p">{</span><span class="w">
                </span><span class="nl">"online_placeholder"</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">true</span><span class="w">
                </span><span class="nl">"health"</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">"good"</span><span class="w">
              </span><span class="p">}</span><span class="w">
            </span><span class="p">}</span><span class="w">
            </span><span class="nl">offline_filter</span><span class="w"> </span><span class="p">{</span><span class="w">
              </span><span class="nl">filter</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">"lt(features/ConnectionStatus/properties/status/readyUntil,time:now)"</span><span class="w">
              </span><span class="nl">inline-placeholder-values</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nl">"online_placeholder"</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">false</span><span class="w">
                </span><span class="nl">"health"</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">"bad"</span><span class="w">
              </span><span class="p">}</span><span class="w">
            </span><span class="p">}</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>To add custom metrics via System properties, the following example shows how the above metric can be configured:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>-Dditto.search.operator-metrics.custom-aggregation-metrics.online_status.enabled=true
-Dditto.search.operator-metrics.custom-aggregation-metrics.online_status.scrape-interval=20m
-Dditto.search.operator-metrics.custom-aggregation-metrics.online_status.namespaces.0=org.eclipse.ditto
-Dditto.search.operator-metrics.custom-aggregation-metrics.online_status.tags.online="{{online_placeholder}}"
-Dditto.search.operator-metrics.custom-aggregation-metrics.online_status.tags.location="{{attributes/Info/location}}"

-Dditto.search.operator-metrics.custom-aggregation-metrics.online_status.filters.online-filter.filter=gt(features/ConnectionStatus/properties/status/readyUntil/,time:now)
-Dditto.search.operator-metrics.custom-aggregation-metrics.online_status.filters.online-filter.inline-placeholder-values.online_placeholder=true
-Dditto.search.operator-metrics.custom-aggregation-metrics.online_status.filters.online-filter.fields.0=attributes/Info/location

-Dditto.search.operator-metrics.custom-aggregation-metrics.online_status.filters.offline-filter.filter=lt(features/ConnectionStatus/properties/status/readyUntil/,time:now)
-Dditto.search.operator-metrics.custom-aggregation-metrics.online_status.filters.offline-filter.inline-placeholder-values.online_placeholder=false
-Dditto.search.operator-metrics.custom-aggregation-metrics.online_status.filters.offline-filter.fields.0=attributes/Info/location

</code></pre></div></div>

<p>Ditto will perform an <a href="https://www.mongodb.com/docs/manual/aggregation/">aggregation operation</a> over the search db collection every <code class="language-plaintext highlighter-rouge">20m</code> (20 minutes), providing
a gauge named <code class="language-plaintext highlighter-rouge">online_devices</code> with the value of devices that match the filter. 
The tags <code class="language-plaintext highlighter-rouge">online</code> and <code class="language-plaintext highlighter-rouge">location</code> will be added.
Their values will be resolved from the placeholders <code class="language-plaintext highlighter-rouge">{{online_placeholder}}</code> and <code class="language-plaintext highlighter-rouge">{{attributes/Info/location}}</code> respectively.</p>

<p>In Prometheus format, this would look like:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>online_status{location="Berlin",online="false"} 6.0
online_status{location="Immenstaad",online="true"} 8.0
</code></pre></div></div>

<h2 id="tracing">Tracing</h2>

<p>Ditto supports reading and propagating <a href="https://www.w3.org/TR/trace-context/">W3C trace context</a> headers at the 
edges of the Ditto service (e.g. Gateway and Connectivity service). Several spans are generated when a request is<br />
processed and the tracing data is exported in <a href="https://opentelemetry.io/">OpenTelemetry</a> format using 
kamon-opentelemetry library.</p>

<p>Adjust the following environment variables to configure the Ditto services to produce traces:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">DITTO_TRACING_ENABLED</code>: determines whether tracing is enabled (default: <code class="language-plaintext highlighter-rouge">false</code>)</li>
  <li><code class="language-plaintext highlighter-rouge">DITTO_TRACING_SAMPLER</code>: defines the used sampler
    <ul>
      <li><code class="language-plaintext highlighter-rouge">always</code>: report all traces</li>
      <li><code class="language-plaintext highlighter-rouge">never</code>:  don’t report any trace (default)</li>
      <li><code class="language-plaintext highlighter-rouge">random</code>: randomly decide using the probability defined in the <code class="language-plaintext highlighter-rouge">DITTO_TRACING_RANDOM_SAMPLER_PROBABILITY</code> environment variable</li>
      <li><code class="language-plaintext highlighter-rouge">adaptive</code>: keeps dynamic samplers for each operation while trying to achieve a set throughput goal (<code class="language-plaintext highlighter-rouge">DITTO_TRACING_ADAPTIVE_SAMPLER_THROUGHPUT</code>)</li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">DITTO_TRACING_OTEL_TRACE_REPORTER_ENABLED</code>: whether reporting traces via the OLTP endpoint should be activated (default: <code class="language-plaintext highlighter-rouge">false</code>)</li>
  <li><code class="language-plaintext highlighter-rouge">OTEL_EXPORTER_OTLP_ENDPOINT</code>: the OTLP endpoint where to report the gathered traces (default: <code class="language-plaintext highlighter-rouge">http://localhost:4317</code>)</li>
</ul>

<h2 id="devops-commands">DevOps commands</h2>

<p>The “DevOps commands” API allows Ditto operators to make changes to a running installation without restarts.</p>

<p>The following DevOps commands are supported:</p>

<ul>
  <li>Dynamically retrieve and change log levels</li>
  <li>Dynamically retrieve service configuration</li>
  <li>Piggyback commands</li>
</ul>

<h3 id="devops-user">DevOps user</h3>

<p>Used for authenticating the following endpoints:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/devops
/api/2/connections
</code></pre></div></div>

<div class="alert alert-info" role="alert"><i class="fa fa-info-circle"></i> <b>Note:</b> The default devops credentials are username: <code class="language-plaintext highlighter-rouge">devops</code>, password: <code class="language-plaintext highlighter-rouge">foobar</code>. The password can be changed by setting the environment variable <code class="language-plaintext highlighter-rouge">DEVOPS_PASSWORD</code> in the gateway service.</div>

<h3 id="dynamically-adjust-log-levels">Dynamically adjust log levels</h3>

<p>Changing the log levels dynamically is very useful when debugging an accidental problem,
since the cause of the problem could be lost on service restart.</p>

<h4 id="retrieve-all-log-levels">Retrieve all log levels</h4>

<p>Example for retrieving all currently configured log levels:<br />
<code class="language-plaintext highlighter-rouge">GET /devops/logging</code></p>

<p>Response:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"gateway"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"10.0.0.1"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"devops.responses:retrieveLoggerConfig"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">200</span><span class="p">,</span><span class="w">
            </span><span class="nl">"serviceName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"gateway"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"instance"</span><span class="p">:</span><span class="w"> </span><span class="s2">"10.0.0.1"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"loggerConfigs"</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="w">
                </span><span class="nl">"level"</span><span class="p">:</span><span class="w"> </span><span class="s2">"info"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"logger"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ROOT"</span><span class="w">
            </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nl">"level"</span><span class="p">:</span><span class="w"> </span><span class="s2">"info"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"logger"</span><span class="p">:</span><span class="w"> </span><span class="s2">"org.eclipse.ditto"</span><span class="w">
            </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nl">"level"</span><span class="p">:</span><span class="w"> </span><span class="s2">"warn"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"logger"</span><span class="p">:</span><span class="w"> </span><span class="s2">"org.mongodb.driver"</span><span class="w">
            </span><span class="p">}]</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"things-search"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="err">...</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"policies"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="err">...</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"things"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="err">...</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"connectivity"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="err">...</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h4 id="change-a-specific-log-level-for-all-services">Change a specific log level for all services</h4>

<p>Example request payload to change the log level of logger <code class="language-plaintext highlighter-rouge">org.eclipse.ditto</code> in all services to <code class="language-plaintext highlighter-rouge">DEBUG</code>:<br />
<code class="language-plaintext highlighter-rouge">PUT /devops/logging</code></p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"logger"</span><span class="p">:</span><span class="w"> </span><span class="s2">"org.eclipse.ditto"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"level"</span><span class="p">:</span><span class="w"> </span><span class="s2">"debug"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h4 id="retrieve-log-levels-of-a-service">Retrieve log levels of a service</h4>

<p>Example response for retrieving all currently configured log levels of gateways services:<br />
<code class="language-plaintext highlighter-rouge">GET /devops/logging/gateway</code></p>

<p>Response:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"1"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"devops.responses:retrieveLoggerConfig"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">200</span><span class="p">,</span><span class="w">
        </span><span class="nl">"serviceName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"gateway"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"instance"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
        </span><span class="nl">"loggerConfigs"</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="w">
            </span><span class="nl">"level"</span><span class="p">:</span><span class="w"> </span><span class="s2">"info"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"logger"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ROOT"</span><span class="w">
        </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"level"</span><span class="p">:</span><span class="w"> </span><span class="s2">"info"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"logger"</span><span class="p">:</span><span class="w"> </span><span class="s2">"org.eclipse.ditto"</span><span class="w">
        </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"level"</span><span class="p">:</span><span class="w"> </span><span class="s2">"warn"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"logger"</span><span class="p">:</span><span class="w"> </span><span class="s2">"org.mongodb.driver"</span><span class="w">
        </span><span class="p">}]</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h4 id="change-a-specific-log-level-for-one-service">Change a specific log level for one service</h4>

<p>Example request payload to change the log level of logger <code class="language-plaintext highlighter-rouge">org.eclipse.ditto</code> in all instances of gateway-service to 
<code class="language-plaintext highlighter-rouge">DEBUG</code>:</p>

<p><code class="language-plaintext highlighter-rouge">PUT /devops/logging/gateway</code></p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"logger"</span><span class="p">:</span><span class="w"> </span><span class="s2">"org.eclipse.ditto"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"level"</span><span class="p">:</span><span class="w"> </span><span class="s2">"debug"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h3 id="dynamically-retrieve-configurations">Dynamically retrieve configurations</h3>

<p>Runtime configurations of services are available for the Ditto operator at
<code class="language-plaintext highlighter-rouge">/devops/config/</code> with optional restrictions by service name, instance ID and configuration path.
The entire runtime configuration of a service may be dozens of kilobytes big. If it exceeds the cluster message size
of 250 kB, then it can only be read piece by piece via the <code class="language-plaintext highlighter-rouge">path</code> query parameter.</p>

<h4 id="retrieve-all-service-configurations">Retrieve all service configurations</h4>

<p>Retrieve the configuration at the path <code class="language-plaintext highlighter-rouge">ditto.info</code> thus:</p>

<p><code class="language-plaintext highlighter-rouge">GET /devops/config?path=ditto.info</code></p>

<p>It is recommended to not omit the query parameter <code class="language-plaintext highlighter-rouge">path</code>. Otherwise, the full configurations of all services are
aggregated in the response, which can become megabytes big.</p>

<p>The path <code class="language-plaintext highlighter-rouge">ditto.info</code> points to information on service name, service instance index, JVM arguments and environment
variables. Response example:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"gateway"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"10.0.0.1"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"common.responses:retrieveConfig"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">200</span><span class="p">,</span><span class="w">
      </span><span class="nl">"config"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"env"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"PATH"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/usr/games:/usr/local/games"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"service"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"instance-id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"10.0.0.1"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"gateway"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"vm-args"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="s2">"-Dfile.encoding=UTF-8"</span><span class="w">
        </span><span class="p">]</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"connectivity"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"10.0.0.1"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"common.responses:retrieveConfig"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">200</span><span class="p">,</span><span class="w">
      </span><span class="nl">"config"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"env"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"CONNECTIVITY_FLUSH_PENDING_RESPONSES_TIMEOUT"</span><span class="p">:</span><span class="w"> </span><span class="s2">"3d"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"service"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"instance-id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"10.0.0.1"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"connectivity"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"vm-args"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="s2">"-Dditto.connectivity.connection.snapshot.threshold=2"</span><span class="w">
        </span><span class="p">]</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h4 id="retrieve-the-configuration-of-a-service-instance">Retrieve the configuration of a service instance</h4>

<p>Retrieving the configuration of a specific service instance is much faster
because the response is not aggregated from an unknown number of respondents
over the duration given in the query parameter <code class="language-plaintext highlighter-rouge">timeout</code>.</p>

<p>To retrieve <code class="language-plaintext highlighter-rouge">ditto</code> configuration from Gateway instance <code class="language-plaintext highlighter-rouge">1</code>:</p>

<p><code class="language-plaintext highlighter-rouge">GET /devops/config/gateway/1?path=ditto</code></p>

<p>Response example:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"common.responses:retrieveConfig"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">200</span><span class="p">,</span><span class="w">
  </span><span class="nl">"config"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"cluster"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"number-of-shards"</span><span class="p">:</span><span class="w"> </span><span class="mi">20</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"gateway"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"authentication"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"devops"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"password"</span><span class="p">:</span><span class="w"> </span><span class="s2">"foobar"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"secured"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h3 id="piggyback-commands">Piggyback commands</h3>

<p>You can use a DevOps command to send a command to another actor in the cluster.
Those special commands are called piggyback commands.<br />
A piggyback command must conform to the following schema:</p>

<script src="docson/widget.js" data-schema="../jsonschema/piggyback-command.json"></script>

<p>Piggyback commands can be sent to only one actor in the cluster or to a group of actors. <br />
To have control over this there are two headers which can be used for piggyback commands:</p>
<ul>
  <li>
    <table>
      <tbody>
        <tr>
          <td><code class="language-plaintext highlighter-rouge">"is-group-topic"</code>: <code class="language-plaintext highlighter-rouge">true</code></td>
          <td><code class="language-plaintext highlighter-rouge">false</code> - Default: <code class="language-plaintext highlighter-rouge">false</code></td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <table>
      <tbody>
        <tr>
          <td><code class="language-plaintext highlighter-rouge">"aggregate"</code>: <code class="language-plaintext highlighter-rouge">true</code></td>
          <td><code class="language-plaintext highlighter-rouge">false</code> - Default: <code class="language-plaintext highlighter-rouge">true</code></td>
        </tr>
      </tbody>
    </table>
  </li>
</ul>

<p>The <code class="language-plaintext highlighter-rouge">"is-group-topic"</code> header indicates if the piggyback command should be forwarded to only one actor or all actors of a group.
The <code class="language-plaintext highlighter-rouge">"aggregate"</code> header indicates if the responses should be aggregated or not. 
If <code class="language-plaintext highlighter-rouge">false</code> the first response is sent back and all other responses are ignored (if <code class="language-plaintext highlighter-rouge">is-group-topic</code> was <code class="language-plaintext highlighter-rouge">false</code>).</p>

<p>Additionally, the <code class="language-plaintext highlighter-rouge">"ditto-sudo"</code> header can be used in order to bypass any enforcement/authorization the service performs
when processing commands. By explicitly setting this header to <code class="language-plaintext highlighter-rouge">true</code>, you bypass enforcement.</p>

<p>Example:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"targetActorSelection"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/system/sharding/connection"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"headers"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"aggregate"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
    </span><span class="nl">"is-group-topic"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
    </span><span class="nl">"ditto-sudo"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"piggybackCommand"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"connectivity.commands:createConnection"</span><span class="p">,</span><span class="w">
      </span><span class="err">...</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h4 id="managing-policies">Managing policies</h4>

<p>Piggyback commands can be used for managing policies, e.g. in order to create, retrieve, modify, delete policies with 
“devops” (super) user.</p>

<p>All 
<a href="https://github.com/eclipse-ditto/ditto/blob/master/policies/model/src/main/java/org/eclipse/ditto/policies/model/signals/commands/PolicyCommand.java">PolicyCommand</a>s
may be sent via piggyback - however be aware that the internal JSON representation of the policy commands must be used 
and not the <a href="protocol-specification-policies.html">Ditto Protocol</a>.</p>

<p>The internal JSON representation can be found in the code, e.g. defined in the static <code class="language-plaintext highlighter-rouge">fromJson</code> methods of the commands.</p>

<p>Example piggyback for 
<a href="https://github.com/eclipse-ditto/ditto/blob/master/policies/model/src/main/java/org/eclipse/ditto/policies/model/signals/commands/modify/CreatePolicy.java">CreatePolicy</a>:</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"targetActorSelection"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/system/sharding/policy"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"headers"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"aggregate"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
    </span><span class="nl">"is-group-topic"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
    </span><span class="nl">"ditto-sudo"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"piggybackCommand"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"policies.commands:createPolicy"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"policy"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"policyId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;insert-the-policy-id-to-create-here&gt;"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"entries"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="err">...</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Example piggyback for 
<a href="https://github.com/eclipse-ditto/ditto/blob/master/policies/model/src/main/java/org/eclipse/ditto/policies/model/signals/commands/query/RetrievePolicy.java">RetrievePolicy</a>:</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"targetActorSelection"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/system/sharding/policy"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"headers"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"aggregate"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
    </span><span class="nl">"is-group-topic"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
    </span><span class="nl">"ditto-sudo"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"piggybackCommand"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"policies.commands:retrievePolicy"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"policyId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;insert-the-policy-id-to-retrieve-here&gt;"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h4 id="managing-things">Managing things</h4>

<p>Piggyback commands can be used for managing things, e.g. in order to create, retrieve, modify, delete things with
“devops” (super) user.</p>

<p>All
<a href="https://github.com/eclipse-ditto/ditto/blob/master/things/model/src/main/java/org/eclipse/ditto/things/model/signals/commands/ThingCommand.java">ThingCommand</a>s
may be sent via piggyback - however be aware that the internal JSON representation of the thing commands must be used
and not the <a href="protocol-specification-things.html">Ditto Protocol</a>.</p>

<p>The internal JSON representation can be found in the code, e.g. defined in the static <code class="language-plaintext highlighter-rouge">fromJson</code> methods of the commands.</p>

<p>Example piggyback for
<a href="https://github.com/eclipse-ditto/ditto/blob/master/things/model/src/main/java/org/eclipse/ditto/things/model/signals/commands/modify/CreateThing.java">CreateThing</a>:</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"targetActorSelection"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/system/sharding/thing"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"headers"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"aggregate"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
    </span><span class="nl">"is-group-topic"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
    </span><span class="nl">"ditto-sudo"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"piggybackCommand"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"things.commands:createThing"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"thing"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"thingId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;insert-the-thing-id-to-create-here&gt;"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"policyId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;insert-the-policy-id-to-use-here&gt;"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Example piggyback for
<a href="https://github.com/eclipse-ditto/ditto/blob/master/things/model/src/main/java/org/eclipse/ditto/things/model/signals/commands/query/RetrieveThing.java">RetrieveThing</a>:</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"targetActorSelection"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/system/sharding/thing"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"headers"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"aggregate"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
    </span><span class="nl">"is-group-topic"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
    </span><span class="nl">"ditto-sudo"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"piggybackCommand"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"things.commands:retrieveThing"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"thingId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;insert-the-thing-id-to-retrieve-here&gt;"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h4 id="managing-connections">Managing connections</h4>
<p>The recommended way to manage (CRUD) connections in Ditto is by using the <a href="connectivity-manage-connections.html">Manage connections via HTTP API</a>.</p>

<p>However, <a href="connectivity-manage-connections-piggyback.html">Manage connections via Piggyback commands</a> is still available to do this.</p>

<h4 id="managing-background-cleanup">Managing background cleanup</h4>

<p>Ditto deletes unnecessary events and snapshots in the background according to database load.</p>

<h5 id="configuration-of-background-cleanup">Configuration of background cleanup</h5>

<p>The background cleanup configuration is available for:</p>
<ul>
  <li>Policies: <a href="https://github.com/eclipse/ditto/blob/master/policies/service/src/main/resources/policies.conf">policies.conf</a></li>
  <li>Things: <a href="https://github.com/eclipse/ditto/blob/master/things/service/src/main/resources/things.conf">things.conf</a></li>
  <li>Connectivity: <a href="https://github.com/eclipse/ditto/blob/master/connectivity/service/src/main/resources/connectivity.conf">connectivity.conf</a></li>
</ul>

<p>And has the following config parameters:</p>
<div class="language-hocon highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">cleanup</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="c1"># enabled configures whether background cleanup is enabled or not</span><span class="w">
  </span><span class="c1"># If enabled, stale "snapshot" and "journal" entries will be cleaned up from the MongoDB by a background process</span><span class="w">
  </span><span class="nl">enabled</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">true</span><span class="w">
  </span><span class="nl">enabled</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="si">${?</span><span class="nv">CLEANUP_ENABLED</span><span class="si">}</span><span class="w">

  </span><span class="c1"># history-retention-duration configures the duration of how long to "keep" events and snapshots before being</span><span class="w">
  </span><span class="c1"># allowed to remove them in scope of cleanup.</span><span class="w">
  </span><span class="c1"># If this e.g. is set to 30d - then effectively an event history of 30 days would be available via the read</span><span class="w">
  </span><span class="c1"># journal.</span><span class="w">
  </span><span class="nl">history-retention-duration</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">3</span><span class="l">d</span><span class="w">
  </span><span class="nl">history-retention-duration</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="si">${?</span><span class="nv">CLEANUP_HISTORY_RETENTION_DURATION</span><span class="si">}</span><span class="w">

  </span><span class="c1"># quiet-period defines how long to stay in a state where the background cleanup is not yet started</span><span class="w">
  </span><span class="c1"># Applies after:</span><span class="w">
  </span><span class="c1"># - starting the service</span><span class="w">
  </span><span class="c1"># - each "completed" background cleanup run (all entities were cleaned up)</span><span class="w">
  </span><span class="nl">quiet-period</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">5</span><span class="l">m</span><span class="w">
  </span><span class="nl">quiet-period</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="si">${?</span><span class="nv">CLEANUP_QUIET_PERIOD</span><span class="si">}</span><span class="w">

  </span><span class="c1"># interval configures how often a "credit decision" is made.</span><span class="w">
  </span><span class="c1"># The background cleanup works with a credit system and does only generate new "cleanup credits" if the MongoDB</span><span class="w">
  </span><span class="c1"># currently has capacity to do cleanups.</span><span class="w">
  </span><span class="nl">interval</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">3</span><span class="l">s</span><span class="w">
  </span><span class="nl">interval</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="si">${?</span><span class="nv">CLEANUP_INTERVAL</span><span class="si">}</span><span class="w">

  </span><span class="c1"># timer-threshold configures the maximum database latency to give out credit for cleanup actions.</span><span class="w">
  </span><span class="c1"># If write operations to the MongoDB within the last `interval` had a `max` value greater to the configured</span><span class="w">
  </span><span class="c1"># threshold, no new cleanup credits will be issued for the next `interval`.</span><span class="w">
  </span><span class="c1"># Which throttles cleanup when MongoDB is currently under heavy (write) load.</span><span class="w">
  </span><span class="nl">timer-threshold</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">150</span><span class="l">ms</span><span class="w">
  </span><span class="nl">timer-threshold</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="si">${?</span><span class="nv">CLEANUP_TIMER_THRESHOLD</span><span class="si">}</span><span class="w">

  </span><span class="c1"># credits-per-batch configures how many "cleanup credits" should be generated per `interval` as long as the</span><span class="w">
  </span><span class="c1"># write operations to the MongoDB are less than the configured `timer-threshold`.</span><span class="w">
  </span><span class="c1"># Limits the rate of cleanup actions to this many per credit decision interval.</span><span class="w">
  </span><span class="c1"># One credit means that the "journal" and "snapshot" entries of one entity are cleaned up each `interval`.</span><span class="w">
  </span><span class="nl">credits-per-batch</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">3</span><span class="w">
  </span><span class="nl">credits-per-batch</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="si">${?</span><span class="nv">CLEANUP_CREDITS_PER_BATCH</span><span class="si">}</span><span class="w">

  </span><span class="c1"># reads-per-query configures the number of snapshots to scan per MongoDB query.</span><span class="w">
  </span><span class="c1"># Configuring this to high values will reduce the need to query MongoDB too often - it should however be aligned</span><span class="w">
  </span><span class="c1"># with the amount of "cleanup credits" issued per `interval` - in order to avoid long running queries.</span><span class="w">
  </span><span class="nl">reads-per-query</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">100</span><span class="w">
  </span><span class="nl">reads-per-query</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="si">${?</span><span class="nv">CLEANUP_READS_PER_QUERY</span><span class="si">}</span><span class="w">

  </span><span class="c1"># writes-per-credit configures the number of documents to delete for each credit.</span><span class="w">
  </span><span class="c1"># If for example one entity would have 1000 journal entries to cleanup, a `writes-per-credit` of 100 would lead</span><span class="w">
  </span><span class="c1"># to 10 delete operations performed against MongoDB.</span><span class="w">
  </span><span class="nl">writes-per-credit</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">100</span><span class="w">
  </span><span class="nl">writes-per-credit</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="si">${?</span><span class="nv">CLEANUP_WRITES_PER_CREDIT</span><span class="si">}</span><span class="w">

  </span><span class="c1"># delete-final-deleted-snapshot configures whether for a deleted entity, the final snapshot (containing the</span><span class="w">
  </span><span class="c1"># "deleted" information) should be deleted or not.</span><span class="w">
  </span><span class="c1"># If the final snapshot is not deleted, re-creating the entity will cause that the recreated entity starts with</span><span class="w">
  </span><span class="c1"># a revision number 1 higher than the previously deleted entity. If the final snapshot is deleted as well,</span><span class="w">
  </span><span class="c1"># recreation of an entity with the same ID will lead to revisionNumber=1 after its recreation.</span><span class="w">
  </span><span class="nl">delete-final-deleted-snapshot</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">false</span><span class="w">
  </span><span class="nl">delete-final-deleted-snapshot</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="si">${?</span><span class="nv">CLEANUP_DELETE_FINAL_DELETED_SNAPSHOT</span><span class="si">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>By default, background cleanup is enabled for all entities and the retention duration is configured to <code class="language-plaintext highlighter-rouge">0d</code> (0 days), 
meaning that no history will be kept for a longer time.</p>

<p>In order to use Ditto’s <a href="basic-history.html">history capabilities</a>, the configuration has to be adjusted accordingly.</p>

<h5 id="adjustment-of-background-cleanup-during-runtime">Adjustment of background cleanup during runtime</h5>

<p>Each Things, Policies and Connectivity instance has an actor coordinating a portion of the background cleanup process. 
The actor responds to piggyback-commands to query its state and configuration, modify its configuration, and restart the background cleanup
process.</p>

<p>Each command is sent to the actor selection <code class="language-plaintext highlighter-rouge">/user/&lt;SERVICE_NAME&gt;Root/persistenceCleanup</code>, where
<code class="language-plaintext highlighter-rouge">SERVICE_NAME</code> is <code class="language-plaintext highlighter-rouge">things</code>, <code class="language-plaintext highlighter-rouge">policies</code> or <code class="language-plaintext highlighter-rouge">connectivity</code>:</p>

<p><code class="language-plaintext highlighter-rouge">POST /devops/piggyback/&lt;SERVICE_NAME&gt;?timeout=10s</code></p>

<h5 id="query-background-cleanup-coordinator-state">Query background cleanup coordinator state</h5>

<p><code class="language-plaintext highlighter-rouge">POST /devops/piggyback/&lt;SERVICE_NAME&gt;?timeout=10s</code></p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"targetActorSelection"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/user/&lt;SERVICE_NAME&gt;Root/persistenceCleanup"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"headers"</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span><span class="w">
  </span><span class="nl">"piggybackCommand"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"status.commands:retrieveHealth"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>The response has the following details:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">state</code>: The current state of the actor.</li>
  <li><code class="language-plaintext highlighter-rouge">pid</code>: The last persistence ID being cleaned up. It has the form <code class="language-plaintext highlighter-rouge">&lt;entity-type&gt;:&lt;entity-id&gt;</code>.</li>
</ul>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"status.responses:retrieveHealth"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">200</span><span class="p">,</span><span class="w">
  </span><span class="nl">"statusInfo"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"UP"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"details"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="p">{</span><span class="w">
        </span><span class="nl">"INFO"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"state"</span><span class="p">:</span><span class="w"> </span><span class="s2">"RUNNING"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"pid"</span><span class="p">:</span><span class="w"> </span><span class="s2">"thing:org.eclipse.ditto:fancy-thing_53"</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h5 id="query-background-cleanup-coordinator-configuration">Query background cleanup coordinator configuration</h5>

<p><code class="language-plaintext highlighter-rouge">POST /devops/piggyback/&lt;SERVICE_NAME&gt;?timeout=10s</code></p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"targetActorSelection"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/user/&lt;SERVICE_NAME&gt;Root/persistenceCleanup"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"headers"</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span><span class="w">
  </span><span class="nl">"piggybackCommand"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"common.commands:retrieveConfig"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Response example:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"common.responses:retrieveConfig"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">200</span><span class="p">,</span><span class="w">
  </span><span class="nl">"config"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"enabled"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
    </span><span class="nl">"interval"</span><span class="p">:</span><span class="w"> </span><span class="s2">"3s"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"quiet-period"</span><span class="p">:</span><span class="w"> </span><span class="s2">"5m"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"timer-threshold"</span><span class="p">:</span><span class="w"> </span><span class="s2">"150ms"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"credits-per-batch"</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w">
    </span><span class="nl">"reads-per-query"</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w">
    </span><span class="nl">"writes-per-credit"</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w">
    </span><span class="nl">"delete-final-deleted-snapshot"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h5 id="modify-background-cleanup-coordinator-configuration">Modify background cleanup coordinator configuration</h5>

<p>Send a piggyback command of type <code class="language-plaintext highlighter-rouge">common.commands:modifyConfig</code> to change the configuration of the persistence cleanup
process. All subsequent cleanup processes will use the new configuration. The ongoing cleanup process is aborted.
Configurations absent in the payload of the piggyback command remain unchanged.
Set the special key <code class="language-plaintext highlighter-rouge">last-pid</code> to set the lower bound of PIDs to clean up in the next run.</p>

<p><code class="language-plaintext highlighter-rouge">POST /devops/piggyback/&lt;SERVICE_NAME&gt;?timeout=10s</code></p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"targetActorSelection"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/user/&lt;SERVICE_NAME&gt;Root/persistenceCleanup"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"headers"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"aggregate"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
    </span><span class="nl">"is-group-topic"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"piggybackCommand"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"common.commands:modifyConfig"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"config"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"quiet-period"</span><span class="p">:</span><span class="w"> </span><span class="s2">"240d"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"last-pid"</span><span class="p">:</span><span class="w"> </span><span class="s2">"thing:namespace:PID-lower-bound"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>The response contains the effective configuration of the background cleanup coordinator. If the configuration in the
piggyback command contains any error, then an error is logged and the actor’s configuration is unchanged.
The field <code class="language-plaintext highlighter-rouge">last-pid</code> is not a part of the configuration.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"common.responses:modifyConfig"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">200</span><span class="p">,</span><span class="w">
  </span><span class="nl">"config"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"enabled"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
    </span><span class="nl">"interval"</span><span class="p">:</span><span class="w"> </span><span class="s2">"3s"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"quiet-period"</span><span class="p">:</span><span class="w"> </span><span class="s2">"240d"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"timer-threshold"</span><span class="p">:</span><span class="w"> </span><span class="s2">"150ms"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"credits-per-batch"</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w">
    </span><span class="nl">"reads-per-query"</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w">
    </span><span class="nl">"writes-per-credit"</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w">
    </span><span class="nl">"delete-final-deleted-snapshot"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h5 id="cleanup-events-and-snapshots-of-an-entity">Cleanup events and snapshots of an entity</h5>

<p>Send a cleanup command by piggyback to the entity’s service and shard region to trigger removal of stale events and
snapshots manually. Here is an example for things. Change the service name and shard region name accordingly for
policies and connections. Typically, in a docker based environment, use <code class="language-plaintext highlighter-rouge">INSTANCE_INDEX=1</code>.</p>

<p><code class="language-plaintext highlighter-rouge">POST /devops/piggyback/things/&lt;INSTANCE_INDEX&gt;?timeout=10s</code></p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"targetActorSelection"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/system/sharding/thing"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"headers"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"aggregate"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"piggybackCommand"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"cleanup.sudo.commands:cleanupPersistence"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"entityId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ditto:thing1"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Response example:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"cleanup.sudo.responses:cleanupPersistence"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">200</span><span class="p">,</span><span class="w">
  </span><span class="nl">"entityId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"thing:ditto:thing1"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h4 id="managing-background-synchronization">Managing background synchronization</h4>

<p>A background sync actor goes over thing snapshots and search index entries slowly to ensure eventual consistency
of the search index. The actor operates in the same manner as the background cleanup coordinator and responds to
the same commands.</p>

<p><code class="language-plaintext highlighter-rouge">POST /devops/piggyback/search/&lt;INSTANCE_INDEX&gt;?timeout=10s</code></p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"targetActorSelection"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/user/thingsWildcardSearchRoot/searchUpdaterRoot/backgroundSync/singleton"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"headers"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"aggregate"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
    </span><span class="nl">"is-group-topic"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"piggybackCommand"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;COMMAND-TYPE&gt;"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">COMMAND-TYPE</code> can be:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">common.commands:shutdown</code> to shutdown or restart a background sync stream,</li>
  <li><code class="language-plaintext highlighter-rouge">common.commands:retrieveConfig</code> to retrieve the current configuration,</li>
  <li><code class="language-plaintext highlighter-rouge">common.commands:modifyConfig</code> to modify the current configuration, or</li>
  <li><code class="language-plaintext highlighter-rouge">status.commands:retrieveHealth</code> to query the current progress and event log.</li>
</ul>

<p>For each command type, please refer to the corresponding segment of “Managing background cleanup” for the exact format.</p>

<div class="alert alert-info" role="alert"><i class="fa fa-info-circle"></i> <b>Note:</b> Only a subset of the configuration has an effect when changed via <code class="language-plaintext highlighter-rouge">common.commands:modifyConfig</code> command: <code class="language-plaintext highlighter-rouge">enabled</code>, <code class="language-plaintext highlighter-rouge">quiet-period</code> and <code class="language-plaintext highlighter-rouge">keep.events</code>. Refer to <a href="installation-operating.html#ditto-configuration">Ditto configuration</a> for instructions how to modify the other configuration settings.</div>

<h4 id="force-search-index-update-of-all-things">Force search index update of all things</h4>

<p>You can trigger a search index update for all things by sending a command of type <code class="language-plaintext highlighter-rouge">common.commands:shutdown</code> with the 
<code class="language-plaintext highlighter-rouge">force-update</code> header set to <code class="language-plaintext highlighter-rouge">true</code>. The next background sync iteration  (starting after the configured quiet period)<br />
will trigger an update of the search index for all things. After the iteration of forced updates is complete 
(or interrupted), the background sync will continue its normal operation.</p>

<p><code class="language-plaintext highlighter-rouge">POST /devops/piggyback/search?timeout=10s</code></p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"targetActorSelection"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/user/thingsWildcardSearchRoot/searchUpdaterRoot/backgroundSyncProxy"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"headers"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"aggregate"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
    </span><span class="nl">"is-group-topic"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
    </span><span class="nl">"force-update"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"piggybackCommand"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"common.commands:shutdown"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>There is no response. You can check the logs of the search service to follow the sync progress.</p>

<h4 id="force-search-index-update-for-all-things-of-one-or-multiple-namespaces">Force search index update for all things of one or multiple namespaces</h4>

<p>You can trigger a search index update for things of multiple namespaces by sending a <code class="language-plaintext highlighter-rouge">common.commands:shutdown</code> command 
with the <code class="language-plaintext highlighter-rouge">force-update</code> header set to <code class="language-plaintext highlighter-rouge">true</code> and the relevant namespaces specified in the <code class="language-plaintext highlighter-rouge">namespaces</code> header. The next 
background sync iteration (starting after the configured quiet period) will trigger an update of the search index for 
the things in the specified namespaces. After the iteration of forced updates is complete (or interrupted), 
the background sync will continue its normal operation.</p>

<p><code class="language-plaintext highlighter-rouge">POST /devops/piggyback/search?timeout=10s</code></p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"targetActorSelection"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/user/thingsWildcardSearchRoot/searchUpdaterRoot/backgroundSyncProxy"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"headers"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"aggregate"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
    </span><span class="nl">"is-group-topic"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
    </span><span class="nl">"force-update"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
    </span><span class="nl">"namespaces"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"namespace1"</span><span class="p">,</span><span class="w"> </span><span class="s2">"namespace2"</span><span class="p">]</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"piggybackCommand"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"common.commands:shutdown"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>There is no response. You can check the logs of the search service to follow the sync progress.</p>

<h4 id="force-search-index-update-for-one-thing">Force search index update for one thing</h4>

<p>The search index should rarely become out-of-sync for a long time, and it can repair itself
of any inconsistencies detected at query time. Nevertheless, you can trigger search index update
for a particular thing by a DevOps-command and bring the entry up-to-date immediately.</p>

<p><code class="language-plaintext highlighter-rouge">POST /devops/piggyback/search/&lt;INSTANCE_INDEX&gt;?timeout=0</code></p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"targetActorSelection"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/user/thingsWildcardSearchRoot/searchUpdaterRoot/thingsUpdater"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"headers"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"aggregate"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
    </span><span class="nl">"is-group-topic"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"piggybackCommand"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"thing-search.sudo.commands:sudoUpdateThing"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"thingId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"&lt;THING-ID&gt;"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>There is no response. Things-search service will log a warning upon receiving this message
and continue to log warnings should the search index update fail on the persistence.</p>

<h4 id="erasing-data-within-a-namespace">Erasing data within a namespace</h4>

<p>Ditto supports erasure of <em>all</em> data within a namespace during live operations.
To do so safely, perform the following steps in sequence.</p>

<ol>
  <li><a href="#block-all-messages-to-a-namespace">Block all messages to the namespace</a>
so that actors will not spawn in the namespace.</li>
  <li><a href="#shutdown-all-actors-in-a-namespace">Shutdown all actors in the namespace</a>
so that no actor will generate data in the namespace.</li>
  <li><a href="#erase-all-data-in-a-namespace-from-the-persistence">Erase data from the persistence</a>.</li>
  <li><a href="#unblock-messages-to-a-namespace">Unblock messages to the namespace</a>
so that the old namespace could be reused at a later point in time.</li>
</ol>

<h5 id="block-all-messages-to-a-namespace">Block all messages to a namespace</h5>

<p>Send a piggyback command to <a href="https://pekko.apache.org/docs/pekko/current/distributed-pub-sub.html">Pekko’s pub-sub-mediator</a> with type <code class="language-plaintext highlighter-rouge">namespaces.commands:blockNamespace</code>
to block all messages sent to actors belonging to a namespace.</p>

<p><code class="language-plaintext highlighter-rouge">PUT /devops/piggyback?timeout=10s</code></p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"targetActorSelection"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/system/distributedPubSubMediator"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"headers"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"aggregate"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"piggybackCommand"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"namespaces.commands:blockNamespace"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"namespace"</span><span class="p">:</span><span class="w"> </span><span class="s2">"namespaceToBlock"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Once a namespace is blocked on all members of the Ditto cluster, you will get a response
similar to the one below. The namespace will remain blocked for the lifetime of the Ditto cluster,
or until you proceed with <a href="#unblock-messages-to-a-namespace">step 4</a>, which unblocks it.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"namespaces.responses:blockNamespace"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">200</span><span class="p">,</span><span class="w">
  </span><span class="nl">"namespace"</span><span class="p">:</span><span class="w"> </span><span class="s2">"namespaceToBlock"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"resourceType"</span><span class="p">:</span><span class="w"> </span><span class="s2">"namespaces"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h5 id="shutdown-all-actors-in-a-namespace">Shutdown all actors in a namespace</h5>

<p>Send a piggyback command to <a href="https://pekko.apache.org/docs/pekko/current/distributed-pub-sub.html">Pekko’s pub-sub-mediator</a> with type <code class="language-plaintext highlighter-rouge">common.commands:shutdown</code>
to request all actors in a namespace to shut down. The value of <code class="language-plaintext highlighter-rouge">piggybackCommand/reason/type</code> must be
<code class="language-plaintext highlighter-rouge">purge-namespace</code>; otherwise, the namespace’s actors will not stop themselves.</p>

<p><code class="language-plaintext highlighter-rouge">PUT /devops/piggyback?timeout=0</code></p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"targetActorSelection"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/system/distributedPubSubMediator"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"piggybackCommand"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"common.commands:shutdown"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"reason"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"purge-namespace"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"details"</span><span class="p">:</span><span class="w"> </span><span class="s2">"namespaceToShutdown"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>The shutdown command has no response because the number of actors shutting down can be very large.
The response will always be <code class="language-plaintext highlighter-rouge">408</code> timeout.
Feel free to send the shutdown command several times to make sure.</p>

<h5 id="erase-all-data-in-a-namespace-from-the-persistence">Erase all data in a namespace from the persistence</h5>

<p>Send a piggyback command to <a href="https://pekko.apache.org/docs/pekko/current/distributed-pub-sub.html">Pekko’s pub-sub-mediator</a> with type <code class="language-plaintext highlighter-rouge">namespaces.commands:purgeNamespace</code>
to erase all data from the persistence.
It is better to purge a namespace after
<a href="#block-all-messages-to-a-namespace">blocking</a> it and
<a href="#shutdown-all-actors-in-a-namespace">shutting down</a>
all its actors so that no data is written in the namespace while erasing is ongoing.</p>

<p>The erasure may take a long time if the namespace has a lot of data associated with it or if the persistent storage is
slow. Set the timeout to a safe margin above the estimated erasure time in milliseconds.</p>

<p><code class="language-plaintext highlighter-rouge">PUT /devops/piggyback?timeout=10s</code></p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"targetActorSelection"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/system/distributedPubSubMediator"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"headers"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"aggregate"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
    </span><span class="nl">"is-group-topic"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"piggybackCommand"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"namespaces.commands:purgeNamespace"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"namespace"</span><span class="p">:</span><span class="w"> </span><span class="s2">"namespaceToPurge"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>The response contains results of the data purge, one for each resource type.
Note that to see responses from multiple resource types, the header <code class="language-plaintext highlighter-rouge">aggregate</code> must not be <code class="language-plaintext highlighter-rouge">false</code>.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"?"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"?"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"namespaces.responses:purgeNamespace"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">200</span><span class="p">,</span><span class="w">
      </span><span class="nl">"namespace"</span><span class="p">:</span><span class="w"> </span><span class="s2">"namespaceToPurge"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"resourceType"</span><span class="p">:</span><span class="w"> </span><span class="s2">"thing"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"successful"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"?1"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"namespaces.responses:purgeNamespace"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">200</span><span class="p">,</span><span class="w">
      </span><span class="nl">"namespace"</span><span class="p">:</span><span class="w"> </span><span class="s2">"namespaceToPurge"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"resourceType"</span><span class="p">:</span><span class="w"> </span><span class="s2">"policy"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"successful"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"?2"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"namespaces.responses:purgeNamespace"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">200</span><span class="p">,</span><span class="w">
      </span><span class="nl">"namespace"</span><span class="p">:</span><span class="w"> </span><span class="s2">"namespaceToPurge"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"resourceType"</span><span class="p">:</span><span class="w"> </span><span class="s2">"thing-search"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"successful"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h5 id="unblock-messages-to-a-namespace">Unblock messages to a namespace</h5>

<p>Send a piggyback command to <a href="https://pekko.apache.org/docs/pekko/current/distributed-pub-sub.html">Pekko’s pub-sub-mediator</a> with type <code class="language-plaintext highlighter-rouge">namespaces.commands:unblockNamespace</code>
to stop blocking messages to a namespace.</p>

<p><code class="language-plaintext highlighter-rouge">PUT /devops/piggyback?timeout=10s</code></p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"targetActorSelection"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/system/distributedPubSubMediator"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"headers"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"aggregate"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"piggybackCommand"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"namespaces.commands:unblockNamespace"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"namespace"</span><span class="p">:</span><span class="w"> </span><span class="s2">"namespaceToUnblock"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>A response will come once the namespace’s blockade is released on all members of the Ditto cluster.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"namespaces.responses:unblockNamespace"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="mi">200</span><span class="p">,</span><span class="w">
  </span><span class="nl">"namespace"</span><span class="p">:</span><span class="w"> </span><span class="s2">"namespaceToUnblock"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"resourceType"</span><span class="p">:</span><span class="w"> </span><span class="s2">"namespaces"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>


    <div class="tags">
        
        <b>Tags: </b>
        
        
        
        <a href="tag_installation.html" class="btn btn-default navbar-btn cursorNorm" role="button">installation</a>
        
        
        
    </div>

</div>

<hr class="shaded"/>

<footer>
            <div class="row">
                <div class="col-lg-12 footer">
                    <div class="logo">
                        <a href="https://eclipse.org"><img src="images/eclipse_foundation_logo.svg" alt="Eclipse logo"/></a>
                    </div>
                    <p class="notice">
                        &copy;2025 Eclipse Ditto™.
                         Site last generated: Mar 31, 2025 <br />
                    </p>
                    <div class="quickLinks">
                        <a href="https://www.eclipse.org/legal/privacy.php" target="_blank">
                            &gt; Privacy Policy
                        </a>
                        <a href="https://www.eclipse.org/legal/termsofuse.php" target="_blank">
                            &gt; Terms of Use
                        </a>
                        <a href="https://www.eclipse.org/legal/copyright.php" target="_blank">
                            &gt; Copyright Agent
                        </a>
                        <a href="https://www.eclipse.org/legal" target="_blank">
                            &gt; Legal
                        </a>
                        <a href="https://www.eclipse.org/legal/epl-2.0/" target="_blank">
                            &gt; License
                        </a>
                        <a href="https://eclipse.org/security" target="_blank">
                            &gt; Report a Vulnerability
                        </a>
                    </div>
                </div>
            </div>
</footer>


        </div>
    <!-- /.row -->
</div>
<!-- /.container -->
</div>
<!-- /#main -->
    </div>

</body>
</html>
